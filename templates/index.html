<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>360Â° íŒŒë…¸ë¼ë§ˆ ë§µë·°ì–´</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marzipano/0.10.2/marzipano.min.js"></script>
  <!-- Leaflet JS & CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- âœ… ì¹´ì¹´ì˜¤ë§µ: autoload=false + defer (ë™ê¸° ì°¨ë‹¨ ì œê±°) -->
  <!-- ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš© -->
  <!-- <script id="kakao-sdk" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f7459c835e6e38faba20a35d17188448&autoload=false" defer></script> -->

  <style>
    body, html { margin:0; padding:0; height:100%; background:#000; user-select:none; -webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; }
    #menuBar { position:fixed; top:0; left:0; right:0; height:38px;
      background:#232323; color:#fff; z-index:3000; display:flex; align-items:center;
      font-size:1em; font-weight:700; font-family:'Nanum Gothic',sans-serif;
    }
    /* ë©”ë‰´ë°”ê°€ ìˆ¨ê²¨ì§ˆ ë•Œ ë·°ì–´ ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ì¡°ì • */
    body.hide-menu #viewerContainer { top: 0 !important; }
    #menuBar > .menu-item {
      margin:0 15px; cursor:pointer; padding:7px 8px; border-radius:4px;
      color:#fff; user-select:none; transition: background 0.12s;
    }
    #menuBar > .menu-item:hover { background:#484848; }
    .dropdown-menu {
      display:none; position:absolute; top:38px; left:15px; background:#fff;
      min-width:150px; box-shadow:0 2px 12px #0003; border-radius:0 0 8px 8px;
      z-index:3001; font-size:1em; color:#222; padding:5px 0;
    }
    .dropdown-menu.active { display:block; }
    .dropdown-menu .dropdown-item {
      padding:9px 16px; cursor:pointer; white-space:nowrap;
      transition: background 0.13s; user-select:none;
    }
    .dropdown-menu .dropdown-item:hover { background:#ffeb9c; }
    .dropdown-menu label {
      display:flex; align-items:center; gap:7px; font-weight:600; color:#3d3d3d;
    }
    .dropdown-menu input[type="number"] {
      width:65px; font-size:1em; border:1px solid #bbb; border-radius:4px; padding:2px 6px;
      margin-left:7px; user-select:text; -webkit-user-select:text; -moz-user-select:text; -ms-user-select:text;
    }
    input, textarea, select {
      user-select:text !important; -webkit-user-select:text !important; -moz-user-select:text !important; -ms-user-select:text !important;
    }
    #miniMap { position:fixed; bottom:10px; left:10px; width:300px; height:300px;
      border:2px solid #000; border-radius:6px; z-index:6000; background:#fff; }
    #viewerContainer { 
      width:100vw; height:100vh; background:#000; position:relative;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
    }
    .nav-arrow { user-select: none; transition: background 0.1s; pointer-events: auto; }
    .nav-arrow img { pointer-events: none; user-select: none; width: 36px; height: 36px; display: block; }
    
    /* CSS í™”ì‚´í‘œ ëŒ€ì•ˆ (ì´ë¯¸ì§€ ë¡œë”© ë¬¸ì œ í•´ê²°) */
    .nav-arrow-css {
      position: relative;
      width: 36px;
      height: 36px;
    }
    .nav-arrow-css::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 20px solid #fff;
      transform: translate(-50%, -50%);
    }
    .topbar-spacer { flex:1; }
    .custom-marker { width: 16px; height: 16px; pointer-events: auto; }

    /* ì§€ë„ ì„ íƒ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì œê±°ë¨ */
    
    /* ë‚ ì§œ í‘œì‹œ ì˜ì—­ */
    #locationInfo {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-family: 'Nanum Gothic', sans-serif;
      font-size: 14px;
      z-index: 2000;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      width: fit-content;
      display: inline-block;
    }
    
    /* ë©”ë‰´ë°”ê°€ ìˆì„ ë•Œ ë‚ ì§œ ë°•ìŠ¤ ìœ„ì¹˜ ì¡°ì • */
    body:not(.hide-menu) #locationInfo {
      top: 60px; /* ë©”ë‰´ë°” ë†’ì´(38px) + ì—¬ë°±(22px) */
    }
    
    /* í™•ëŒ€/ì¶•ì†Œ ë²„íŠ¼ ê¸°ë³¸ ìœ„ì¹˜ (ë©”ë‰´ë°”ê°€ ì—†ì„ ë•Œ) */
    #zoomControls {
      top: 60px; /* ê¸°ë³¸ ìœ„ì¹˜ */
    }
    
    /* ë©”ë‰´ë°”ê°€ ìˆì„ ë•Œ í™•ëŒ€/ì¶•ì†Œ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
    body:not(.hide-menu) #zoomControls {
      top: 60px; /* ë©”ë‰´ë°” ë†’ì´(38px) + ì—¬ë°±(22px) */
    }
    
    #locationInfo .date-text {
      font-size: 14px;
      opacity: 0.9;
      text-align: left;
      white-space: nowrap;
    }
    
    /* ì²´í¬ ì•„ì´ì½˜ ì™„ì „íˆ ìˆ¨ê¸°ê¸° */
    #locationInfo .date-text svg,
    #locationInfo .date-icon,
    #locationInfo .date-dropdown,
    #locationInfo .date-text svg[viewBox="0 0 24 24"],
    #locationInfo .date-text svg path[d*="M12 2C6.48"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      width: 0 !important;
      height: 0 !important;
    }
  </style>
</head>
<body{% if hide_menu %} class="hide-menu"{% endif %}>
  <script id="targetNodeInfo" type="application/json">{% if target_point %}{{ {
    'track_seg_point_id': track_seg_point_id,
    'target_index': target_index,
    'target_point': target_point
  } | tojson }}{% else %}null{% endif %}</script>
  {% if not hide_menu %}
  <div id="menuBar">
    <div class="menu-item" id="menuFileBtn">íŒŒì¼</div>
    <div class="menu-item" id="menuOptionBtn">ì˜µì…˜</div>
    <div class="topbar-spacer"></div>
  </div>
  {% endif %}

  {% if not hide_menu %}
  <!-- íŒŒì¼ ë©”ë‰´ -->
  <div class="dropdown-menu" id="menuFileMenu">
    <div class="dropdown-item" id="loadDatasetBtn">ë°ì´í„°ì…‹ ë¡œë“œ</div>
    <div class="dropdown-item" id="setDataPathBtn">ë°ì´í„° ê²½ë¡œ ì§€ì •</div>
  </div>

  <!-- ì˜µì…˜ ë©”ë‰´ -->
  <div class="dropdown-menu" id="menuOptionMenu">
    <div class="dropdown-item">
      <label>
        North Offset (Â°)
        <input id="northOffsetInput" type="number" min="0" max="360" step="0.1" value="0">
        <button id="saveNorthOffsetBtn" style="margin-left:8px; padding:4px 8px; background:#4caf50; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em;">ì €ì¥</button>
      </label>
      <span style="display:block;font-size:0.91em;color:#666;margin-left:3px;">íŒŒë…¸ë¼ë§ˆ ì´ë¯¸ì§€ ê°ë„ ë³´ì •</span>
    </div>
    <div class="dropdown-item" id="editPerImageOffsetsBtn">ê°œë³„ ì´ë¯¸ì§€ ì˜¤í”„ì…‹ í¸ì§‘</div>
    <div class="dropdown-item" id="clearOffsetsBtn" style="color: #000000;">ëª¨ë“  ì˜¤í”„ì…‹ ì´ˆê¸°í™”</div>
    <div class="dropdown-item" id="showNodeUrlsBtn" style="color: #000000;">ë…¸ë“œ URL ëª©ë¡ ë³´ê¸°</div>
  </div>
  {% endif %}


  <!-- ë…¸ë“œ URL ëª©ë¡ ëª¨ë‹¬ -->
  <div id="nodeUrlsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:8px; padding:20px; max-width:800px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin:0 0 15px 0; color:#333; font-family:'Nanum Gothic',sans-serif;">ê° ë…¸ë“œì˜ ê°œë³„ URL</h3>
      <div id="nodeUrlsContent" style="max-height:60vh; overflow-y:auto;">
        <!-- ë…¸ë“œ URL ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
      <div style="margin-top:15px; text-align:right;">
        <button id="closeNodeUrlsModal" style="padding:8px 16px; background:#666; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- í´ë” ì„¤ì • ëª¨ë‹¬ -->
  <div id="folderSettingsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:8px; padding:20px; max-width:600px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin:0 0 15px 0; color:#333;">ë°ì´í„° ê²½ë¡œ ì§€ì •</h3>
      <div style="margin-bottom:15px; font-size:0.9em; color:#666;">ë°ì´í„° íŒŒì¼ë“¤ì´ ìœ„ì¹˜í•œ í´ë” ê²½ë¡œë¥¼ ì„¤ì •í•˜ì„¸ìš”. ì„¤ì • í›„ ë°ì´í„°ì…‹ ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">ğŸ“ ì´ë¯¸ì§€ í´ë”</label>
        <div style="display:flex; gap:8px;">
          <input id="imgFolderInput" type="text" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:0.9em;" placeholder="ì˜ˆ: C:/Users/ì‚¬ìš©ì/Documents/panoview/static/img">
          <button id="browseImgFolderBtn" style="padding:8px 12px; background:#2196f3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em; white-space:nowrap;">ğŸ“ íƒìƒ‰</button>
        </div>
        <div style="font-size:0.8em; color:#666; margin-top:2px;">íŒŒë…¸ë¼ë§ˆ ì´ë¯¸ì§€ë“¤ì´ ì €ì¥ëœ í´ë”</div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">ğŸ—ºï¸ Track Shapefile í´ë”</label>
        <div style="display:flex; gap:8px;">
          <input id="trackFolderInput" type="text" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:0.9em;" placeholder="ì˜ˆ: C:/Users/ì‚¬ìš©ì/Documents/panoview/static/track">
          <button id="browseTrackFolderBtn" style="padding:8px 12px; background:#2196f3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em; white-space:nowrap;">ğŸ“ íƒìƒ‰</button>
        </div>
        <div style="font-size:0.8em; color:#666; margin-top:2px;">Track ë¼ì¸ í˜•íƒœì˜ Shapefile (.shp) íŒŒì¼ë“¤ì´ ì €ì¥ëœ í´ë”</div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">ğŸ“ Waypoint Shapefile í´ë”</label>
        <div style="display:flex; gap:8px;">
          <input id="pointFolderInput" type="text" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:0.9em;" placeholder="ì˜ˆ: C:/Users/ì‚¬ìš©ì/Documents/panoview/static/point">
          <button id="browsePointFolderBtn" style="padding:8px 12px; background:#2196f3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em; white-space:nowrap;">ğŸ“ íƒìƒ‰</button>
        </div>
        <div style="font-size:0.8em; color:#666; margin-top:2px;">Waypoint í¬ì¸íŠ¸ í˜•íƒœì˜ Shapefile (.shp) íŒŒì¼ë“¤ì´ ì €ì¥ëœ í´ë”</div>
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">ğŸ“Š Match CSV í´ë”</label>
        <div style="display:flex; gap:8px;">
          <input id="matchFolderInput" type="text" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:0.9em;" placeholder="ì˜ˆ: C:/Users/ì‚¬ìš©ì/Documents/panoview/static/match">
          <button id="browseMatchFolderBtn" style="padding:8px 12px; background:#2196f3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em; white-space:nowrap;">ğŸ“ íƒìƒ‰</button>
        </div>
        <div style="font-size:0.8em; color:#666; margin-top:2px;">ë§¤ì¹­ ì •ë³´ê°€ ë‹´ê¸´ CSV íŒŒì¼ë“¤ì´ ì €ì¥ëœ í´ë”</div>
      </div>

      <div style="margin-bottom:20px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">ğŸ§© Tile ì´ë¯¸ì§€ í´ë”</label>
        <div style="display:flex; gap:8px;">
          <input id="tileFolderInput" type="text" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:0.9em;" placeholder="ì˜ˆ: C:/Users/ì‚¬ìš©ì/Documents/panoview/static/tileimg">
          <button id="browseTileFolderBtn" style="padding:8px 12px; background:#2196f3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em; white-space:nowrap;">ğŸ“ íƒìƒ‰</button>
        </div>
        <div style="font-size:0.8em; color:#666; margin-top:2px;">ìƒì„±ëœ íƒ€ì¼ ì´ë¯¸ì§€ê°€ ì €ì¥ë  í´ë”</div>
      </div>
      
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="saveFolderSettingsBtn" style="padding:8px 16px; background:#4caf50; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì €ì¥</button>
        <button id="cancelFolderSettingsBtn" style="padding:8px 16px; background:#f44336; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- Per-Image Offset Editor Modal -->
  <div id="offsetEditorModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:8px; padding:20px; max-width:600px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin:0 0 15px 0; color:#333;">ê°œë³„ ì´ë¯¸ì§€ ì˜¤í”„ì…‹ í¸ì§‘</h3>
      <div style="margin-bottom:15px; font-size:0.9em; color:#666;">
        ê° ì´ë¯¸ì§€ë³„ë¡œ ì¶”ê°€ ë³´ì •ê°’ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì „ì—­ North Offsetê³¼ í•¨ê»˜ ì ìš©ë©ë‹ˆë‹¤.
      </div>
      <div style="display:flex; align-items:center; gap:12px; margin:10px 0 14px 0;">
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; color:#444;">
          <input id="selectAllOffsets" type="checkbox">
          ëª¨ë‘ ì„ íƒ
        </label>
        <div style="flex:1"></div>
        <label style="display:flex; align-items:center; gap:6px; color:#444;">
          ì¼ê´„ ì˜¤í”„ì…‹(Â°)
          <input id="bulkOffsetInput" type="number" min="0" max="360" step="0.1" style="width:100px; padding:4px; border:1px solid #ccc; border-radius:4px;">
        </label>
        <button id="applyBulkOffsetBtn" style="padding:6px 12px; background:#455a64; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì„ íƒì— ì ìš©</button>
      </div>
      <div id="offsetEditorContent" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; border-radius:4px; padding:10px;"></div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px; align-items:center;">
        <button id="showImageNumbersBtn" style="margin-right:auto; padding:8px 12px; background:#607d8b; color:#fff; border:none; border-radius:4px; cursor:pointer;">
          ë¯¸ë‹ˆë§µì—ì„œ ì´ë¯¸ì§€ ë²ˆí˜¸ í™•ì¸
        </button>
        <button id="saveOffsetsBtn" style="padding:8px 16px; background:#4caf50; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì €ì¥</button>
        <button id="cancelOffsetsBtn" style="padding:8px 16px; background:#f44336; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- Dataset Selection Modal (ë‹¤ì¤‘ ì„ íƒ) -->
  <div id="datasetSelectionModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:8px; padding:20px; max-width:500px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin:0 0 15px 0; color:#333;">ë°ì´í„°ì…‹ ì„ íƒ</h3>
      <div style="margin-bottom:15px; font-size:0.9em; color:#666;">ì—¬ëŸ¬ ê°œë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      <div id="datasetList" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:4px; padding:10px;"></div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
        <button id="loadSelectedDatasetBtn" style="padding:8px 16px; background:#4caf50; color:#fff; border:none; border-radius:4px; cursor:pointer;">ë¡œë“œ</button>
        <button id="cancelDatasetBtn" style="padding:8px 16px; background:#f44336; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- ê²½ë¡œ íƒ€ì… ì„ íƒ ëª¨ë‹¬ -->
  <div id="pathTypeSelectionModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:8px; padding:20px; max-width:800px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin:0 0 15px 0; color:#333;">ë°ì´í„° ê²½ë¡œ ì§€ì •</h3>
      <div style="margin-bottom:15px; font-size:0.9em; color:#666;">ì„¤ì •í•  ê²½ë¡œ íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”.</div>
      
      <div style="display:flex; flex-direction:column; gap:10px;">
        <button id="selectGpxPathBtn" style="padding:12px 16px; background:#f8f9fa; border:2px solid #e9ecef; border-radius:6px; cursor:pointer; text-align:left; font-size:1em; transition:all 0.2s;" onmouseover="this.style.background='#e3f2fd'; this.style.borderColor='#2196f3';" onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#e9ecef';">
          <div style="font-weight:600; color:#333;">ğŸ—ºï¸ GPX ê²½ë¡œ</div>
          <div style="font-size:0.8em; color:#666; margin-top:2px;">GPX íŒŒì¼ë“¤ì´ ì €ì¥ëœ í´ë”</div>
        </button>
        
        <button id="selectImgPathBtn" style="padding:12px 16px; background:#f8f9fa; border:2px solid #e9ecef; border-radius:6px; cursor:pointer; text-align:left; font-size:1em; transition:all 0.2s;" onmouseover="this.style.background='#e8f5e8'; this.style.borderColor='#4caf50';" onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#e9ecef';">
          <div style="font-weight:600; color:#333;">ğŸ“ IMG ê²½ë¡œ</div>
          <div style="font-size:0.8em; color:#666; margin-top:2px;">íŒŒë…¸ë¼ë§ˆ ì´ë¯¸ì§€ë“¤ì´ ì €ì¥ëœ í´ë”</div>
        </button>
        
        <button id="selectCsvPathBtn" style="padding:12px 16px; background:#f8f9fa; border:2px solid #e9ecef; border-radius:6px; cursor:pointer; text-align:left; font-size:1em; transition:all 0.2s;" onmouseover="this.style.background='#fff3e0'; this.style.borderColor='#ff9800';" onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#e9ecef';">
          <div style="font-weight:600; color:#333;">ğŸ“Š CSV ê²½ë¡œ</div>
          <div style="font-size:0.8em; color:#666; margin-top:2px;">ë§¤ì¹­ í…Œì´ë¸” CSV íŒŒì¼ë“¤ì´ ì €ì¥ëœ í´ë”</div>
        </button>
      </div>
      
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
        <button id="cancelPathTypeBtn" style="padding:8px 16px; background:#f44336; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- ê°œë³„ í´ë” ê²½ë¡œ ì„¤ì • ëª¨ë‹¬ -->
  <div id="individualPathModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:8px; padding:20px; max-width:500px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <h3 id="individualPathTitle" style="margin:0 0 15px 0; color:#333;">í´ë” ê²½ë¡œ ì§€ì •</h3>
      <div id="individualPathDescription" style="margin-bottom:15px; font-size:0.9em; color:#666;">í´ë” ê²½ë¡œë¥¼ ì„¤ì •í•˜ì„¸ìš”.</div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">í˜„ì¬ ê²½ë¡œ</label>
        <div id="currentPathDisplay" style="padding:8px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px; font-family:monospace; font-size:0.9em; word-break:break-all;"></div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">ìƒˆ ê²½ë¡œ</label>
        <div style="display:flex; gap:8px;">
          <input id="individualPathInput" type="text" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:0.9em;" placeholder="ì˜ˆ: static/gpx">
          <button id="browsePathBtn" style="padding:8px 12px; background:#2196f3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em; white-space:nowrap;">ğŸ“ íƒìƒ‰</button>
        </div>
        <div id="individualPathHelp" style="font-size:0.8em; color:#666; margin-top:2px;">í´ë” ê²½ë¡œë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ íƒìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
      </div>
      
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="saveIndividualPathBtn" style="padding:8px 16px; background:#4caf50; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì €ì¥</button>
        <button id="cancelIndividualPathBtn" style="padding:8px 16px; background:#f44336; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- ê²½ë¡œ ì…ë ¥ ë„ìš°ë¯¸ ëª¨ë‹¬ -->
  <div id="pathHelperModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:6000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:8px; padding:20px; max-width:700px; max-height:80vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <h3 id="pathHelperTitle" style="margin:0 0 15px 0; color:#333;">ğŸ“ í´ë” ê²½ë¡œ ì…ë ¥ ë„ìš°ë¯¸</h3>
      <div style="margin-bottom:15px; font-size:0.9em; color:#666;">í´ë” ê²½ë¡œë¥¼ ì‰½ê²Œ ì…ë ¥í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ë“œë¦½ë‹ˆë‹¤.</div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">í˜„ì¬ ê²½ë¡œ</label>
        <div id="pathHelperCurrentPath" style="padding:8px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px; font-family:monospace; font-size:0.9em; word-break:break-all;"></div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">ê²½ë¡œ ì…ë ¥ ë°©ë²•</label>
        <div id="pathExamples" style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px; padding:12px; font-size:0.9em;"></div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">ìƒëŒ€ ê²½ë¡œ ì…ë ¥ (ê¶Œì¥)</label>
        <div style="display:flex; gap:8px;">
          <input id="pathHelperInput" type="text" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:0.9em;" placeholder="ì˜ˆ: static/gpx, data/images">
          <button id="openFileDialogBtn" style="padding:8px 12px; background:#17a2b8; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em; white-space:nowrap;">ğŸ“‚ í´ë” ì„ íƒ</button>
        </div>
        <div style="font-size:0.8em; color:#666; margin-top:2px;">í”„ë¡œì íŠ¸ í´ë” ê¸°ì¤€ ìƒëŒ€ ê²½ë¡œ</div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">ì ˆëŒ€ ê²½ë¡œ ì…ë ¥</label>
        <div style="display:flex; gap:8px;">
          <input id="absolutePathInput" type="text" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:0.9em;" placeholder="ì˜ˆ: C:/Users/ì‚¬ìš©ì/Documents/data/gpx">
          <button id="copyFromRelativeBtn" style="padding:8px 12px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em; white-space:nowrap;">ë³µì‚¬</button>
        </div>
        <div style="font-size:0.8em; color:#666; margin-top:2px;">ì‹œìŠ¤í…œ ì „ì²´ ê²½ë¡œ (Windows: C:\\, Mac/Linux: /)</div>
      </div>
      
      <div style="margin-bottom:15px; padding:10px; background:#fff3cd; border:1px solid #ffeaa7; border-radius:4px;">
        <strong>ğŸ’¡ ì‚¬ìš© íŒ:</strong><br>
        â€¢ <strong>ìƒëŒ€ ê²½ë¡œ</strong>: í”„ë¡œì íŠ¸ í´ë” ê¸°ì¤€ìœ¼ë¡œ ì…ë ¥ (static/gpx)<br>
        â€¢ <strong>ì ˆëŒ€ ê²½ë¡œ</strong>: ì‹œìŠ¤í…œ ì „ì²´ ê²½ë¡œ ì…ë ¥ (C:/Users/ì‚¬ìš©ì/Documents/data)<br>
        â€¢ í´ë” ì„ íƒ í›„ ë³µì‚¬ ë²„íŠ¼ìœ¼ë¡œ ìƒëŒ€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜ ê°€ëŠ¥
      </div>
      
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button id="applyPathHelperBtn" style="padding:8px 16px; background:#4caf50; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì ìš©</button>
        <button id="cancelPathHelperBtn" style="padding:8px 16px; background:#f44336; color:#fff; border:none; border-radius:4px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <div id="miniMap"></div>

  <!-- ì§€ë„ ì„ íƒ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì œê±°ë¨ -->

  <!-- Zoom controls for Marzipano viewer -->
  <div id="zoomControls" style="position: absolute; right: 20px; z-index: 1000;">
    <button id="zoomInBtn" style="background: #333; color: white; border: none; border-radius: 4px; width: 35px; height: 35px; font-size: 18px; cursor: pointer; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); display: block;">+</button>
    <button id="zoomOutBtn" style="background: #333; color: white; border: none; border-radius: 4px; width: 35px; height: 35px; font-size: 18px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); display: block;">-</button>
  </div>

  <div id="viewerContainer">
    <!-- ë‚ ì§œ í‘œì‹œ -->
    <div id="locationInfo" style="display: none;">
      <div class="date-text">
        <span id="dateText">ë‚ ì§œ ì •ë³´ ë¡œë”© ì¤‘...</span>
      </div>
    </div>
  </div>

<script>
// /pano/<id>ë¡œ ë Œë”ë  ë•Œ ì„œë²„ì—ì„œ ì£¼ì…ë¨
window.initialTargetNodeId = {{ (initialTargetNodeId or track_seg_point_id or "") | tojson }};

// ==============================
// Viewport fetch (bbox) helpers
// ==============================
let mapFetchTimer = null;
let mapFetchAbort = null;
let lastFetchKey = "";
let pointsLayer = null; // Leaflet LayerGroup

function ensurePointsLayer() {
  if (!pointsLayer) {
    pointsLayer = L.layerGroup().addTo(miniMap);
  }
}

function clearPointsLayer() {
  if (pointsLayer) pointsLayer.clearLayers();
}

function scheduleFetchByMap(delayMs = 250) {
  if (mapFetchTimer) clearTimeout(mapFetchTimer);
  mapFetchTimer = setTimeout(fetchByMapViewport, delayMs);
}

async function fetchByMapViewport() {
  if (!miniMap) return;

  const b = miniMap.getBounds();
  const z = miniMap.getZoom();

  // âœ… ì„œë²„ê°€ ê¸°ëŒ€í•˜ëŠ” ìˆœì„œ: west,south,east,north
  const bbox = [
    b.getWest(),
    b.getSouth(),
    b.getEast(),
    b.getNorth()
  ].join(",");

  // ë™ì¼ ë·°ë©´ í˜¸ì¶œ ìŠ¤í‚µ (ì˜µì…˜)
  const key = z + "|" + bbox.split(",").map(v => Number(v).toFixed(6)).join(",");
  if (key === lastFetchKey) return;
  lastFetchKey = key;

  // ì´ì „ ìš”ì²­ ì·¨ì†Œ
  if (mapFetchAbort) mapFetchAbort.abort();
  mapFetchAbort = new AbortController();

  const limit = z >= 16 ? 8000 : z >= 14 ? 5000 : 2000; // ì¤Œì— ë”°ë¥¸ ìƒ˜í”Œë§(ì„ íƒ)

  try {
    const url = `/api/points?bbox=${encodeURIComponent(bbox)}&limit=${limit}`;
    const res = await fetch(url, { signal: mapFetchAbort.signal });
    const data = await res.json();

    // ì´ˆê¸° points ë¯¸ì£¼ì… ìƒíƒœì—ì„œëŠ” í˜„ì¬ viewport ë°ì´í„°ë¡œ 1íšŒ ë¶€íŠ¸ìŠ¤íŠ¸ë©
    if ((!Array.isArray(points) || points.length === 0) && Array.isArray(data) && data.length > 0) {
      points = data;
      triggerTrackLineLoadFromPoints();
      const firstImageIndex = points.findIndex(p => p && p.image && String(p.image).trim() !== '');
      if (firstImageIndex >= 0) {
        showImage(firstImageIndex);
      }
    }

    // ë Œë”ë§
    renderFetchedPoints(data);

    // âœ… ìµœì´ˆ 1íšŒ: initialTargetNodeIdê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë…¸ë“œë¡œ ì´ë™/ê°•ì¡°
    if (!didJumpToInitialTarget) {
      const initId = getInitialTargetNodeId(); // ë„ˆì—ê²Œ ì¤€ í—¬í¼
      if (initId) {
        didJumpToInitialTarget = true;
        // ë„¤ ê¸°ì¡´ í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ í˜¸ì¶œ
        // (ì˜ˆ: gotoNodeByInfo({ track_seg_point_id: initId }))
        gotoNodeByInfo({ track_seg_point_id: initId });
      }
    }
  } catch (e) {
    if (e.name === "AbortError") return; // ì •ìƒ
    console.error("[api_points] fetch ì‹¤íŒ¨:", e);
  }
}

function renderFetchedPoints(data) {
  ensurePointsLayer();
  clearPointsLayer();

  if (!Array.isArray(data)) return;

  for (const p of data) {
    let lat = p.lat, lon = p.lon;

    if ((lat == null || lon == null) && Array.isArray(p.coordinates) && p.coordinates.length >= 2) {
      const a = p.coordinates[0], b = p.coordinates[1];
      const aIsLat = a >= -90 && a <= 90;
      const bIsLat = b >= -90 && b <= 90;
      if (aIsLat && !bIsLat) { lat = a; lon = b; }
      else if (!aIsLat && bIsLat) { lat = b; lon = a; }
      else { lat = a; lon = b; }
    }

    if (lat == null || lon == null) continue;

    // ë§ˆì»¤ (ì›í•˜ë©´ circleMarkerë¡œ ê°€ë³ê²Œ)
    const marker = L.circleMarker([lat, lon], {
      radius: 4,
      opacity: 0, // í…Œë‘ë¦¬ ì™„ì „ íˆ¬ëª…
      fillOpacity: 0 // ì±„ìš°ê¸° ì™„ì „ íˆ¬ëª…
    });

    // âœ… í´ë¦­ ì‹œ í•´ë‹¹ ë…¸ë“œë¡œ ì´ë™
    marker.on("click", (e) => {
      try {
        // ì§€ë„ í´ë¦­/ë“œë˜ê·¸ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€(ì„ íƒ)
        if (e && e.originalEvent) {
          L.DomEvent.stopPropagation(e.originalEvent);
          L.DomEvent.preventDefault(e.originalEvent);
        }
      } catch (_) {}

      const nodeId =
        (p.track_seg_point_id != null ? String(p.track_seg_point_id).trim() : "") ||
        (p.id != null ? String(p.id).trim() : "");

      if (!nodeId) {
        console.warn("[marker click] nodeIdê°€ ì—†ìŒ:", p);
        return;
      }

      // 1) ê°™ì€ í˜ì´ì§€ì—ì„œ íŒŒë…¸/ë·°ì–´ ì´ë™ ê°€ëŠ¥í•˜ë©´ ìš°ì„  ì‹œë„
      const hasLocalNode = Array.isArray(points)
        && points.some(x => String(x?.track_seg_point_id ?? '').trim() === nodeId);
      if (hasLocalNode && typeof window.gotoNodeByInfo === "function") {
        window.gotoNodeByInfo({ track_seg_point_id: nodeId });
        return;
      }

      // 2) fallback: ì„œë²„ ë¼ìš°íŠ¸ë¡œ ì´ë™í•´ ëŒ€ìƒ ë…¸ë“œë¥¼ ë¡œë“œ
      window.location.href = `/pano/${encodeURIComponent(nodeId)}`;
    });

    marker.addTo(pointsLayer);
  }
}

function attachMapFetchHandlers() {
  if (!miniMap) return;

  // ì´ë™/ì¤Œ ì¢…ë£Œ ì‹œ
  // ì¤‘ë³µ ë°©ì§€
  miniMap.off("moveend zoomend");
  miniMap.on("moveend zoomend", () => scheduleFetchByMap(250));

  // ìµœì´ˆ 1íšŒ
  scheduleFetchByMap(0);
}

// ì½˜ì†” ë¡œê·¸ ë¹„í™œì„±í™” (í•„ìš”í•  ë•Œë§Œ)
const DISABLE_CONSOLE = false;
(function() {
  if (!DISABLE_CONSOLE) return;

  const originalLog = console.log.bind(console);
  const originalWarn = console.warn.bind(console);
  const originalInfo = console.info.bind(console);
  const originalDebug = console.debug.bind(console);
  const originalError = console.error.bind(console);

  window.__originalConsole = {
    log: originalLog,
    warn: originalWarn,
    info: originalInfo,
    debug: originalDebug,
    error: originalError
  };

  console.log = function() {};
  console.warn = function() {};
  console.info = function() {};
  console.debug = function() {};
  console.error = function() {};
})();
  
function panoDebugLog(...args) {
  if (window.__originalConsole && typeof window.__originalConsole.log === 'function') {
    window.__originalConsole.log(...args);
  } else if (console && typeof console.error === 'function') {
    console.error(...args);
  }
}
  
window.SCRIPT_ROOT = "{{ request.script_root }}";

/* =========================
   ê³µí†µ ìƒíƒœ/ìœ í‹¸
========================= */
let keysPressed = {};
let points = [], currentIndex = 0;
let miniMap, markers = [], highlightOverlay = null;
let marzipanoViewer = null;
let marzipanoScenes = [];
let northOffset = 0;
let keyHoldInterval = null;
let currentHeldKey = null;
const NORTH_OFFSET_STORAGE_KEY = 'northOffsetDeg';

let didJumpToInitialTarget = false;
let USE_VIEWPORT_POINTS = false;

// ì”¬ ì—…ê·¸ë ˆì´ë“œ ìˆœì°¨ ì‹¤í–‰ì„ ìœ„í•œ í
const sceneUpgradeQueues = {};

function waitFrames(count = 1) {
  return new Promise(resolve => {
    function step(remaining) {
      if (remaining <= 0) {
        resolve();
      } else {
        requestAnimationFrame(() => step(remaining - 1));
      }
    }
    step(count);
  });
}

function delay(ms = 0) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function enqueueSceneUpgrade(idx, task) {
  const previous = sceneUpgradeQueues[idx] || Promise.resolve();
  const next = previous.then(() => task());
  const wrapped = next.catch(err => {
    console.error(`[íƒ€ì¼ ë¡œë“œ] ì”¬ ì—…ê·¸ë ˆì´ë“œ ì‹¤íŒ¨ (í¬ì¸íŠ¸ ${idx})`, err);
  });
  const done = wrapped.finally(() => {
    if (sceneUpgradeQueues[idx] === done) {
      sceneUpgradeQueues[idx] = null;
    }
  });
  sceneUpgradeQueues[idx] = done;
}

// per-image offset ì €ì¥
let perImageOffsets = {};
const PER_IMAGE_OFFSETS_STORAGE_KEY = 'perImageOffsets.v2';

// ì§€ë„ ê´€ë ¨ ë³€ìˆ˜
let currentMapType = 'leaflet'; // 'leaflet' ë˜ëŠ” 'kakao'
// ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš©
// let kakaoMap = null;

// ì´ë¯¸ì§€ ë²ˆí˜¸ í‘œì‹œ
let showImageNumbers = false;
let numberLabels = [];

// Leaflet Control
let returnBtn = null;

// ë‹¤ì¤‘ ë°ì´í„°ì…‹
let availableDatasets = [];
let selectedDatasetNames = new Set();

// í´ë” ì„¤ì • (ì„œë²„ì—ì„œ ë™ì ìœ¼ë¡œ ë¡œë“œë˜ë¯€ë¡œ ë¹ˆ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”)
let currentFolderSettings = {
  img_folder: '',
  track_folder: '',
  point_folder: '',
  match_folder: '',
  tile_folder: ''
};

// ê²½ë¡œ ì„¤ì • ìƒíƒœ
let isDataPathConfigured = false;
const DATA_PATH_CONFIGURED_KEY = 'dataPathConfigured';
const FOLDER_SETTINGS_KEY = 'folderSettings';

// ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸
let isLoadingDatasets = false;

// ê°œë³„ ê²½ë¡œ ì„¤ì • ìƒíƒœ
let currentPathType = null; // 'gpx', 'img', 'csv'

const codeToDeg = {
  'KeyW': 0,   'KeyE': 45,  'KeyD': 90,  'KeyC': 135,
  'KeyX': 180, 'KeyS': 180, 'KeyZ': 225, 'KeyA': 270, 'KeyQ': 315
};

const blueCircleSVG = '<svg width="16" height="16"><circle cx="8" cy="8" r="6" fill="none" stroke="#1961e4" stroke-width="3"/></svg>';
const selectedCircleSVG = '<svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="7" fill="#ffeb3b" stroke="#f57f17" stroke-width="2"/></svg>';
let selectedIndices = new Set();
let selectionRectDiv = null;
let selectionStartPt = null;
let prevMiniMapSize = { width: 300, height: 300 };
let tempSelectionIndices = new Set();
const currentPinSVG = '<svg width="24" height="24" viewBox="0 0 24 24">' +
  '<circle cx="12" cy="12" r="9" fill="#fff" stroke="#2066da" stroke-width="2"/>' +
  '<circle cx="12" cy="12" r="5" fill="#338af3" stroke="#338af3" stroke-width="1"/>' +
  '<rect x="10.3" y="12.5" width="3.4" height="6" rx="1.6" fill="#2066da"/>' +
'</svg>';

/* =========================
   âœ… ì¹´ì¹´ì˜¤ SDK ë¡œë” (í•µì‹¬)
========================= */
// ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš©
/*
function ensureKakaoSDK() {
  return new Promise((resolve, reject) => {
    if (window.kakao && kakao.maps) return resolve(); // ì´ë¯¸ ì¤€ë¹„ë¨
    let script = document.getElementById('kakao-sdk');
    if (!script) {
      script = document.createElement('script');
      script.id = 'kakao-sdk';
      script.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=b4fa2d086a630eaa441b0331bd094c92&autoload=false';
      script.defer = true;
      document.head.appendChild(script);
    }
    script.addEventListener('load', () => resolve());
    script.addEventListener('error', () => reject(new Error('ì¹´ì¹´ì˜¤ SDK ë¡œë“œ ì‹¤íŒ¨')));
  });
}
*/


function getInitialTargetNodeId() {
  // 1) ì „ì—­ ë³€ìˆ˜ë¡œ ì£¼ì…ëœ ê²½ìš° (ì˜ˆ: window.initialTargetNodeId = "123")
  if (window.initialTargetNodeId != null) {
    const v = String(window.initialTargetNodeId).trim();
    if (v) return v;
  }

  // 2) URL ì¿¼ë¦¬ìŠ¤íŠ¸ë§ (?initialTargetNodeId=123)
  try {
    const sp = new URLSearchParams(location.search);
    const v = (sp.get('initialTargetNodeId') || '').trim();
    if (v) return v;
  } catch (e) {}

  // 3) ì¿ í‚¤ (ì›í•˜ë©´) - initial_target_node_id
  try {
    const v = `; ${document.cookie}`;
    const parts = v.split(`; initial_target_node_id=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift() || '').trim();
  } catch (e) {}

  return '';
}



/* =========================
   ì¢Œí‘œ/ê°ë„ ìœ í‹¸ & ë§ˆì»¤ ë Œë” ë“±
========================= */
function offsetKeyFor(idx) {
  const p = points[idx] || {};
  const ds = p.dataset_name || p.datasetName || 'unknown';
  const fn = p.image_filename || p.imageFile || p.image || String(idx);
  return `${ds}::${fn}`;
}

function getPerImageOffset(idx) {
  // 1. CSVì˜ ìµœì¢… ê°ë„ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš© (angle + angle_add)
  if (points[idx] && points[idx].final_angle !== undefined) {
    // console.log(`getPerImageOffset(${idx}): CSV ìµœì¢…ê°ë„ ì‚¬ìš© = ${points[idx].final_angle}Â°`);
    return points[idx].final_angle;
  }
  
  // 2. CSVì—ì„œ ë¡œë“œëœ angleê³¼ angle_addë¥¼ ì§ì ‘ ê³„ì‚°
  if (points[idx]) {
    const csvAngle = points[idx].csv_angle || 0;
    const csvAngleAdd = points[idx].csv_angle_add || 0;
    const calculatedFinalAngle = csvAngle + csvAngleAdd;
    if (csvAngleAdd !== 0) {
      // console.log(`getPerImageOffset(${idx}): CSV ì§ì ‘ê³„ì‚° ì‚¬ìš© = ${csvAngle}Â° + ${csvAngleAdd}Â° = ${calculatedFinalAngle}Â°`);
      return calculatedFinalAngle;
    }
  }
  
  // 3. ì‚¬ìš©ìê°€ ì¶”ê°€ë¡œ ì„¤ì •í•œ ê°œë³„ ì˜¤í”„ì…‹ ì‚¬ìš© (localStorage)
  const key = offsetKeyFor(idx);
  const localStorageOffset = perImageOffsets[key];
  if (localStorageOffset !== undefined && localStorageOffset !== 0) {
    // console.log(`getPerImageOffset(${idx}): localStorage ì˜¤í”„ì…‹ ì‚¬ìš© = ${localStorageOffset}Â°`);
    return localStorageOffset;
  }
  
  // 4. ê¸°ë³¸ê°’ 0
  // console.log(`getPerImageOffset(${idx}): ê¸°ë³¸ê°’ ì‚¬ìš© = 0Â°`);
  return 0;
}

async function setPerImageOffset(idx, value) {
  const key = offsetKeyFor(idx);
  perImageOffsets[key] = value;
  try { localStorage.setItem(PER_IMAGE_OFFSETS_STORAGE_KEY, JSON.stringify(perImageOffsets)); } catch (e) {}
  
  // CSV íŒŒì¼ì—ë„ ì €ì¥
  try {
    const point = points[idx];
    if (point && point.dataset_name) {
      const response = await fetch('/api/save-offset', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          dataset_name: point.dataset_name,
          image_index: idx,
          offset: value
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        // console.log(`CSV ì €ì¥ ì„±ê³µ: ${result.message}`);
        // points ë°°ì—´ì˜ csv_angle_addì™€ final_angle ì—…ë°ì´íŠ¸
        if (points[idx]) {
          const oldFinalAngle = points[idx].final_angle;
          const oldAngleAdd = points[idx].csv_angle_add || 0;
          
          // ê¸°ì¡´ angle_add ê°’ì„ ìƒˆë¡œìš´ ê°’ìœ¼ë¡œ ë³€ê²½ (ëˆ„ì ì´ ì•„ë‹˜)
          points[idx].csv_angle_add = value;
          points[idx].final_angle = parseFloat(points[idx].csv_angle) + points[idx].csv_angle_add;
          
          // console.log(`ì´ë¯¸ì§€ ${idx} ì˜¤í”„ì…‹ ë³€ê²½: csv_angle=${points[idx].csv_angle}Â°, ê¸°ì¡´angle_add=${oldAngleAdd}Â°, ìƒˆë¡œìš´angle_add=${value}Â°, final_angle=${oldFinalAngle}Â° â†’ ${points[idx].final_angle}Â°`);
        }
      } else {
        console.error('CSV ì €ì¥ ì‹¤íŒ¨:', response.statusText);
      }
    }
  } catch (error) {
    console.error('CSV ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
  }
}

// ìš°ì„ ìˆœìœ„: ê°œë³„ ì´ë¯¸ì§€ ì˜¤í”„ì…‹ > North Offset > 0
function getTotalOffset(idx) {
  const perImageOffset = getPerImageOffset(idx);
  let finalOffset = 0;
  
  if (perImageOffset !== 0) {
    finalOffset = perImageOffset; // ê°œë³„ ì´ë¯¸ì§€ ì˜¤í”„ì…‹ì´ ìš°ì„ 
    // console.log(`getTotalOffset(${idx}): ê°œë³„ì´ë¯¸ì§€ì˜¤í”„ì…‹ ì‚¬ìš© = ${perImageOffset}Â° (ìš°ì„ ìˆœìœ„: CSV > localStorage > 0)`);
  } else if (northOffset !== 0) {
    finalOffset = northOffset; // North Offsetì´ ë‘ ë²ˆì§¸
    // console.log(`getTotalOffset(${idx}): North Offset ì‚¬ìš© = ${northOffset}Â°`);
  } else {
    finalOffset = 0; // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ 0
    // console.log(`getTotalOffset(${idx}): ì˜¤í”„ì…‹ ì—†ìŒ = 0Â°`);
  }
  
  return finalOffset;
}

function updateNorthOffsetInputStyle() {
  const input = document.getElementById('northOffsetInput');
  if (!input) return;
  const currentPerImageOffset = getPerImageOffset(currentIndex);
  if (currentPerImageOffset === 0) {
  input.style.borderColor = '#ccc';
  input.style.backgroundColor = '#fff';
    input.title = 'North Offsetì´ í™œì„±í™”ë¨ (ê°œë³„ ì´ë¯¸ì§€ ì˜¤í”„ì…‹: 0Â°)';
  } else {
    input.style.borderColor = '#ff4444';
    input.style.backgroundColor = '#fff5f5';
    input.title = 'North Offsetì´ ë¹„í™œì„±í™”ë¨ (ê°œë³„ ì´ë¯¸ì§€ ì˜¤í”„ì…‹: ' + currentPerImageOffset + 'Â°)';
  }
}

function makeDirectionFanSVG(angleDeg = 0, spanDeg = 80) {
  const r = 27, cx = 30, cy = 30;
  const startAngle = angleDeg - spanDeg/2;
  const endAngle = angleDeg + spanDeg/2;
  const rad = d => (d-90) * Math.PI/180;
  const x1 = cx + r * Math.cos(rad(startAngle));
  const y1 = cy + r * Math.sin(rad(startAngle));
  const x2 = cx + r * Math.cos(rad(endAngle));
  const y2 = cy + r * Math.sin(rad(endAngle));
  const laf = (spanDeg > 180) ? 1 : 0;
  return '<svg width="60" height="60" style="position:absolute;left:0;top:0;">' +
    '<defs>' +
      '<radialGradient id="fanGrad" cx="50%" cy="50%" r="100%">' +
        '<stop offset="0%" stop-color="#1976d2" stop-opacity="0.7"/>' +
        '<stop offset="75%" stop-color="#1976d2" stop-opacity="0.18"/>' +
        '<stop offset="100%" stop-color="#1976d2" stop-opacity="0"/>' +
      '</radialGradient>' +
    '</defs>' +
    '<path d="M' + cx + ',' + cy + ' L' + x1 + ',' + y1 + ' A' + r + ',' + r + ' 0 ' + laf + ' 1 ' + x2 + ',' + y2 + ' Z" fill="url(#fanGrad)" stroke="none"/>' +
    '</svg>';
}

function triggerTrackLineLoadFromPoints() {
  if (!miniMap || !Array.isArray(points) || points.length < 1) return;
  const datasetName = points[0]?.dataset_name;
  if (!datasetName) return;

  loadTrackLineFromShapefile(datasetName).catch(err => {
    console.error('[triggerTrackLineLoadFromPoints] Track ë¼ì¸ ë¡œë“œ ì‹¤íŒ¨:', err);
  });
}

async function renderMarkers() {
  // Track ì„ ë¶„ì€ USE_VIEWPORT_POINTSì™€ ê´€ê³„ì—†ì´ í•­ìƒ ë¡œë“œ
  // ê¸°ì¡´ track polyline ì œê±°
  if (window.trackPolyline && miniMap) {
    try {
      miniMap.removeLayer(window.trackPolyline);
    } catch (e) {
      console.warn('[renderMarkers] ê¸°ì¡´ track polyline ì œê±° ì‹¤íŒ¨:', e);
    }
    window.trackPolyline = null;
  }
  
  // Track ì„ ë¶„ ê·¸ë¦¬ê¸° (Shapefileë§Œ ì§€ì›)
  if (points.length > 1 && miniMap) {
    // Shapefile ë°ì´í„°ì…‹: track.shpì—ì„œ ë¼ì¸ ë¡œë“œ
    const datasetName = points[0].dataset_name;
    console.log('[renderMarkers] Track ë¡œë“œ ì‹œë„:', { 
      pointsLength: points.length, 
      datasetName: datasetName,
      miniMapExists: !!miniMap 
    });
    if (datasetName) {
      // ë¹„ë™ê¸°ë¡œ ë¡œë“œí•˜ë˜ ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ (ë…¼ë¸”ë¡œí‚¹)
      // í•˜ì§€ë§Œ ì—ëŸ¬ëŠ” ì²˜ë¦¬í•˜ë„ë¡ í•¨
      loadTrackLineFromShapefile(datasetName).catch(err => {
        console.error('[renderMarkers] Track ë¼ì¸ ë¡œë“œ ì‹¤íŒ¨:', err);
      });
    } else {
      console.warn('[renderMarkers] dataset_nameì´ ì—†ìŠµë‹ˆë‹¤.');
    }
  } else {
    console.log('[renderMarkers] Track ë¡œë“œ ì¡°ê±´ ë¶ˆë§Œì¡±:', { 
      pointsLength: points.length, 
      miniMapExists: !!miniMap 
    });
  }
  
  if (USE_VIEWPORT_POINTS) {
    // âœ… ì „ì²´ í¬ì¸íŠ¸ ë§ˆì»¤ëŠ” ê·¸ë¦¬ì§€ ì•ŠìŒ
    // íŠ¸ë™ ë¼ì¸ì€ ìœ„ì—ì„œ ì´ë¯¸ ë¡œë“œë¨
    return;
  }

  // ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš©
  // if (currentMapType === 'kakao') { renderKakaoMarkers(); return; }

  // ê¸°ì¡´ ë§ˆì»¤ì™€ ì„ ë¶„ ì œê±°
  if (markers.length) markers.forEach(m=>miniMap.removeLayer(m));
  if (numberLabels.length) numberLabels.forEach(l=>miniMap.removeLayer(l));
  
  markers = [];
  numberLabels = [];
  
  // ì´ë¯¸ì§€ì™€ ë§¤ì¹­ëœ í¬ì¸íŠ¸ë§Œ í•„í„°ë§
  const matchedPoints = points.filter(pt => pt.image && pt.image.trim() !== '');
  
  matchedPoints.forEach((pt, i) => {
    // ì›ë³¸ ì¸ë±ìŠ¤ ì°¾ê¸° (ì „ì²´ points ë°°ì—´ì—ì„œì˜ ì¸ë±ìŠ¤)
    const originalIndex = points.findIndex(p => p === pt);
    
    let isSelected = selectedIndices.has(originalIndex);
    if (showImageNumbers && selectionStartPt && tempSelectionIndices.size) {
      const inside = tempSelectionIndices.has(originalIndex);
      const willBeSelected = inside ? !selectedIndices.has(originalIndex) : selectedIndices.has(originalIndex);
      isSelected = willBeSelected;
    }
    
    // ì™„ì „íˆ íˆ¬ëª…í•œ ì›í˜• ë§ˆì»¤ ìƒì„± (ê¸°ì¡´ í¬ê¸° ìœ ì§€)
    const markerRadius = showImageNumbers && isSelected ? 20 : 16; // ê¸°ì¡´ í¬ê¸°ë¡œ ë³µì›
    const markerColor = showImageNumbers && isSelected ? '#ffeb3b' : '#1976d2';
    
    const marker = L.circleMarker([pt.lat, pt.lon], {
      radius: markerRadius,
      fillColor: markerColor,
      color: markerColor,
      weight: 0, // í…Œë‘ë¦¬ ì—†ìŒ
      opacity: 0, // í…Œë‘ë¦¬ ì™„ì „ íˆ¬ëª…
      fillOpacity: 0 // ì±„ìš°ê¸° ì™„ì „ íˆ¬ëª…
    }).on('click', () => window.__gotoPoint(originalIndex));
    
    marker.addTo(miniMap);
    markers.push(marker);

    if (showImageNumbers) {
      const perImageOffset = getPerImageOffset(originalIndex);
      const hasCustomOffset = perImageOffset !== 0;
      const numberBackground = isSelected ? '#ffeb3b' : (hasCustomOffset ? '#ccc' : '#fff');

      let numberIcon = L.divIcon({
        className: 'number-label',
        html: '<div style="background:' + numberBackground + '; border:2px solid #333; border-radius:50%; width:24px; height:24px; display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;color:#333;">' + (originalIndex + 1) + '</div>',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
      let numberLabel = L.marker([pt.lat, pt.lon], {icon: numberIcon, interactive: false, zIndexOffset: 500});
      numberLabel.addTo(miniMap);
      numberLabels.push(numberLabel);
    }
  });
}

/* =========================
   í´ë” ì„¤ì •
========================= */
async function loadFolderSettings() {
  try {
    // localStorageì—ì„œ ì„¤ì • ë¡œë“œ
    const savedSettings = localStorage.getItem(FOLDER_SETTINGS_KEY);
    if (savedSettings) {
      const parsed = JSON.parse(savedSettings);
      currentFolderSettings = parsed;
      isDataPathConfigured = localStorage.getItem(DATA_PATH_CONFIGURED_KEY) === 'true';
      // console.log('ì €ì¥ëœ í´ë” ì„¤ì • ë¡œë“œë¨:', currentFolderSettings);
      // console.log('ê²½ë¡œ ì„¤ì • ìƒíƒœ:', isDataPathConfigured);
      
      // ì„œë²„ì— ì„¤ì • ì ìš©
      await applyFolderSettingsToServer();
    } else {
      // ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì„œë²„ì—ì„œ ë¡œë“œ
      const response = await fetch('/api/folder-settings');
      if (response.ok) {
        const settings = await response.json();
        currentFolderSettings = settings;
        // ê¸°ë³¸ ê²½ë¡œê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ê²½ë¡œ ì„¤ì • ì™„ë£Œë¡œ ê°„ì£¼
        isDataPathConfigured = true;
        localStorage.setItem(DATA_PATH_CONFIGURED_KEY, 'true');
        // console.log('ì„œë²„ì—ì„œ í´ë” ì„¤ì • ë¡œë“œë¨:', settings);
      }
    }
    
    updateUIForPathStatus();
    
    // ë°ì´í„°ì…‹ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ë§Œ ìˆ˜í–‰ (ìë™ ë¡œë“œ ë¹„í™œì„±í™”)
    // await detectAvailableDatasets();
    
    // ìë™ ë¡œë“œ ë¹„í™œì„±í™” - ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ 'ë°ì´í„° ë¡œë“œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ í•¨
    // setTimeout(() => {
    //   autoLoadDatasets();
    // }, 500);
  } catch (error) {
    console.error('í´ë” ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
  }
}

async function applyFolderSettingsToServer() {
  try {
    const response = await fetch('/api/folder-settings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(currentFolderSettings)
    });
    
    if (response.ok) {
      // console.log('ì„œë²„ì— í´ë” ì„¤ì • ì ìš©ë¨');
    } else {
      // console.error('ì„œë²„ì— í´ë” ì„¤ì • ì ìš© ì‹¤íŒ¨');
    }
  } catch (error) {
    console.error('ì„œë²„ ì„¤ì • ì ìš© ì¤‘ ì˜¤ë¥˜:', error);
  }
}

function updateUIForPathStatus() {
  const loadDatasetBtn = document.getElementById('loadDatasetBtn');
  const setDataPathBtn = document.getElementById('setDataPathBtn');
  // ë™ì  URL ëª¨ë“œ(ë©”ë‰´ ìˆ¨ê¹€) ë˜ëŠ” ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
  if (document.body.classList.contains('hide-menu') || !loadDatasetBtn || !setDataPathBtn) {
    return;
  }
  
  if (isDataPathConfigured) {
    loadDatasetBtn.style.opacity = '1';
    loadDatasetBtn.style.cursor = 'pointer';
    loadDatasetBtn.title = 'ë°ì´í„°ì…‹ì„ ë¡œë“œí•©ë‹ˆë‹¤';
    setDataPathBtn.innerHTML = 'ë°ì´í„° ê²½ë¡œ ì¬ì„¤ì •';
  } else {
    loadDatasetBtn.style.opacity = '0.5';
    loadDatasetBtn.style.cursor = 'not-allowed';
    loadDatasetBtn.title = 'ë¨¼ì € ë°ì´í„° ê²½ë¡œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”';
    setDataPathBtn.innerHTML = 'ë°ì´í„° ê²½ë¡œ ì§€ì •';
  }
}

async function saveFolderSettings() {
  // ê²½ë¡œë¥¼ ìŠ¬ë˜ì‹œë¡œ í†µì¼í•˜ì—¬ ì €ì¥
  const normalizePath = (path) => path ? path.trim().replace(/\\/g, '/') : '';
  
  const imgFolder = normalizePath(document.getElementById('imgFolderInput').value);
  const trackFolder = normalizePath(document.getElementById('trackFolderInput').value);
  const pointFolder = normalizePath(document.getElementById('pointFolderInput').value);
  const matchFolder = normalizePath(document.getElementById('matchFolderInput').value);
  const tileFolderEl = document.getElementById('tileFolderInput');
  const tileFolder = tileFolderEl ? normalizePath(tileFolderEl.value) : '';
  
  if (!imgFolder) {
    alert('ì´ë¯¸ì§€ í´ë”ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
    return;
  }
  
  try {
    const response = await fetch('/api/folder-settings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        img_folder: imgFolder,
        track_folder: trackFolder,
        point_folder: pointFolder,
        match_folder: matchFolder,
        tile_folder: tileFolder
      })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      currentFolderSettings = result.settings;
      
      // localStorageì— ì €ì¥
      localStorage.setItem(FOLDER_SETTINGS_KEY, JSON.stringify(currentFolderSettings));
      localStorage.setItem(DATA_PATH_CONFIGURED_KEY, 'true');
      isDataPathConfigured = true;
      
      // console.log('í´ë” ì„¤ì • ì €ì¥ë¨:', result.settings);
      alert('ë°ì´í„° ê²½ë¡œê°€ ì„±ê³µì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      closeFolderSettingsModal();
      
      // UI ì—…ë°ì´íŠ¸
      updateUIForPathStatus();
      
      // ë°ì´í„°ì…‹ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ë§Œ ìˆ˜í–‰ (ìë™ ë¡œë“œ ë¹„í™œì„±í™”)
      await detectAvailableDatasets();
      
      // ìë™ ë¡œë“œ ë¹„í™œì„±í™” - ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ 'ë°ì´í„° ë¡œë“œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ í•¨
      // setTimeout(() => {
      //   autoLoadDatasets();
      // }, 500);
    } else {
      const errorMsg = result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
      console.error('í´ë” ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', errorMsg);
      alert('í´ë” ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + errorMsg);
    }
  } catch (error) {
    console.error('í´ë” ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
    alert('í´ë” ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

async function openFolderSettingsModal() {
  // console.log('í´ë” ì„¤ì • ëª¨ë‹¬ ì—´ê¸° ì‹œë„');
  const modal = document.getElementById('folderSettingsModal');
  
  if (!modal) {
    console.error('í´ë” ì„¤ì • ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    return;
  }
  
  // ì„œë²„ì—ì„œ ìµœì‹  ì„¤ì • ê°€ì ¸ì˜¤ê¸° (ëª¨ë‹¬ì„ ì—´ ë•Œë§ˆë‹¤)
  try {
    const response = await fetch('/api/folder-settings');
    if (response.ok) {
      const serverSettings = await response.json();
      // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì„¤ì •ìœ¼ë¡œ ì—…ë°ì´íŠ¸
      currentFolderSettings = { ...currentFolderSettings, ...serverSettings };
      // localStorageì—ë„ ì €ì¥
      localStorage.setItem(FOLDER_SETTINGS_KEY, JSON.stringify(currentFolderSettings));
    }
  } catch (error) {
    console.error('ì„œë²„ì—ì„œ í´ë” ì„¤ì •ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜:', error);
    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ì¡´ ì„¤ì • ì‚¬ìš©
  }
  
  // í˜„ì¬ ì„¤ì •ê°’ìœ¼ë¡œ ì…ë ¥ í•„ë“œ ì±„ìš°ê¸° (í•­ìƒ ì„œë²„ì—ì„œ ìµœì‹  ì„¤ì • ì‚¬ìš©)
  const imgInput = document.getElementById('imgFolderInput');
  const trackInput = document.getElementById('trackFolderInput');
  const pointInput = document.getElementById('pointFolderInput');
  const matchInput = document.getElementById('matchFolderInput');
  const tileInput = document.getElementById('tileFolderInput');
  
  // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì„¤ì •ê°’ìœ¼ë¡œ ì…ë ¥ í•„ë“œ ì±„ìš°ê¸° (í•­ìƒ ìµœì‹  ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸)
  if (imgInput) {
    imgInput.value = currentFolderSettings.img_folder || '';
    imgInput.setAttribute('value', currentFolderSettings.img_folder || '');
  }
  if (trackInput) {
    trackInput.value = currentFolderSettings.track_folder || '';
    trackInput.setAttribute('value', currentFolderSettings.track_folder || '');
  }
  if (pointInput) {
    pointInput.value = currentFolderSettings.point_folder || '';
    pointInput.setAttribute('value', currentFolderSettings.point_folder || '');
  }
  if (matchInput) {
    matchInput.value = currentFolderSettings.match_folder || '';
    matchInput.setAttribute('value', currentFolderSettings.match_folder || '');
  }
  if (tileInput) {
    tileInput.value = currentFolderSettings.tile_folder || '';
    tileInput.setAttribute('value', currentFolderSettings.tile_folder || '');
  }
  
  modal.style.display = 'flex';
  closeMenus();
  // console.log('í´ë” ì„¤ì • ëª¨ë‹¬ì´ ì—´ë ¸ìŠµë‹ˆë‹¤');
}

function closeFolderSettingsModal() {
  document.getElementById('folderSettingsModal').style.display = 'none';
}

/* =========================
   ê²½ë¡œ íƒ€ì… ì„ íƒ ëª¨ë‹¬
========================= */
function openPathTypeSelectionModal() {
  const modal = document.getElementById('pathTypeSelectionModal');
  modal.style.display = 'flex';
  closeMenus();
}

function closePathTypeSelectionModal() {
  document.getElementById('pathTypeSelectionModal').style.display = 'none';
}

/* =========================
   ê°œë³„ í´ë” ê²½ë¡œ ì„¤ì •
========================= */
function openIndividualPathModal(pathType) {
  currentPathType = pathType;
  const modal = document.getElementById('individualPathModal');
  const title = document.getElementById('individualPathTitle');
  const description = document.getElementById('individualPathDescription');
  const currentPathDisplay = document.getElementById('currentPathDisplay');
  const input = document.getElementById('individualPathInput');
  const help = document.getElementById('individualPathHelp');
  
  // íƒ€ì…ë³„ ì„¤ì •
  const configs = {
    'gpx': {
      title: 'ğŸ—ºï¸ GPX í´ë” ê²½ë¡œ ì§€ì •',
      description: 'GPX íŒŒì¼ë“¤ì´ ì €ì¥ëœ í´ë” ê²½ë¡œë¥¼ ì„¤ì •í•˜ì„¸ìš”.',
      currentPath: currentFolderSettings.gpx_folder,
      placeholder: 'ì˜ˆ: static/gpx',
      helpText: 'GPX íŒŒì¼ë“¤ì´ ì €ì¥ëœ í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”'
    },
    'img': {
      title: 'ğŸ“ IMG í´ë” ê²½ë¡œ ì§€ì •',
      description: 'íŒŒë…¸ë¼ë§ˆ ì´ë¯¸ì§€ë“¤ì´ ì €ì¥ëœ í´ë” ê²½ë¡œë¥¼ ì„¤ì •í•˜ì„¸ìš”.',
      currentPath: currentFolderSettings.img_folder,
      placeholder: 'ì˜ˆ: static/img',
      helpText: 'íŒŒë…¸ë¼ë§ˆ ì´ë¯¸ì§€ë“¤ì´ ì €ì¥ëœ í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”'
    },
    'csv': {
      title: 'ğŸ“Š CSV í´ë” ê²½ë¡œ ì§€ì •',
      description: 'ë§¤ì¹­ í…Œì´ë¸” CSV íŒŒì¼ë“¤ì´ ì €ì¥ëœ í´ë” ê²½ë¡œë¥¼ ì„¤ì •í•˜ì„¸ìš”.',
      currentPath: currentFolderSettings.csv_folder,
      placeholder: 'ì˜ˆ: static/match',
      helpText: 'ë§¤ì¹­ í…Œì´ë¸” CSV íŒŒì¼ë“¤ì´ ì €ì¥ëœ í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”'
    }
  };
  
  const config = configs[pathType];
  if (!config) {
    console.error('ì•Œ ìˆ˜ ì—†ëŠ” ê²½ë¡œ íƒ€ì…:', pathType);
    return;
  }
  
  title.textContent = config.title;
  description.textContent = config.description;
  currentPathDisplay.textContent = config.currentPath;
  input.placeholder = config.placeholder;
  input.value = config.currentPath;
  help.textContent = config.helpText;
  
  modal.style.display = 'flex';
  closeMenus();
}

function closeIndividualPathModal() {
  document.getElementById('individualPathModal').style.display = 'none';
  currentPathType = null;
}

function openPathBrowser() {
  // ë°”ë¡œ íŒŒì¼ íƒìƒ‰ê¸° ì—´ê¸°
  openFileDialog();
}

function closePathHelper() {
  document.getElementById('pathHelperModal').style.display = 'none';
}

function updatePathHelperContent() {
  const pathTypeNames = {
    'gpx': 'GPX',
    'img': 'IMG', 
    'csv': 'CSV'
  };
  
  const currentPath = currentFolderSettings[`${currentPathType}_folder`];
  const pathTypeName = pathTypeNames[currentPathType];
  
  // ëª¨ë‹¬ ì œëª© ì—…ë°ì´íŠ¸
  document.getElementById('pathHelperTitle').textContent = `ğŸ“ ${pathTypeName} í´ë” ê²½ë¡œ ì…ë ¥ ë„ìš°ë¯¸`;
  
  // í˜„ì¬ ê²½ë¡œ í‘œì‹œ
  document.getElementById('pathHelperCurrentPath').textContent = currentPath;
  
  // ê²½ë¡œ ì…ë ¥ ì˜ˆì‹œ ì—…ë°ì´íŠ¸
  const examples = document.getElementById('pathExamples');
  examples.innerHTML = `
    <div style="margin-bottom: 10px;">
      <strong>ìƒëŒ€ ê²½ë¡œ (ê¶Œì¥):</strong><br>
      <code style="background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">static/gpx</code> - static í´ë” ì•ˆì˜ gpx í´ë”<br>
      <code style="background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">data/images</code> - data í´ë” ì•ˆì˜ images í´ë”<br>
      <code style="background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">./uploads</code> - í˜„ì¬ í”„ë¡œì íŠ¸ í´ë”ì˜ uploads í´ë”
    </div>
    <div style="margin-bottom: 10px;">
      <strong>ì ˆëŒ€ ê²½ë¡œ:</strong><br>
      <code style="background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">C:/Users/ì‚¬ìš©ì/Documents/data</code> - Windows<br>
      <code style="background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">/Users/ì‚¬ìš©ì/Documents/data</code> - Mac/Linux
    </div>
  `;
}

function applyPathFromHelper() {
  const input = document.getElementById('individualPathInput');
  const helperInput = document.getElementById('pathHelperInput');
  const absoluteInput = document.getElementById('absolutePathInput');
  
  // ì ˆëŒ€ ê²½ë¡œê°€ ì…ë ¥ë˜ì–´ ìˆìœ¼ë©´ ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©, ì•„ë‹ˆë©´ ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©
  const selectedPath = absoluteInput.value.trim() || helperInput.value.trim();
  
  if (selectedPath) {
    input.value = selectedPath;
    closePathHelper();
  } else {
    alert('ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
  }
}

function copyFromRelativeToAbsolute() {
  const relativeInput = document.getElementById('pathHelperInput');
  const absoluteInput = document.getElementById('absolutePathInput');
  
  const relativePath = relativeInput.value.trim();
  if (!relativePath) {
    alert('ë¨¼ì € ìƒëŒ€ ê²½ë¡œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ í´ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ì‚¬ìš©ìì—ê²Œ ì ˆëŒ€ ê²½ë¡œ ì…ë ¥ ìš”ì²­
  const absolutePath = prompt(
    `ìƒëŒ€ ê²½ë¡œ: ${relativePath}\n\n` +
    `ì´ ê²½ë¡œì˜ ì ˆëŒ€ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:\n` +
    `ì˜ˆì‹œ:\n` +
    `â€¢ Windows: C:\\Users\\ì‚¬ìš©ì\\Documents\\panoview\\${relativePath}\n` +
    `â€¢ Mac/Linux: /Users/ì‚¬ìš©ì/Documents/panoview/${relativePath}\n\n` +
    `í˜„ì¬ í”„ë¡œì íŠ¸ í´ë”: ${window.location.origin.replace('http://', '').replace('https://', '')}`,
    relativePath
  );
  
  if (absolutePath !== null && absolutePath.trim()) {
    absoluteInput.value = absolutePath.trim();
  }
}

function openFileDialog() {
  // íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸° (í´ë” ì„ íƒ)
  const input = document.createElement('input');
  input.type = 'file';
  input.webkitdirectory = true; // í´ë” ì„ íƒ í—ˆìš©
  input.directory = true;
  input.multiple = true;
  
  input.onchange = function(e) {
    const files = Array.from(e.target.files);
    if (files.length > 0) {
      // ì²« ë²ˆì§¸ íŒŒì¼ì˜ ê²½ë¡œì—ì„œ í´ë” ê²½ë¡œ ì¶”ì¶œ
      const firstFile = files[0];
      
      if (firstFile.webkitRelativePath) {
        const pathParts = firstFile.webkitRelativePath.split('/');
        const folderPath = pathParts[0];
        
        // ì ˆëŒ€ ê²½ë¡œëŠ” ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•´ì•¼ í•¨ (ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…)
        // í˜„ì¬ ê²½ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì œì•ˆ
        const currentPath = document.getElementById('individualPathInput')?.value || '';
        const suggestedPath = currentPath || `static/${folderPath}`;
        const absolutePath = prompt(
          `í´ë”ë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.\n\n` +
          `ì„ íƒí•œ í´ë”: ${folderPath}\n\n` +
          `ì ˆëŒ€ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:`,
          suggestedPath
        );
        
        if (!absolutePath || !absolutePath.trim()) {
          return; // ì‚¬ìš©ìê°€ ì·¨ì†Œ
        }
        
        // ê°œë³„ ê²½ë¡œ ëª¨ë‹¬ì˜ ì…ë ¥ í•„ë“œì— ì§ì ‘ ì„¤ì •
        document.getElementById('individualPathInput').value = absolutePath;
        
        // ê²½ë¡œ ë„ìš°ë¯¸ ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('pathHelperModal').style.display = 'none';
        
        alert(`í´ë”ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!\nê²½ë¡œ: ${absolutePath}\n\nì €ì¥ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²½ë¡œë¥¼ ì„¤ì •í•˜ì„¸ìš”.`);
      } else {
        alert('í´ë” ì„ íƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê²½ë¡œ ë„ìš°ë¯¸ì—ì„œ ì§ì ‘ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }
    }
  };
  
  input.click();
}

async function openFolderBrowser(inputId) {
  // ì…ë ¥ í•„ë“œ í™•ì¸
  const inputElement = document.getElementById(inputId);
  if (!inputElement) {
    console.error(`âŒ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${inputId}`);
    alert(`ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${inputId}`);
    return;
  }
  
  let folderPath = '';
  
  // ìµœì‹  ë¸Œë¼ìš°ì €ì˜ showDirectoryPicker API ì‚¬ìš© ì‹œë„
  if (window.showDirectoryPicker) {
    try {
      const directoryHandle = await window.showDirectoryPicker();
      // DirectoryHandleì˜ name ì†ì„±ìœ¼ë¡œ í´ë”ëª… í™•ì¸
      const folderName = directoryHandle.name;
      
      // ìë™ìœ¼ë¡œ ê²½ë¡œ ì¶”ì • (prompt ì—†ì´)
      const currentPath = inputElement.value.trim();
      let autoPath = '';
      
      if (currentPath && currentPath.length > 0) {
        const isAbsolute = currentPath.length >= 2 && currentPath[1] === ':';
        if (isAbsolute) {
          // í˜„ì¬ ê²½ë¡œê°€ ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš°, ìƒìœ„ ë””ë ‰í† ë¦¬ + ì„ íƒí•œ í´ë”ëª…
          const currentParts = currentPath.replace(/[/\\]+$/, '').split(/[/\\]/);
          const parentPath = currentParts.slice(0, -1).join('/');
          autoPath = parentPath + '/' + folderName;
        } else {
          autoPath = `D:/PycharmProjects/panoview/static/${folderName}`;
        }
      } else {
        // ë‹¤ë¥¸ ì…ë ¥ í•„ë“œì˜ ê²½ë¡œë¥¼ ì°¸ê³ 
        const otherInputs = ['imgFolderInput', 'trackFolderInput', 'pointFolderInput', 'matchFolderInput', 'tileFolderInput'];
        for (const otherId of otherInputs) {
          if (otherId !== inputId) {
            const otherValue = document.getElementById(otherId)?.value.trim();
            if (otherValue && otherValue.length > 0) {
              const isOtherAbsolute = otherValue.length >= 2 && otherValue[1] === ':';
              if (isOtherAbsolute) {
                const parts = otherValue.replace(/[/\\]+$/, '').split(/[/\\]/);
                if (parts.length >= 2) {
                  parts.pop();
                  autoPath = parts.join('/') + '/' + folderName;
                  break;
                }
              } else {
                autoPath = `D:/PycharmProjects/panoview/static/${folderName}`;
                break;
              }
            }
          }
        }
        if (!autoPath) {
          autoPath = `D:/PycharmProjects/panoview/static/${folderName}`;
        }
      }
      
      folderPath = autoPath;
    } catch (error) {
      // ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš°
      if (error.name !== 'AbortError') {
        console.error('í´ë” ì„ íƒ ì˜¤ë¥˜:', error);
      }
      return;
    }
  } else {
    // showDirectoryPickerê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš° ê¸°ì¡´ webkitdirectory ë°©ì‹ ì‚¬ìš©
    const input = document.createElement('input');
    input.type = 'file';
    input.webkitdirectory = true;
    input.directory = true;
    input.multiple = true;
    
    await new Promise((resolve) => {
      input.onchange = function(e) {
        const files = Array.from(e.target.files);
        
        if (files.length > 0) {
          const firstFile = files[0];
          
          // ì…ë ¥ í•„ë“œ ë‹¤ì‹œ ì°¾ê¸°
          const inputElement = document.getElementById(inputId);
          if (!inputElement) {
            console.error(`âŒ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${inputId}`);
            alert(`ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${inputId}`);
            resolve();
            return;
          }
          
          // file.pathëŠ” ëŒ€ë¶€ë¶„ì˜ ë¸Œë¼ìš°ì €ì—ì„œ ë³´ì•ˆìƒ ì œê³µë˜ì§€ ì•ŠìŒ
          // ìë™ìœ¼ë¡œ ê²½ë¡œë¥¼ ì¶”ì •í•˜ì—¬ ì…ë ¥ í•„ë“œì— ì„¤ì • (prompt ì—†ì´)
          if (firstFile.path && firstFile.path.trim()) {
            // file.pathê°€ ì œê³µë˜ëŠ” ê²½ìš° (Edge ë“± ì¼ë¶€ ë¸Œë¼ìš°ì €) - ì§ì ‘ ê²½ë¡œ ì‚¬ìš©
            folderPath = firstFile.path;
            folderPath = folderPath.replace(/\\[^\\]*$/, ''); // íŒŒì¼ëª… ì œê±°
            folderPath = folderPath.replace(/\\/g, '/');
            resolve();
            return;
          } else {
            // file.pathê°€ ì—†ëŠ” ê²½ìš° - webkitRelativePathë¡œ í´ë”ëª… ì¶”ì¶œ í›„ ìë™ ê²½ë¡œ ìƒì„±
            let selectedFolderName = '';
            if (firstFile.webkitRelativePath) {
              const pathParts = firstFile.webkitRelativePath.split('/');
              selectedFolderName = pathParts[0];
            } else {
              // íŒŒì¼ëª…ì—ì„œ í´ë”ëª… ì¶”ì •
              selectedFolderName = firstFile.name || 'selected';
            }
            
            // í˜„ì¬ ì…ë ¥ í•„ë“œì˜ ê²½ë¡œ í™•ì¸
            const currentValue = inputElement.value.trim();
            let autoPath = '';
            
            if (currentValue && currentValue.length > 0) {
              // í˜„ì¬ ê²½ë¡œê°€ ì ˆëŒ€ ê²½ë¡œì¸ì§€ í™•ì¸
              const isAbsolute = currentValue.length >= 2 && currentValue[1] === ':';
              
              if (isAbsolute) {
                // í˜„ì¬ ê²½ë¡œê°€ ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš°, ìƒìœ„ ë””ë ‰í† ë¦¬ + ì„ íƒí•œ í´ë”ëª…
                const currentParts = currentValue.replace(/[/\\]+$/, '').split(/[/\\]/);
                const parentPath = currentParts.slice(0, -1).join('/');
                autoPath = parentPath + '/' + selectedFolderName;
              } else {
                // í˜„ì¬ ê²½ë¡œê°€ ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš°, ê¸°ë³¸ ê²½ë¡œ ì¶”ì •
                // í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì¶”ì • (ì¼ë°˜ì ì¸ êµ¬ì¡° ê°€ì •)
                autoPath = `D:/PycharmProjects/panoview/static/${selectedFolderName}`;
              }
            } else {
              // ë‹¤ë¥¸ ì…ë ¥ í•„ë“œì˜ ê²½ë¡œë¥¼ ì°¸ê³ í•˜ì—¬ ê¸°ë³¸ ê²½ë¡œ ì¶”ì •
              const otherInputs = ['imgFolderInput', 'trackFolderInput', 'pointFolderInput', 'matchFolderInput', 'tileFolderInput'];
              
              for (const otherId of otherInputs) {
                if (otherId !== inputId) {
                  const otherValue = document.getElementById(otherId)?.value.trim();
                  if (otherValue && otherValue.length > 0) {
                    const isOtherAbsolute = otherValue.length >= 2 && otherValue[1] === ':';
                    if (isOtherAbsolute) {
                      // ë‹¤ë¥¸ ì…ë ¥ í•„ë“œê°€ ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš°, ìƒìœ„ ë””ë ‰í† ë¦¬ + ì„ íƒí•œ í´ë”ëª…
                      const parts = otherValue.replace(/[/\\]+$/, '').split(/[/\\]/);
                      if (parts.length >= 2) {
                        parts.pop();
                        autoPath = parts.join('/') + '/' + selectedFolderName;
                        break;
                      }
                    } else {
                      // ë‹¤ë¥¸ ì…ë ¥ í•„ë“œë„ ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš°, ê¸°ë³¸ ê²½ë¡œ ì¶”ì •
                      autoPath = `D:/PycharmProjects/panoview/static/${selectedFolderName}`;
                      break;
                    }
                  }
                }
              }
              
              if (!autoPath) {
                // ê¸°ë³¸ ê²½ë¡œ ì¶”ì • (í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ static í´ë”)
                autoPath = `D:/PycharmProjects/panoview/static/${selectedFolderName}`;
              }
            }
            
            // ìë™ìœ¼ë¡œ ì¶”ì •í•œ ê²½ë¡œë¥¼ ì‚¬ìš© (prompt ì—†ì´)
            folderPath = autoPath;
            resolve();
          }
        } else {
          resolve();
        }
      };
      
      input.click();
    });
  }
  
  // ê²½ë¡œ ì„¤ì • (ìŠ¬ë˜ì‹œë¡œ í†µì¼)
  if (folderPath) {
    folderPath = folderPath.replace(/\\/g, '/'); // ë°±ìŠ¬ë˜ì‹œë¥¼ ìŠ¬ë˜ì‹œë¡œ í†µì¼
    console.log(`[ê²½ë¡œ ì„¤ì •] ${inputId} â†’ "${folderPath}"`);
    
    // ì…ë ¥ í•„ë“œ ë‹¤ì‹œ ì°¾ê¸° (ë¹„ë™ê¸° ì²˜ë¦¬ í›„ DOMì´ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìŒ)
    const finalInputElement = document.getElementById(inputId);
    if (!finalInputElement) {
      console.error(`âŒ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${inputId}`);
      return;
    }
    
    // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ê°’ ì„¤ì • (ê°•ì œ ì—…ë°ì´íŠ¸)
    finalInputElement.setAttribute('value', folderPath);
    finalInputElement.value = folderPath;
    
    // Native setter ê°•ì œ ì‚¬ìš©
    try {
      const descriptor = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value');
      if (descriptor && descriptor.set) {
        descriptor.set.call(finalInputElement, folderPath);
      }
    } catch (e) {
      // Native setter ì‹¤íŒ¨ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
    }
    
    // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ ë° ë³€ê²½ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
    finalInputElement.focus();
    finalInputElement.select();
    
    // ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ë¡œ ê°•ì œ ì—…ë°ì´íŠ¸
    const events = ['input', 'change'];
    events.forEach(eventType => {
      const event = new Event(eventType, { bubbles: true, cancelable: true });
      finalInputElement.dispatchEvent(event);
    });
    
    // ê°’ì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸ (í•œ ë²ˆë§Œ, ì‹¤íŒ¨ ì‹œì—ë§Œ ì¬ì‹œë„)
    let checkCount = 0;
    const maxChecks = 3;
    
    const checkValue = (isRetry = false) => {
      checkCount++;
      const actualValue = finalInputElement.value;
      
      if (actualValue === folderPath) {
        // ì„±ê³µ - í•œ ë²ˆë§Œ ë¡œê·¸ ì¶œë ¥
        if (!isRetry) {
          console.log(`âœ… ê²½ë¡œ ì„¤ì • ì„±ê³µ: "${folderPath}"`);
        }
        // ì„±ê³µ í‘œì‹œ
        finalInputElement.style.borderColor = '#4caf50';
        finalInputElement.style.borderWidth = '2px';
        setTimeout(() => {
          finalInputElement.style.borderColor = '';
          finalInputElement.style.borderWidth = '';
        }, 2000);
        return true;
      } else if (checkCount < maxChecks) {
        // ì‹¤íŒ¨ - ì¬ì‹œë„ (ì¡°ìš©íˆ)
        finalInputElement.setAttribute('value', folderPath);
        finalInputElement.value = folderPath;
          try {
            const descriptor = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value');
            if (descriptor && descriptor.set) {
              descriptor.set.call(finalInputElement, folderPath);
            }
          } catch (e) {
            // ignore
          }
          events.forEach(eventType => {
            finalInputElement.dispatchEvent(new Event(eventType, { bubbles: true }));
          });
          
          // ë‹¤ìŒ í™•ì¸ì€ ì§€ì—° í›„ ì‹¤í–‰
          setTimeout(() => checkValue(true), 100 * checkCount);
          return false;
        } else {
          // ìµœì¢… ì‹¤íŒ¨
          console.warn(`âš ï¸ ê²½ë¡œ ì„¤ì • ì‹¤íŒ¨ (ìµœì¢… ì‹œë„): ì…ë ¥ê°’="${actualValue}", ì„¤ì •ê°’="${folderPath}"`);
          return false;
        }
      };
      
    // ì¦‰ì‹œ í™•ì¸
    checkValue();
  }
}


function closePathBrowser() {
  document.getElementById('pathBrowserModal').style.display = 'none';
}

function updatePathBrowserContent() {
  const pathTypeNames = {
    'gpx': 'GPX',
    'img': 'IMG', 
    'csv': 'CSV'
  };
  
  const currentPath = currentFolderSettings[`${currentPathType}_folder`];
  const pathTypeName = pathTypeNames[currentPathType];
  
  // ëª¨ë‹¬ ì œëª© ì—…ë°ì´íŠ¸
  document.getElementById('pathBrowserTitle').textContent = `ğŸ“ ${pathTypeName} í´ë” ê²½ë¡œ íƒìƒ‰`;
  
  // í˜„ì¬ ê²½ë¡œ í‘œì‹œ
  document.getElementById('pathBrowserCurrentPath').textContent = currentPath;
  
  // ë¹ ë¥¸ ê²½ë¡œ ë²„íŠ¼ë“¤ ì—…ë°ì´íŠ¸
  const quickPaths = document.getElementById('quickPathButtons');
  quickPaths.innerHTML = '';
  
  const commonPaths = [
    { name: 'í˜„ì¬ í”„ë¡œì íŠ¸ í´ë”', path: './', desc: 'í”„ë¡œì íŠ¸ ë£¨íŠ¸ í´ë”' },
    { name: 'Static í´ë”', path: 'static/', desc: 'ì›¹ ì •ì  íŒŒì¼ í´ë”' },
    { name: 'ìƒìœ„ í´ë”', path: '../', desc: 'í”„ë¡œì íŠ¸ ìƒìœ„ í´ë”' },
    { name: 'Data í´ë”', path: 'data/', desc: 'ë°ì´í„° ì €ì¥ í´ë”' },
    { name: 'í˜„ì¬ ê²½ë¡œ ìœ ì§€', path: currentPath, desc: 'í˜„ì¬ ì„¤ì •ëœ ê²½ë¡œ' }
  ];
  
  commonPaths.forEach((item, index) => {
    const button = document.createElement('button');
    button.className = 'quick-path-btn';
    button.style.cssText = `
      padding: 10px 12px; margin: 4px; background: #f8f9fa; border: 1px solid #dee2e6; 
      border-radius: 6px; cursor: pointer; text-align: left; font-size: 0.9em; 
      transition: all 0.2s; width: 100%; display: block;
    `;
    button.innerHTML = `
      <div style="font-weight: 600; color: #333;">${item.name}</div>
      <div style="font-size: 0.8em; color: #666; margin-top: 2px;">${item.path}</div>
      <div style="font-size: 0.7em; color: #999; margin-top: 1px;">${item.desc}</div>
    `;
    
    button.onmouseover = function() {
      this.style.background = '#e3f2fd';
      this.style.borderColor = '#2196f3';
    };
    button.onmouseout = function() {
      this.style.background = '#f8f9fa';
      this.style.borderColor = '#dee2e6';
    };
    
    button.onclick = function() {
      document.getElementById('individualPathInput').value = item.path;
      closePathBrowser();
    };
    
    quickPaths.appendChild(button);
  });
}

function applyPathFromBrowser() {
  const input = document.getElementById('individualPathInput');
  const browserInput = document.getElementById('pathBrowserInput');
  
  if (browserInput.value.trim()) {
    input.value = browserInput.value.trim();
  }
  closePathBrowser();
}

async function saveIndividualPath() {
  if (!currentPathType) {
    alert('ê²½ë¡œ íƒ€ì…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    return;
  }
  
  const newPath = document.getElementById('individualPathInput').value.trim();
  if (!newPath) {
    alert('ìƒˆ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    // ì„œë²„ì— ê°œë³„ ê²½ë¡œ ì—…ë°ì´íŠ¸ ìš”ì²­
    const response = await fetch('/api/folder-settings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ...currentFolderSettings,
        [`${currentPathType}_folder`]: newPath
      })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      // ë¡œì»¬ ì„¤ì • ì—…ë°ì´íŠ¸
      currentFolderSettings[`${currentPathType}_folder`] = newPath;
      
      // localStorageì— ì €ì¥
      localStorage.setItem(FOLDER_SETTINGS_KEY, JSON.stringify(currentFolderSettings));
      localStorage.setItem(DATA_PATH_CONFIGURED_KEY, 'true');
      isDataPathConfigured = true;
      
      // console.log(`${currentPathType} í´ë” ê²½ë¡œ ì—…ë°ì´íŠ¸ë¨:`, newPath);
      alert(`${currentPathType.toUpperCase()} í´ë” ê²½ë¡œê°€ ì„±ê³µì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      closeIndividualPathModal();
      
      // UI ì—…ë°ì´íŠ¸
      updateUIForPathStatus();
      
      // ë°ì´í„°ì…‹ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      await detectAvailableDatasets();
    } else {
      alert('í´ë” ê²½ë¡œ ì„¤ì • ì‹¤íŒ¨: ' + result.error);
    }
  } catch (error) {
    console.error('ê°œë³„ í´ë” ê²½ë¡œ ì„¤ì • ì¤‘ ì˜¤ë¥˜:', error);
    alert('í´ë” ê²½ë¡œ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

/* =========================
   ë°ì´í„°ì…‹
========================= */
async function detectAvailableDatasets() {
  try {
    const res = await fetch('/api/datasets');
    if (!res.ok) throw new Error('ë°ì´í„°ì…‹ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    const response = await res.json();
    
    // ìƒˆë¡œìš´ API ì‘ë‹µ í˜•ì‹ ì²˜ë¦¬
    const data = response.success ? response.datasets : [];
    
    // ì™„ì „í•œ ë°ì´í„°ì…‹ë§Œ í‘œì‹œ (Shapefile ë°ì´í„°ì…‹ ê¸°ì¤€)
    availableDatasets = (data || []).map(d => ({
      name: d.name,
      shpFile: d.shp_file,
      hasImages: !!d.has_images,
      hasShp: !!d.has_shp,
      hasCsv: !!d.has_csv,
      isComplete: !!d.is_complete
    }));
    return availableDatasets;
  } catch (error) {
    console.error('ë°ì´í„°ì…‹ ê°ì§€ ì¤‘ ì˜¤ë¥˜:', error);
    availableDatasets = [];
    return [];
  }
}

async function loadDatasets(names, useTiles = false) {
  // console.log('=== loadDatasets í•¨ìˆ˜ í˜¸ì¶œë¨ ===');
  // console.log('ë¡œë“œí•  ë°ì´í„°ì…‹ ì´ë¦„ë“¤:', names);
  // console.log('use_tiles:', useTiles);
  
  try {
    // console.log('api/load-datasets ìš”ì²­ ì‹œì‘');
    const res = await fetch('/api/load-datasets', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        datasets: names,
        use_tiles: useTiles
      })
    });
    // console.log('ì‘ë‹µ ìƒíƒœ:', res.status);
    const data = await res.json();
    // console.log('ì‘ë‹µ ë°ì´í„°:', data);
    
    if (!res.ok || !data.success) throw new Error(data.error || 'ë¡œë“œ ì‹¤íŒ¨');
    points = data.points || [];
    console.log('í¬ì¸íŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', points.length, 'ê°œ');
    
    // íƒ€ì¼ ì •ë³´ í™•ì¸ (ì²˜ìŒ 3ê°œ í¬ì¸íŠ¸)
    if (points.length > 0) {
      console.log('[ë°ì´í„° ë¡œë“œ] ì²˜ìŒ 3ê°œ í¬ì¸íŠ¸ì˜ tile_base_url í™•ì¸:');
      for (let i = 0; i < Math.min(3, points.length); i++) {
        console.log(`  í¬ì¸íŠ¸ ${i}: tile_base_url="${points[i].tile_base_url || '(ì—†ìŒ)'}", image="${points[i].image}"`);
      }
    }

    if (miniMap) {
      // renderMarkersëŠ” asyncì´ì§€ë§Œ ë…¼ë¸”ë¡œí‚¹ìœ¼ë¡œ ì²˜ë¦¬
      // track ë¡œë“œê°€ ì™„ë£Œë˜ê¸° ì „ì— ë‹¤ë¥¸ ì‘ì—…ì´ ì‹¤í–‰ë˜ì–´ë„ ì¤‘ë‹¨ë˜ì§€ ì•Šë„ë¡
      renderMarkers().catch(err => {
        console.error('[loadDatasets] renderMarkers ì‹¤íŒ¨:', err);
      });
      
      if (points.length > 0) {
        // ì²« ë²ˆì§¸ ë…¸ë“œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì ì ˆíˆ í™•ëŒ€ëœ ìƒíƒœë¡œ ì„¤ì •
        const firstPoint = points[0];
        if (firstPoint) {
          miniMap.setView([firstPoint.lat, firstPoint.lon], 17);
        }
      }
    }
    
    // marzipanoViewer ì œê±°ëŠ” track ë¡œë“œì™€ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰
    // track ë¡œë“œê°€ ì™„ë£Œë˜ê¸° ì „ì— ì‹¤í–‰ë˜ì–´ë„ ë¬¸ì œì—†ë„ë¡
    if (marzipanoViewer) {
      marzipanoViewer.destroy(); marzipanoViewer = null; marzipanoScenes = [];
    }
    // ìë™ 0ë²ˆ í‘œì‹œ ë°©ì§€: ë™ì  íƒ€ê²Ÿì´ ìˆìœ¼ë©´ ê±´ë„ˆëœ€
    let hasTarget = false;
    try {
      if (window.targetNodeInfo && typeof window.targetNodeInfo.target_index === 'number') hasTarget = true;

      const v = `; ${document.cookie}`;
      const parts = v.split(`; target_node_id=`);
      if (parts.length === 2 && parts.pop().split(';').shift()) hasTarget = true;

      if (window._hasPendingTargetNode) hasTarget = true;

      const initId = getInitialTargetNodeId();
      if (initId) hasTarget = true;
    } catch(e) {}

    if (points.length && !hasTarget) {
      showImage(0);
      console.log('íƒ€ê²Ÿ ì—†ìŒ, ê¸°ë³¸ 0ë²ˆ í‘œì‹œ');
    }
    isLoadingDatasets = false; // í”Œë˜ê·¸ ë¦¬ì…‹
    
    // ë°ì´í„°ì…‹ ë¡œë“œ ì™„ë£Œ í›„ ì½œë°± ì‹¤í–‰
    setTimeout(() => {
      try {
        (window.__afterDatasetLoadedCallbacks || []).forEach(cb => {
          try { cb(); } catch (e) { console.error('ì½œë°± ì‹¤í–‰ ì˜¤ë¥˜:', e); }
        });
      } catch(e) { console.error('ì½œë°± ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', e); }
    }, 100);
    
    return true;
  } catch (e) {
    console.error('ë°ì´í„°ì…‹ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', e);
    alert(`ë°ì´í„°ì…‹ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
    isLoadingDatasets = false; // í”Œë˜ê·¸ ë¦¬ì…‹
    return false;
  }
}

async function showDatasetSelectionModal() {
  // ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë°ì´í„°ì…‹ì„ ì„ íƒí•˜ë„ë¡ ëª¨ë‹¬ í‘œì‹œ
  showDatasetSelectionModalOriginal();
}

function autoLoadDatasets() {
  // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
  if (isLoadingDatasets) {
    console.log('ë°ì´í„°ì…‹ ë¡œë“œê°€ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
    return;
  }
  
  // console.log('=== autoLoadDatasets í•¨ìˆ˜ í˜¸ì¶œë¨ ===');
  
  // ê²½ë¡œ ì„¤ì • í™•ì¸
  if (!isDataPathConfigured) {
    // console.log('ê²½ë¡œ ì„¤ì •ì´ ì•ˆë¨');
    alert('ë¨¼ì € ë°ì´í„° ê²½ë¡œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.\níŒŒì¼ â†’ ë°ì´í„° ê²½ë¡œ ì§€ì •');
    return;
  }
  
  isLoadingDatasets = true;
  // console.log('ê²½ë¡œ ì„¤ì • í™•ì¸ë¨, ë°ì´í„°ì…‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹œì‘');
  
  // ë°ì´í„°ì…‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  fetch('/api/datasets')
    .then(response => response.json())
    .then(data => {
      // console.log('API ì‘ë‹µ:', data); // ë””ë²„ê¹…ìš©
      
      if (data.success && data.datasets && data.datasets.length > 0) {
        // ì™„ì „í•œ ë°ì´í„°ì…‹ë§Œ í•„í„°ë§
        const completeDatasets = data.datasets.filter(ds => ds.is_complete);
        // console.log('ì™„ì „í•œ ë°ì´í„°ì…‹:', completeDatasets); // ë””ë²„ê¹…ìš©
        
        if (completeDatasets.length > 0) {
          // ì²« ë²ˆì§¸ ì™„ì „í•œ ë°ì´í„°ì…‹ì„ ìë™ìœ¼ë¡œ ë¡œë“œ
          const datasetNames = [completeDatasets[0].name];
          // console.log('ë¡œë“œí•  ë°ì´í„°ì…‹:', datasetNames); // ë””ë²„ê¹…ìš©
          // console.log('loadDatasets í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘');
          loadDatasets(datasetNames);
        } else {
          // console.log('ì™„ì „í•œ ë°ì´í„°ì…‹ì´ ì—†ìŒ');
          alert('ì‚¬ìš© ê°€ëŠ¥í•œ ì™„ì „í•œ ë°ì´í„°ì…‹ì´ ì—†ìŠµë‹ˆë‹¤.\në°ì´í„° ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
          isLoadingDatasets = false;
        }
      } else {
        // console.log('ë°ì´í„°ì…‹ ì—†ìŒ ë˜ëŠ” ì˜¤ë¥˜:', data);
        alert('ì‚¬ìš© ê°€ëŠ¥í•œ ë°ì´í„°ì…‹ì´ ì—†ìŠµë‹ˆë‹¤.\në°ì´í„° ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        isLoadingDatasets = false;
      }
    })
    .catch(error => {
      console.error('ë°ì´í„°ì…‹ ëª©ë¡ ìš”ì²­ ì˜¤ë¥˜:', error);
      alert('ë°ì´í„°ì…‹ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      isLoadingDatasets = false;
    });
}

async function showDatasetSelectionModalOriginal() {
  // ê²½ë¡œ ì„¤ì • í™•ì¸
  if (!isDataPathConfigured) {
    alert('ë¨¼ì € ë°ì´í„° ê²½ë¡œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.\níŒŒì¼ â†’ ë°ì´í„° ê²½ë¡œ ì§€ì •');
    return;
  }
  
  const modal = document.getElementById('datasetSelectionModal');
  const list = document.getElementById('datasetList');
  selectedDatasetNames.clear();
  list.innerHTML = '<div style="color:#888;padding:8px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

  // í•­ìƒ ìµœì‹  ëª©ë¡ì„ ê°€ì ¸ì˜¤ë„ë¡ ë³´ì¥
  try {
    await detectAvailableDatasets();
  } catch (e) { console.warn(e); }

  if (!availableDatasets.length) {
    list.innerHTML = '<div style="color:#888;padding:8px;">ì‚¬ìš© ê°€ëŠ¥í•œ ë°ì´í„°ì…‹ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  } else {
    const header = document.createElement('div');
    header.style.cssText = 'display:flex;gap:8px;align-items:center; margin-bottom:8px;';
    header.innerHTML =
      '<input id="dsFilter" type="text" placeholder="í•„í„°â€¦" style="flex:1;padding:6px 8px;border:1px solid #ccc;border-radius:4px;">' +
      '<label style="display:flex;align-items:center;gap:6px;font-size:0.9em;">' +
        '<input id="dsCheckAll" type="checkbox"> ì „ì²´ ì„ íƒ' +
      '</label>';
    list.appendChild(header);

    const wrap = document.createElement('div');
    wrap.id = 'dsWrap';
    list.appendChild(wrap);

    const renderRows = (rows) => {
      wrap.innerHTML = '';
      rows.forEach(ds => {
        const row = document.createElement('label');
        row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px;border:1px solid #ddd;border-radius:6px;margin:6px 0;cursor:pointer;';
        
        // ìƒíƒœ ì•„ì´ì½˜ ìƒì„±
        const statusIcons = [];
        if (ds.hasImages) statusIcons.push('ğŸ“'); // ì´ë¯¸ì§€ í´ë”
        if (ds.hasGpx) statusIcons.push('ğŸ—ºï¸'); // GPX íŒŒì¼
        if (ds.hasCsv) statusIcons.push('ğŸ“Š'); // CSV íŒŒì¼
        const statusText = statusIcons.join(' ') || 'âŒ';
        
        row.innerHTML =
          '<input type="checkbox" class="ds-check" data-name="' + ds.name + '">' +
          '<div style="font-weight:700;">' + ds.name + '</div>' +
          '<div style="color:#666;font-size:0.9em;margin-left:6px;">' + statusText + '</div>';
        wrap.appendChild(row);
      });

      wrap.querySelectorAll('.ds-check').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const name = e.target.dataset.name;
          if (e.target.checked) selectedDatasetNames.add(name);
          else selectedDatasetNames.delete(name);
        });
      });
    };

    renderRows(availableDatasets);

    header.querySelector('#dsFilter').addEventListener('input', (e) => {
      const q = e.target.value.trim().toLowerCase();
      const filtered = q
        ? availableDatasets.filter(d => d.name.toLowerCase().includes(q))
        : availableDatasets;
      renderRows(filtered);
    });

    header.querySelector('#dsCheckAll').addEventListener('change', (e) => {
      const check = e.target.checked;
      selectedDatasetNames.clear();
      wrap.querySelectorAll('.ds-check').forEach(cb => {
        cb.checked = check;
        if (check) selectedDatasetNames.add(cb.dataset.name);
      });
    });
  }
  modal.style.display = 'flex';
  closeMenus();
}

/* =========================
   ì§€ë„ í•˜ì´ë¼ì´íŠ¸ & íƒìƒ‰
========================= */
window.__gotoPoint = function(i) { showImage(i); };

function highlight(idx, angleDeg) {
  if (!points[idx]) return;
  // ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš©
  if (highlightOverlay && currentMapType === 'leaflet') miniMap.removeLayer(highlightOverlay);
  
  // angleDegëŠ” ì›ë³¸ ì´ë¯¸ì§€ ê°ë„ (ì˜¤í”„ì…‹ ë¯¸ì ìš©)
  // ìš°ì„ ìˆœìœ„ì— ë”°ë¥¸ ìµœì¢… ê°ë„ ê³„ì‚°
  const totalOffset = getTotalOffset(idx);
  const finalAngle = (angleDeg + totalOffset + 360) % 360;
  
  // CSVì˜ ì›ë³¸ angle ê°’ê³¼ ìµœì¢… ê°ë„ë¥¼ í‘œì‹œ
  const csvOriginalAngle = points[idx] ? points[idx].csv_angle : 0;
  const csvFinalAngle = points[idx] ? points[idx].final_angle : 0;
  
  // console.log(`highlight í•¨ìˆ˜ - ì´ë¯¸ì§€ ${idx}: CSVì›ë³¸ê°ë„=${csvOriginalAngle}Â°, ì‚¬ìš©ìì˜¤í”„ì…‹=${totalOffset}Â°, CSVìµœì¢…ê°ë„=${csvFinalAngle}Â°`);

  if (currentMapType === 'leaflet') {
    const fanDiv = L.divIcon({
      className: 'highlight-overlay',
      html:
        '<div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:60px;height:60px;pointer-events:none;">' +
          makeDirectionFanSVG(finalAngle, 80) +
          '<div style="position:absolute;left:18px;top:18px;width:24px;height:24px;">' +
            currentPinSVG +
          '</div>' +
        '</div>',
      iconSize: [60, 60],
      iconAnchor: [30, 30]
    });
    highlightOverlay = L.marker([points[idx].lat, points[idx].lon], {icon: fanDiv, interactive: false, zIndexOffset: 1000});
    highlightOverlay.addTo(miniMap);
  }
  // ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš©
  /*
  else if (currentMapType === 'kakao' && kakaoMap) {
    // Kakao ìª½ í•˜ì´ë¼ì´íŠ¸ëŠ” ê°„ë‹¨í•˜ê²Œ ë§ˆì»¤ ì•„ì´ì½˜ì„ êµì²´í•˜ê±°ë‚˜ ì˜¤ë²„ë ˆì´ë¡œ í™•ì¥ ê°€ëŠ¥
    // (í•„ìš”ì‹œ CustomOverlay êµ¬í˜„)
  }
  */
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  let toRad = x => x * Math.PI / 180;
  let dLat = toRad(lat2 - lat1);
  let dLon = toRad(lon2 - lon1);
  let a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function getBearing(lat1, lon1, lat2, lon2) {
  let toRad = x => x * Math.PI / 180;
  let dLon = toRad(lon2 - lon1);
  let y = Math.sin(dLon) * Math.cos(toRad(lat2));
  let x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function findClosestNodeAtDirection(currentIndex, pointsArr, maxDist, centerYawRad, relDeg) {
  let origin = pointsArr[currentIndex];
  let chosenIdx = null, minDist = maxDist + 1;
  const totalOffset = getTotalOffset(currentIndex);
  let baseDeg = ((centerYawRad * 180 / Math.PI) + relDeg + totalOffset + 360) % 360;
  pointsArr.forEach((pt, idx) => {
    if(idx === currentIndex) return;
    let dist = getDistance(origin.lat, origin.lon, pt.lat, pt.lon);
    if(dist > maxDist) return;
    let bearing = getBearing(origin.lat, origin.lon, pt.lat, pt.lon);
    let diff = ((bearing - baseDeg + 540) % 360) - 180;
    if (Math.abs(diff) > 22.5) return;
    if (dist < minDist) { minDist = dist; chosenIdx = idx; }
  });
  return chosenIdx;
}

function renderRelativeNavArrows(currentIdx, view) {
  document.querySelectorAll('.nav-arrow').forEach(el => el.remove());
  
  let centerYawRad = view.yaw();
  let dirs = [0,45,90,135,180,225,270,315].map(angle=>({angle}));
  let container = document.getElementById('viewerContainer');
  let width = container.clientWidth, height = container.clientHeight;
  let centerX = width / 2, centerY = height / 2;
  let radius = Math.min(centerX, centerY) * 0.7;
  dirs.forEach(d => {
    let nextIdx = findClosestNodeAtDirection(currentIndex, points, 18, centerYawRad, d.angle);
    if (nextIdx === null) return;
    let relRad = d.angle * Math.PI / 180;
    let x = centerX + radius * Math.sin(relRad);
    let y = centerY - radius * Math.cos(relRad);
    let btn = document.createElement('div');
    btn.className = 'nav-arrow';
    btn.style.cssText = 'position:absolute; z-index:2000; width:52px; height:52px;' +
      'background:rgba(0,0,0,0.3); border-radius:50%; display:flex; justify-content:center; align-items:center;' +
      'cursor:pointer; left:' + x + 'px; top:' + y + 'px;' +
      'box-shadow:0 4px 10px #2227; border:2px solid #dde; transform:translate(-50%,-50%);';
    
    // CSSë¡œ í™”ì‚´í‘œ ê·¸ë¦¬ê¸° (ì´ë¯¸ì§€ ë¡œë”© ì—†ìŒ)
    let arrowDiv = document.createElement('div');
    arrowDiv.className = 'nav-arrow-css';
    arrowDiv.style = 'transform:rotate(' + d.angle + 'deg);pointer-events:none;';
    btn.appendChild(arrowDiv);
    btn.onclick = ()=> showImage(nextIdx);
    container.appendChild(btn);
  });
}

function removeSelectionRect() {
  if (selectionRectDiv && selectionRectDiv.parentNode) selectionRectDiv.parentNode.removeChild(selectionRectDiv);
  selectionRectDiv = null;
}

/* =========================
  ë‚ ì§œ ì •ë³´ ì—…ë°ì´íŠ¸
========================= */
function updateLocationInfo(idx) {
  const point = points[idx];
  if (!point) return;
  
  const locationInfoDiv = document.getElementById('locationInfo');
  const dateTextDiv = document.getElementById('dateText');
  
  if (!locationInfoDiv || !dateTextDiv) return;
  
  // ë‚ ì§œ ì •ë³´ í‘œì‹œ
  if (point.date_info && point.date_info.year_month) {
    dateTextDiv.textContent = point.date_info.year_month;
  } else if (point.gpx_time) {
    // gpx_timeì—ì„œ ë…„ì›” ì¶”ì¶œ
    try {
      const datePart = point.gpx_time.split(' ')[0];
      if (datePart && datePart.includes('/')) {
        const [year, month] = datePart.split('/');
        dateTextDiv.textContent = `${year}ë…„ ${month}ì›”`;
      } else if (datePart && datePart.includes('-')) {
        const [year, month] = datePart.split('-');
        dateTextDiv.textContent = `${year}ë…„ ${month}ì›”`;
      } else {
        dateTextDiv.textContent = 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
      }
    } catch (e) {
      dateTextDiv.textContent = 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
    }
  } else {
    dateTextDiv.textContent = 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
  }
  
  // ë‚ ì§œ ì •ë³´ í‘œì‹œ
  locationInfoDiv.style.display = 'block';
}


/* =========================
  ì´ë¯¸ì§€ í‘œì‹œ(Marzipano)
========================= */
const sceneUpgradeState = {};

// ì”¬ì´ ì´ë¯¸ destroyë˜ì—ˆëŠ”ì§€ ì¶”ì 
const destroyedScenes = new WeakSet();

function safeDestroyScene(scene) {
  if (!scene) return;
  
  // ì´ë¯¸ destroyëœ ì”¬ì¸ì§€ í™•ì¸
  if (destroyedScenes.has(scene)) {
    return; // ì´ë¯¸ destroyëœ ì”¬ì€ ë¬´ì‹œ
  }
  
  try {
    // ì”¬ì´ ìœ íš¨í•œì§€ í™•ì¸ (destroy í•¨ìˆ˜ê°€ ìˆëŠ”ì§€)
    if (typeof scene.destroy === 'function') {
      // destroy í˜¸ì¶œ ì „ì— í”Œë˜ê·¸ ì„¤ì • (ë™ì‹œ í˜¸ì¶œ ë°©ì§€)
      destroyedScenes.add(scene);
      
      // destroy í˜¸ì¶œ
      scene.destroy();
    }
  } catch (e) {
    // destroy ì‹¤íŒ¨ëŠ” ì™„ì „íˆ ë¬´ì‹œ (ì´ë¯¸ destroyë˜ì—ˆê±°ë‚˜ stageì—ì„œ ì œê±°ëœ ê²½ìš°)
    // "No such layer in stage" ì˜¤ë¥˜ëŠ” ì—¬ê¸°ì„œ ë¬´ì‹œë¨
    // í”Œë˜ê·¸ëŠ” ì´ë¯¸ ì„¤ì •ë˜ì—ˆìœ¼ë¯€ë¡œ ì¬ì‹œë„ ë°©ì§€ë¨
    if (e.message && e.message.includes('No such layer')) {
      // "No such layer in stage" ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ (ì •ìƒì ì¸ ê²½ìš°)
      return;
    }
    console.warn('[ì”¬ ì œê±°] ì”¬ destroy ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨):', e.message || e);
  }
}

function replaceSceneEntry(idx, newEntry, options = {}) {
  const { activate = false, transitionDuration = 500, destroyDelay = 200 } = options;
  const oldEntry = marzipanoScenes[idx];
  marzipanoScenes[idx] = newEntry;

  // destroyOldê°€ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ í”Œë˜ê·¸ ì¶”ê°€
  let destroyOldCalled = false;
  let destroyOldTimeoutId = null;

  const destroyOld = () => {
    // ì´ë¯¸ í˜¸ì¶œë˜ì—ˆìœ¼ë©´ ë¬´ì‹œ
    if (destroyOldCalled) {
      return;
    }
    
    // timeoutì´ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì·¨ì†Œ
    if (destroyOldTimeoutId) {
      clearTimeout(destroyOldTimeoutId);
      destroyOldTimeoutId = null;
    }
    
    destroyOldCalled = true;
    
    if (!oldEntry || !oldEntry.scene || oldEntry.scene === newEntry.scene) {
      return; // ìœ íš¨í•˜ì§€ ì•Šì€ ì”¬ì´ê±°ë‚˜ ê°™ì€ ì”¬ì´ë©´ ë¬´ì‹œ
    }
    
    // switchTo()ê°€ í˜¸ì¶œë˜ë©´ Marzipanoê°€ ìë™ìœ¼ë¡œ ì´ì „ ì”¬ì„ stageì—ì„œ ì œê±°í•  ìˆ˜ ìˆìŒ
    // ë”°ë¼ì„œ destroyë¥¼ í˜¸ì¶œí•˜ê¸° ì „ì— ì¶©ë¶„í•œ ì‹œê°„ì„ ê¸°ë‹¤ë¦° í›„ ì•ˆì „í•˜ê²Œ destroy ì‹œë„
    try {
      // ì¶©ë¶„í•œ ì‹œê°„ì´ ì§€ë‚œ í›„ destroy (switchTo ì™„ë£Œ ë° ìë™ ì œê±° ëŒ€ê¸°)
      // Marzipanoê°€ ìë™ìœ¼ë¡œ ì œê±°í–ˆì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ safeDestroySceneì´ ì´ë¥¼ ì²˜ë¦¬í•¨
      destroyOldTimeoutId = setTimeout(() => {
        // ì”¬ì´ ì—¬ì „íˆ í˜„ì¬ ì”¬ì¸ì§€ í™•ì¸ (í˜„ì¬ ì”¬ì´ë©´ destroyí•˜ì§€ ì•ŠìŒ)
        try {
          if (marzipanoViewer && marzipanoViewer.scene) {
            const currentScene = marzipanoViewer.scene();
            // í˜„ì¬ ì”¬ì´ ì•„ë‹ˆë©´ ì•ˆì „í•˜ê²Œ destroy ì‹œë„
            if (currentScene !== oldEntry.scene) {
              safeDestroyScene(oldEntry.scene);
            } else {
              // í˜„ì¬ ì”¬ì´ë©´ destroyí•˜ì§€ ì•ŠìŒ (ì•„ì§ ì‚¬ìš© ì¤‘)
              console.log('[ì”¬ ì œê±°] ì”¬ì´ ì—¬ì „íˆ í˜„ì¬ ì”¬ì´ë¯€ë¡œ destroyí•˜ì§€ ì•ŠìŒ');
            }
          } else {
            // viewerê°€ ì—†ìœ¼ë©´ ì•ˆì „í•˜ê²Œ destroy ì‹œë„
            safeDestroyScene(oldEntry.scene);
          }
        } catch (e) {
          // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¡°ìš©íˆ ë¬´ì‹œ
          console.warn('[ì”¬ ì œê±°] destroyOld ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨):', e.message || e);
        }
        destroyOldTimeoutId = null;
      }, 800); // switchTo ì™„ë£Œ ë° ìë™ ì œê±° ëŒ€ê¸° (500ms -> 800msë¡œ ì¦ê°€)
    } catch (e) {
      // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¡°ìš©íˆ ë¬´ì‹œ
      console.warn('[ì”¬ ì œê±°] destroyOld ì„¤ì • ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨):', e.message || e);
    }
  };

  if (activate) {
    // ìƒˆ ì”¬ì´ ë Œë”ë§ë  ì‹œê°„ì„ ì£¼ê¸° ìœ„í•´ ìµœì†Œí•œì˜ í”„ë ˆì„ ëŒ€ê¸° (ì†ë„ ê°œì„ )
    // ì´ë¯¸ì§€ëŠ” ì´ë¯¸ í”„ë¦¬ë¡œë“œë˜ì—ˆìœ¼ë¯€ë¡œ ì”¬ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ì§§ê²Œ ëŒ€ê¸°
    let frameCount = 0;
    const maxFrames = 2; // 2í”„ë ˆì„ ëŒ€ê¸° (ì•½ 33ms, 5í”„ë ˆì„ -> 2í”„ë ˆì„ìœ¼ë¡œ ë‹¨ì¶•)
    const maxIterations = 10; // ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ ì œí•œ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
    let rafId = null;
    let isCompleted = false; // ì™„ë£Œ í”Œë˜ê·¸
    
    const checkAndSwitch = () => {
      if (isCompleted) return; // ì´ë¯¸ ì™„ë£Œë˜ì—ˆìœ¼ë©´ ì¤‘ë‹¨
      
      frameCount++;
      
      // ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ ì´ˆê³¼ ì‹œ ê°•ì œ ì¢…ë£Œ
      if (frameCount > maxIterations) {
        console.warn(`[ì”¬ ì „í™˜] ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ ì´ˆê³¼, ê°•ì œ ì¢…ë£Œ (ì¸ë±ìŠ¤: ${idx})`);
        isCompleted = true;
        try {
          if (marzipanoScenes[idx] && marzipanoScenes[idx].scene === newEntry.scene && marzipanoViewer) {
            if (!sceneUpgradeState[idx] || sceneUpgradeState[idx] === 'switching') {
              try {
                newEntry.scene.switchTo();
              } catch (switchError) {
                console.warn('[ì”¬ ì „í™˜] switchTo ì‹¤íŒ¨:', switchError);
              }
            }
          }
        } catch (e) {
          console.warn('[ì”¬ ì „í™˜] ì „í™˜ ì¤‘ ì˜¤ë¥˜:', e);
        }
        // destroyOldëŠ” ë‚´ë¶€ì—ì„œ ì¤‘ë³µ í˜¸ì¶œì„ ë°©ì§€í•˜ë¯€ë¡œ ì•ˆì „í•˜ê²Œ í˜¸ì¶œ ê°€ëŠ¥
        setTimeout(destroyOld, destroyDelay + 500);
        return;
      }
      
      if (frameCount >= maxFrames) {
        isCompleted = true; // ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì •
        // ì¶©ë¶„í•œ ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë¯€ë¡œ ì „í™˜
        try {
          if (marzipanoScenes[idx] && marzipanoScenes[idx].scene === newEntry.scene && marzipanoViewer) {
            // ì—…ê·¸ë ˆì´ë“œ ìƒíƒœ í™•ì¸ (ë‹¤ë¥¸ ê³³ì—ì„œ switchToë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šë„ë¡)
            if (!sceneUpgradeState[idx] || sceneUpgradeState[idx] === 'switching') {
              // ìƒˆ ì”¬ìœ¼ë¡œ ì „í™˜ (ì—ëŸ¬ ë°œìƒ ì‹œ ë¬´ì‹œ)
              try {
                newEntry.scene.switchTo();
              } catch (switchError) {
                // switchTo ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
                console.warn('[ì”¬ ì „í™˜] switchTo ì‹¤íŒ¨:', switchError);
              }
            }
          }
        } catch (e) {
          // ì „ì²´ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
          console.warn('[ì”¬ ì „í™˜] ì „í™˜ ì¤‘ ì˜¤ë¥˜:', e);
        }
        // ì „í™˜ì´ ì™„ë£Œëœ í›„ì— ê¸°ì¡´ ì”¬ ì œê±° (ì•ˆì •ì„±ì„ ìœ„í•´ ì¶©ë¶„í•œ ì‹œê°„ ëŒ€ê¸°)
        // destroyOldëŠ” ë‚´ë¶€ì—ì„œ ì¤‘ë³µ í˜¸ì¶œì„ ë°©ì§€í•˜ë¯€ë¡œ ì•ˆì „í•˜ê²Œ í˜¸ì¶œ ê°€ëŠ¥
        setTimeout(destroyOld, destroyDelay + 500);
      } else {
        rafId = requestAnimationFrame(checkAndSwitch);
      }
    };
    
    // ì²« í”„ë ˆì„ë¶€í„° ì‹œì‘
    rafId = requestAnimationFrame(checkAndSwitch);
  } else {
    setTimeout(destroyOld, destroyDelay);
  }
}

function upgradeScene(idx, { source, geometry, view, currentLevel, levelLabel, onComplete }) {
  if (!marzipanoViewer || !source || !geometry || !view) {
    console.warn('[íƒ€ì¼ ë¡œë“œ] ì—…ê·¸ë ˆì´ë“œ íŒŒë¼ë¯¸í„° ë¶€ì¡±, ì¤‘ë‹¨');
    return false;
  }
  if (!marzipanoScenes[idx] || !marzipanoScenes[idx].scene) {
    console.warn('[íƒ€ì¼ ë¡œë“œ] ê¸°ì¡´ ì”¬ì´ ì—†ì–´ ì—…ê·¸ë ˆì´ë“œ ë¶ˆê°€:', idx);
    return false;
  }
  if (sceneUpgradeState[idx] && sceneUpgradeState[idx] !== false) {
    console.warn(`[íƒ€ì¼ ë¡œë“œ] ì—…ê·¸ë ˆì´ë“œ ì§„í–‰ ì¤‘, ìš”ì²­ ë¬´ì‹œ - í¬ì¸íŠ¸ ${idx}`);
    return false;
  }
  sceneUpgradeState[idx] = 'upgrading';
  try {
    const isCurrentScene = currentIndex === idx;
    const newScene = marzipanoViewer.createScene({ source, geometry, view });
    const newEntry = {
      scene: newScene,
      view,
      initialFov: view.fov ? view.fov() : marzipanoScenes[idx].initialFov,
      currentLevel
    };
    
    // ì”¬ êµì²´ ì „ì— ìƒíƒœë¥¼ 'switching'ìœ¼ë¡œ ë³€ê²½
    if (isCurrentScene) {
      sceneUpgradeState[idx] = 'switching';
    }
    
    replaceSceneEntry(idx, newEntry, {
      activate: isCurrentScene,
      transitionDuration: 400, // ë¶€ë“œëŸ¬ìš´ fade ì „í™˜ (400ms)
      destroyDelay: isCurrentScene ? 100 : 50 // ì†ë„ ê°œì„ : 200/150 -> 100/50
    });
    console.log(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ ${currentLevel} ì”¬ ì¬ìƒì„± ì™„ë£Œ (ì¸ë±ìŠ¤: ${idx})`);
    if (isCurrentScene && levelLabel) {
      console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë ˆë²¨: ${levelLabel} - í¬ì¸íŠ¸ ${idx}`);
    }
    
    // ì™„ë£Œ ì½œë°± í˜¸ì¶œ (ì¦‰ì‹œ í˜¸ì¶œë¡œ ì†ë„ ê°œì„ )
    if (onComplete) {
      // setTimeout ì œê±°í•˜ì—¬ ì¦‰ì‹œ í˜¸ì¶œ (100ms -> 0ms)
      onComplete();
    }
    
    return true;
  } catch (e) {
    console.error('[íƒ€ì¼ ë¡œë“œ] ì”¬ ì—…ê·¸ë ˆì´ë“œ ì‹¤íŒ¨:', e);
    return false;
  } finally {
    // ì•½ê°„ì˜ ì§€ì—° í›„ ìƒíƒœ í•´ì œ (switchTo ë° destroy ì™„ë£Œ ëŒ€ê¸°)
    setTimeout(() => {
      sceneUpgradeState[idx] = false;
    }, 800); // destroy ì™„ë£Œê¹Œì§€ ì¶©ë¶„í•œ ì‹œê°„ ëŒ€ê¸° (600ms -> 800ms)
  }
}

// ì”¬ ìƒì„± ë¡œì§ì„ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
function createSceneForIndex(idx, prevYaw, prevPitch, hadPrevView) {
  if (!points[idx] || !points[idx].image || !marzipanoViewer) {
    return false;
  }
  
  let source;
  const tileBaseUrl = points[idx].tile_base_url;
  const img = points[idx].image;
  
  // ë””ë²„ê¹…: íƒ€ì¼ ì •ë³´ í™•ì¸ (í•­ìƒ ì¶œë ¥)
  console.log(`[íƒ€ì¼ ë¡œë“œ] í¬ì¸íŠ¸ ${idx}: tile_base_url="${tileBaseUrl || '(ì—†ìŒ)'}", image="${img}"`);
  console.log(`[íƒ€ì¼ ë¡œë“œ] í¬ì¸íŠ¸ ${idx} ì „ì²´ ë°ì´í„°:`, JSON.stringify({
    tile_base_url: tileBaseUrl,
    image: img,
    image_filename: points[idx].image_filename
  }));
  
  if (marzipanoScenes[idx]) {
    // ì´ë¯¸ ì”¬ì´ ìˆìœ¼ë©´ ë°©í–¥ë§Œ ì—…ë°ì´íŠ¸
    console.log(`[íƒ€ì¼ ë¡œë“œ] í¬ì¸íŠ¸ ${idx}: ì´ë¯¸ ì”¬ì´ ì¡´ì¬í•¨, ë°©í–¥ë§Œ ì—…ë°ì´íŠ¸`);
    marzipanoScenes[idx].view.setYaw(prevYaw);
    marzipanoScenes[idx].view.setPitch(prevPitch);
    return true;
  }
  
  // íƒ€ì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  íƒ€ì¼ì´ ìˆìœ¼ë©´ íƒ€ì¼ ì‚¬ìš©, ì—†ìœ¼ë©´ ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©
  // tile_base_urlì´ ë¹ˆ ë¬¸ìì—´ì´ê±°ë‚˜ ì—†ìœ¼ë©´ ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©
  if (tileBaseUrl && tileBaseUrl.trim() !== '' && points[idx].image && typeof Marzipano !== 'undefined') {
    // EquirectTiledImageSourceê°€ ìˆìœ¼ë©´ íƒ€ì¼ ì§ì ‘ ì‚¬ìš© (ì¹´ì¹´ì˜¤ ë¡œë“œë·° ë°©ì‹: ì €í™”ì§ˆ -> ê³ í™”ì§ˆ ì ì§„ì  ë¡œë”©)
    // ë ˆë²¨ 0ë§Œ ìˆì–´ë„ ì‘ë™ (ê³ í™”ì§ˆ ë ˆë²¨ì´ ì—†ìœ¼ë©´ ë ˆë²¨ 0ë§Œ ì‚¬ìš©)
    // Marzipano ê°ì²´ì—ì„œ íƒ€ì¼ ê´€ë ¨ í´ë˜ìŠ¤ í™•ì¸
    const marzipanoKeys = Marzipano ? Object.keys(Marzipano).filter(k => k.includes('Tile') || k.includes('Equirect') || k.includes('Image')).join(', ') : 'null';
    console.log(`[íƒ€ì¼ ë¡œë“œ] Marzipano ê°ì²´ í™•ì¸:`, typeof Marzipano, marzipanoKeys);
    
    // EquirectTiledImageSource í™•ì¸ (ë‹¤ì–‘í•œ ì´ë¦„ ì‹œë„)
    const TiledImageSource = Marzipano.EquirectTiledImageSource || 
                             Marzipano.TiledImageSource ||
                             (Marzipano.Image && Marzipano.Image.EquirectTiledSource) ||
                             null;
    
    if (TiledImageSource) {
      try {
        // íƒ€ì¼ URL í˜•ì‹: {base}/{level}/{y}/{x}.jpg
        // MarzipanoëŠ” ìë™ìœ¼ë¡œ ì €í™”ì§ˆ(level 0)ë¶€í„° ê³ í™”ì§ˆ(level 1, 2...)ë¡œ ì ì§„ì  ë¡œë”©
        // ë ˆë²¨ 0ë§Œ ìˆì–´ë„ ì‘ë™ (ê³ í™”ì§ˆ ë ˆë²¨ì´ ì—†ìœ¼ë©´ ë ˆë²¨ 0ë§Œ ì‚¬ìš©)
        const tileUrl = tileBaseUrl + "/{level}/{y}/{x}.jpg";
        console.log(`[íƒ€ì¼ ë¡œë“œ] EquirectTiledImageSource ì‚¬ìš© (ì ì§„ì  ë¡œë”©): ${tileUrl}`);
        
        // íƒ€ì¼ ì†ŒìŠ¤ ìƒì„± (ì—¬ëŸ¬ ë ˆë²¨ ì§€ì›, ë ˆë²¨ 0ë§Œ ìˆì–´ë„ ì‘ë™)
        // fromUrlì€ ë™ê¸° í•¨ìˆ˜ì´ë¯€ë¡œ ì¦‰ì‹œ ë°˜í™˜ë¨
        if (typeof TiledImageSource.fromUrl === 'function') {
          source = TiledImageSource.fromUrl(tileUrl);
        } else if (typeof TiledImageSource === 'function') {
          source = new TiledImageSource(tileUrl);
        } else {
          throw new Error('EquirectTiledImageSource.fromUrlì´ í•¨ìˆ˜ê°€ ì•„ë‹™ë‹ˆë‹¤');
        }
        
        console.log(`[íƒ€ì¼ ë¡œë“œ] âœ… EquirectTiledImageSource ìƒì„± ì„±ê³µ`);
        console.log(`[íƒ€ì¼ ë¡œë“œ] ìƒì„±ëœ source íƒ€ì…:`, source ? source.constructor.name : 'null');
        
        // íƒ€ì¼ ì†ŒìŠ¤ê°€ ì œëŒ€ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (!source) {
          throw new Error('EquirectTiledImageSourceê°€ nullì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤');
        }
        
        // íƒ€ì¼ ìš”ì²­ì´ ì‹¤ì œë¡œ ë°œìƒí•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë””ë²„ê¹…ìš©)
        // MarzipanoëŠ” ë‚´ë¶€ì ìœ¼ë¡œ íƒ€ì¼ì„ ìš”ì²­í•˜ë¯€ë¡œ, Network íƒ­ì—ì„œ í™•ì¸ ê°€ëŠ¥
        console.log(`[íƒ€ì¼ ë¡œë“œ] íƒ€ì¼ ìš”ì²­ì€ Marzipanoê°€ ìë™ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤. Network íƒ­ì—ì„œ /api/tile/... ìš”ì²­ì„ í™•ì¸í•˜ì„¸ìš”.`);
        console.log(`[íƒ€ì¼ ë¡œë“œ] ì˜ˆìƒ íƒ€ì¼ URL íŒ¨í„´: ${tileUrl}`);
      } catch (e) {
        console.error(`[íƒ€ì¼ ë¡œë“œ] âŒ EquirectTiledImageSource ìƒì„± ì‹¤íŒ¨:`, e);
        console.error(`[íƒ€ì¼ ë¡œë“œ] ì˜¤ë¥˜ ìƒì„¸:`, e.stack || e.message);
        console.warn(`[íƒ€ì¼ ë¡œë“œ] íƒ€ì¼ í•©ì„± ì´ë¯¸ì§€ë¡œ í´ë°±`);
        // íƒ€ì¼ í•©ì„± ì´ë¯¸ì§€ ì‚¬ìš© (ì ì§„ì  ë¡œë”©: ë ˆë²¨ 2 â†’ 1 â†’ 0)
        const tileCompositeBaseUrl = tileBaseUrl.replace('/api/tile/', '/api/tile-composite/');
        
        // 1ë‹¨ê³„: ì²˜ìŒì—ëŠ” ì €í•´ìƒë„(ë ˆë²¨ 2)ë¡œ ì”¬ ìƒì„±
        const level2Url = tileCompositeBaseUrl + '?level=2';
        const level1Url = tileCompositeBaseUrl + '?level=1';
        const level0Url = tileCompositeBaseUrl + '?level=0';
        
        console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š í˜„ì¬ ë ˆë²¨: 2 (ì €í•´ìƒë„) - í¬ì¸íŠ¸ ${idx}`);
        console.log(`[íƒ€ì¼ ë¡œë“œ] ì €í•´ìƒë„ ì´ë¯¸ì§€ë¡œ ì‹œì‘: ${level2Url}`);
        source = Marzipano.ImageUrlSource.fromString(level2Url);
        
        // 2ë‹¨ê³„: ë ˆë²¨ 1 í”„ë¦¬ë¡œë“œ ë° êµì²´
        const level1Img = new Image();
        level1Img.onload = function() {
          console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š ë ˆë²¨ ë³€ê²½: 2 â†’ 1 (ì¤‘í•´ìƒë„) - í¬ì¸íŠ¸ ${idx}`);
          console.log(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 1 ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ì™„ë£Œ: ${level1Url}`);
          // ì”¬ ì¬ìƒì„± (í˜„ì¬ ì”¬ì´ì–´ë„ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ìˆ˜í–‰)
          if (marzipanoScenes[idx] && marzipanoScenes[idx].scene && marzipanoViewer) {
            try {
              // í˜„ì¬ ë°©í–¥ ìœ ì§€
              const currentYaw = marzipanoScenes[idx].view.yaw();
              const currentPitch = marzipanoScenes[idx].view.pitch();
              const currentFov = marzipanoScenes[idx].view.fov();
              
              // ë ˆë²¨ 1 ì†ŒìŠ¤ ìƒì„±
              const level1Source = Marzipano.ImageUrlSource.fromString(level1Url);
              const geometry = new Marzipano.EquirectGeometry([{ width: 1, height: 1 }]);
              const view = new Marzipano.RectilinearView({ 
                yaw: currentYaw, 
                pitch: currentPitch,
                fov: currentFov
              });
              
              // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
              const totalOffset = getTotalOffset(idx);
              let rafId = null;
              view.addEventListener('change', function () {
                if (rafId === null) {
                  rafId = requestAnimationFrame(function() {
                    rafId = null;
                    renderRelativeNavArrows(idx, view);
                    const actualYaw = view.yaw() * 180 / Math.PI;
                    highlight(idx, actualYaw);
                  });
                }
              });
              
              const isCurrentScene = currentIndex === idx;
              console.log(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 1ë¡œ ì”¬ ì¬ìƒì„± ì‹œì‘ (ì¸ë±ìŠ¤: ${idx}, í˜„ì¬ ì”¬: ${isCurrentScene})`);
              upgradeScene(idx, {
                source: level1Source,
                geometry,
                view,
                currentLevel: 1,
                levelLabel: '1 (ì¤‘í•´ìƒë„)',
                onComplete: () => {
                  // 3ë‹¨ê³„: ë ˆë²¨ 0 í”„ë¦¬ë¡œë“œ ë° êµì²´ (ë ˆë²¨ 1 ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ í›„ ì‹œì‘)
                  const level0Img = new Image();
                  level0Img.onload = function() {
                    console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š ë ˆë²¨ ë³€ê²½: 1 â†’ 0 (ê³ í•´ìƒë„) - í¬ì¸íŠ¸ ${idx}`);
                    console.log(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 0 ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ì™„ë£Œ: ${level0Url}`);
                    // ì”¬ ì¬ìƒì„± (í˜„ì¬ ì”¬ì´ì–´ë„ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ìˆ˜í–‰)
                    if (marzipanoScenes[idx] && marzipanoScenes[idx].scene && marzipanoViewer) {
                      try {
                        // í˜„ì¬ ë°©í–¥ ìœ ì§€
                        const currentYaw2 = marzipanoScenes[idx].view.yaw();
                        const currentPitch2 = marzipanoScenes[idx].view.pitch();
                        const currentFov2 = marzipanoScenes[idx].view.fov();
                        
                        // ë ˆë²¨ 0 ì†ŒìŠ¤ ìƒì„±
                        const level0Source = Marzipano.ImageUrlSource.fromString(level0Url);
                        const geometry2 = new Marzipano.EquirectGeometry([{ width: 1, height: 1 }]);
                        const view2 = new Marzipano.RectilinearView({ 
                          yaw: currentYaw2, 
                          pitch: currentPitch2,
                          fov: currentFov2
                        });
                        
                        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
                        const totalOffset2 = getTotalOffset(idx);
                        let rafId2 = null;
                        view2.addEventListener('change', function () {
                          if (rafId2 === null) {
                            rafId2 = requestAnimationFrame(function() {
                              rafId2 = null;
                              renderRelativeNavArrows(idx, view2);
                              const actualYaw = view2.yaw() * 180 / Math.PI;
                              highlight(idx, actualYaw);
                            });
                          }
                        });
                        
                        // ë ˆë²¨ 0 ì—…ê·¸ë ˆì´ë“œ
                        upgradeScene(idx, {
                          source: level0Source,
                          geometry: geometry2,
                          view: view2,
                          currentLevel: 0,
                          levelLabel: '0 (ê³ í•´ìƒë„)'
                        });
                      } catch (e) {
                        console.error(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 0 êµì²´ ì‹¤íŒ¨:`, e);
                      }
                    }
                  };
                  level0Img.onerror = function() {
                    console.warn(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 0 ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ì‹¤íŒ¨: ${level0Url}`);
                  };
                  level0Img.src = level0Url;
                }
              });
            } catch (e) {
              console.error(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 1 êµì²´ ì‹¤íŒ¨:`, e);
            }
          }
        }
      };
      level1Img.onerror = function() {
        console.warn(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 1 ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ì‹¤íŒ¨: ${level1Url}`);
      };
      level1Img.src = level1Url;
    } else {
      // EquirectTiledImageSourceê°€ ì—†ìœ¼ë©´ íƒ€ì¼ í•©ì„± ì´ë¯¸ì§€ ì‚¬ìš© (ì ì§„ì  ë¡œë”©: ë ˆë²¨ 2 â†’ 1 â†’ 0)
      const tileCompositeBaseUrl = tileBaseUrl.replace('/api/tile/', '/api/tile-composite/');
      
      // 1ë‹¨ê³„: ì²˜ìŒì—ëŠ” ì €í•´ìƒë„(ë ˆë²¨ 2)ë¡œ ì”¬ ìƒì„±
      const level2Url = tileCompositeBaseUrl + '?level=2';
      const level1Url = tileCompositeBaseUrl + '?level=1';
      const level0Url = tileCompositeBaseUrl + '?level=0';
      
      console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š í˜„ì¬ ë ˆë²¨: 2 (ì €í•´ìƒë„) - í¬ì¸íŠ¸ ${idx}`);
      console.log(`[íƒ€ì¼ ë¡œë“œ] ì €í•´ìƒë„ ì´ë¯¸ì§€ë¡œ ì‹œì‘: ${level2Url}`);
      source = Marzipano.ImageUrlSource.fromString(level2Url);
      
      // 2ë‹¨ê³„: ë ˆë²¨ 1 í”„ë¦¬ë¡œë“œ ë° êµì²´
      const level1Img = new Image();
      level1Img.onload = function() {
        console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š ë ˆë²¨ ë³€ê²½: 2 â†’ 1 (ì¤‘í•´ìƒë„) - í¬ì¸íŠ¸ ${idx}`);
        console.log(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 1 ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ì™„ë£Œ: ${level1Url}`);
        // ì”¬ ì¬ìƒì„± (í˜„ì¬ ì”¬ì´ì–´ë„ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ìˆ˜í–‰)
        if (marzipanoScenes[idx] && marzipanoScenes[idx].scene && marzipanoViewer) {
          try {
            // í˜„ì¬ ë°©í–¥ ìœ ì§€
            const currentYaw = marzipanoScenes[idx].view.yaw();
            const currentPitch = marzipanoScenes[idx].view.pitch();
            const currentFov = marzipanoScenes[idx].view.fov();
            
            // ë ˆë²¨ 1 ì†ŒìŠ¤ ìƒì„±
            const level1Source = Marzipano.ImageUrlSource.fromString(level1Url);
            const geometry = new Marzipano.EquirectGeometry([{ width: 1, height: 1 }]);
            const view = new Marzipano.RectilinearView({ 
              yaw: currentYaw, 
              pitch: currentPitch,
              fov: currentFov
            });
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
            const totalOffset = getTotalOffset(idx);
            let rafId = null;
            view.addEventListener('change', function () {
              if (rafId === null) {
                rafId = requestAnimationFrame(function() {
                  rafId = null;
                  renderRelativeNavArrows(idx, view);
                  const actualYaw = view.yaw() * 180 / Math.PI;
                  highlight(idx, actualYaw);
                });
              }
            });
            
            // ë ˆë²¨ 1 ì—…ê·¸ë ˆì´ë“œ
            upgradeScene(idx, {
              source: level1Source,
              geometry,
              view,
              currentLevel: 1,
              levelLabel: '1 (ì¤‘í•´ìƒë„)',
              onComplete: () => {
                // 3ë‹¨ê³„: ë ˆë²¨ 0 í”„ë¦¬ë¡œë“œ ë° êµì²´ (ë ˆë²¨ 1 ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ í›„ ì‹œì‘)
                const level0Img = new Image();
                level0Img.onload = function() {
                  console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š ë ˆë²¨ ë³€ê²½: 1 â†’ 0 (ê³ í•´ìƒë„) - í¬ì¸íŠ¸ ${idx}`);
                  console.log(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 0 ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ì™„ë£Œ: ${level0Url}`);
                  // ì”¬ ì¬ìƒì„± (í˜„ì¬ ì”¬ì´ì–´ë„ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ìˆ˜í–‰)
                  if (marzipanoScenes[idx] && marzipanoScenes[idx].scene && marzipanoViewer) {
                    try {
                      // í˜„ì¬ ë°©í–¥ ìœ ì§€
                      const currentYaw2 = marzipanoScenes[idx].view.yaw();
                      const currentPitch2 = marzipanoScenes[idx].view.pitch();
                      const currentFov2 = marzipanoScenes[idx].view.fov();
                      
                      // ë ˆë²¨ 0 ì†ŒìŠ¤ ìƒì„±
                      const level0Source = Marzipano.ImageUrlSource.fromString(level0Url);
                      const geometry2 = new Marzipano.EquirectGeometry([{ width: 1, height: 1 }]);
                      const view2 = new Marzipano.RectilinearView({ 
                        yaw: currentYaw2, 
                        pitch: currentPitch2,
                        fov: currentFov2
                      });
                      
                      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
                      const totalOffset2 = getTotalOffset(idx);
                      let rafId2 = null;
                      view2.addEventListener('change', function () {
                        if (rafId2 === null) {
                          rafId2 = requestAnimationFrame(function() {
                            rafId2 = null;
                            renderRelativeNavArrows(idx, view2);
                            const actualYaw = view2.yaw() * 180 / Math.PI;
                            highlight(idx, actualYaw);
                          });
                        }
                      });
                      
                      // ë ˆë²¨ 0 ì—…ê·¸ë ˆì´ë“œ
                      upgradeScene(idx, {
                        source: level0Source,
                        geometry: geometry2,
                        view: view2,
                        currentLevel: 0,
                        levelLabel: '0 (ê³ í•´ìƒë„)'
                      });
                    } catch (e) {
                      console.error(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 0 êµì²´ ì‹¤íŒ¨:`, e);
                    }
                  }
                };
                level0Img.onerror = function() {
                  console.warn(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 0 ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ì‹¤íŒ¨: ${level0Url}`);
                };
                level0Img.src = level0Url;
              }
            });
          } catch (e) {
            console.error(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 1 êµì²´ ì‹¤íŒ¨:`, e);
        }
      }
    };
    level1Img.onerror = function() {
      console.warn(`[íƒ€ì¼ ë¡œë“œ] ë ˆë²¨ 1 ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ ì‹¤íŒ¨: ${level1Url}`);
    };
    level1Img.src = level1Url;
    }  // if (TiledImageSource) else ë¸”ë¡ ë
  } else {  // if (tileBaseUrl && ...) else ë¸”ë¡
      // ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©
    if (!tileBaseUrl || tileBaseUrl.trim() === '') {
      console.warn(`[íƒ€ì¼ ë¡œë“œ] âš ï¸ tile_base_urlì´ ë¹„ì–´ìˆìŒ, ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©: ${img}`);
    } else {
      console.warn(`[íƒ€ì¼ ë¡œë“œ] âš ï¸ íƒ€ì¼ ì—†ìŒ, ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©: ${img}`);
    }
      source = Marzipano.ImageUrlSource.fromString(img);
    }
    
  // EquirectTiledImageSourceë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” geometryì— íƒ€ì¼ í¬ê¸° ì •ë³´ê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ
  // íƒ€ì¼ í¬ê¸°ëŠ” 256x256ì´ë¯€ë¡œ, íƒ€ì¼ ìˆ˜ë¥¼ ê³„ì‚°í•˜ì—¬ ì „ì²´ ì´ë¯¸ì§€ í¬ê¸° ì¶”ì •
  // í•˜ì§€ë§Œ MarzipanoëŠ” ìë™ìœ¼ë¡œ íƒ€ì¼ í¬ê¸°ë¥¼ ê°ì§€í•˜ë¯€ë¡œ ê¸°ë³¸ê°’ ì‚¬ìš©
  // EquirectTiledImageSourceë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” geometryë¥¼ ìë™ ê°ì§€ ëª¨ë“œë¡œ ì„¤ì •
    let geometry = new Marzipano.EquirectGeometry([{ width: 1, height: 1 }]);
  const totalOffset = getTotalOffset(idx);
  
    // ì´ì „ ì ˆëŒ€ ë°©í–¥ì„ ìœ ì§€í•˜ê±°ë‚˜, ì²˜ìŒ ë¡œë“œí•  ë•Œë§Œ ì£¼í–‰ê°ë„ì— ë§ì¶¤
    let initialYaw;
    if (hadPrevView) {
      // ì´ì „ ë°©í–¥ì„ ìœ ì§€ (ë¯¸ë‹ˆë§µì—ì„œ ë³€ê²½ëœ ë°©í–¥ í¬í•¨, ë³¸ë„¤íŠ¸ ê°ë„ëŠ” ê³ ì •)
      initialYaw = prevYaw;
    } else {
      // ì²˜ìŒ ë¡œë“œí•  ë•Œë§Œ ì£¼í–‰ê°ë„ì— ë§ì¶¤
      initialYaw = -totalOffset * Math.PI / 180;
    }

    let view = new Marzipano.RectilinearView({ yaw: initialYaw, pitch: prevPitch });
    const initialFov = view.fov();
    // ìµœì í™”: requestAnimationFrameì„ ì‚¬ìš©í•œ throttleë¡œ ì„±ëŠ¥ ê°œì„ 
    let rafId = null;
    view.addEventListener('change', function () {
      if (rafId === null) {
        rafId = requestAnimationFrame(function() {
          rafId = null;
          renderRelativeNavArrows(idx, view);
          const actualYaw = view.yaw() * 180 / Math.PI;
          // actualYawëŠ” ì›ë³¸ ê°ë„ì´ë¯€ë¡œ ì˜¤í”„ì…‹ì„ ë”í•˜ì§€ ì•ŠìŒ
          // highlight í•¨ìˆ˜ ë‚´ì—ì„œ getTotalOffset()ìœ¼ë¡œ ì˜¤í”„ì…‹ì„ ê³„ì‚°í•¨
          highlight(idx, actualYaw);
        });
      }
    });
    // ì”¬ ìƒì„± ì‹œ ì´ˆê¸° ë ˆë²¨ ì •ë³´ ì €ì¥
    let initialLevel = null;
    if (tileBaseUrl && tileBaseUrl.trim() !== '') {
      if (source && source.constructor.name === 'EquirectTiledImageSource') {
        initialLevel = 'tile-source'; // íƒ€ì¼ ì†ŒìŠ¤ ì‚¬ìš© (ë ˆë²¨ ìë™ ê´€ë¦¬)
        console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š í˜„ì¬ ë ˆë²¨: íƒ€ì¼ ì†ŒìŠ¤ ì‚¬ìš© (ìë™ ë ˆë²¨ ê´€ë¦¬) - í¬ì¸íŠ¸ ${idx}`);
      } else {
        initialLevel = 2; // íƒ€ì¼ í•©ì„± ì´ë¯¸ì§€ì˜ ê²½ìš° ë ˆë²¨ 2ë¡œ ì‹œì‘
      }
    }
    
    marzipanoScenes[idx] = { 
      scene: marzipanoViewer.createScene({ source, geometry, view }), 
      view, 
      initialFov,
      currentLevel: initialLevel
    };
  
  // íƒ€ì¼ ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•œ ê²½ìš°, íƒ€ì¼ ìš”ì²­ì´ ë°œìƒí•˜ëŠ”ì§€ í™•ì¸
  if (tileBaseUrl && tileBaseUrl.trim() !== '' && source && source.constructor.name === 'EquirectTiledImageSource') {
    console.log(`[íƒ€ì¼ ë¡œë“œ] ì”¬ ìƒì„± ì™„ë£Œ - íƒ€ì¼ ì†ŒìŠ¤ ì‚¬ìš© ì¤‘. íƒ€ì¼ ìš”ì²­ì€ Marzipanoê°€ ìë™ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.`);
    console.log(`[íƒ€ì¼ ë¡œë“œ] Network íƒ­ì—ì„œ /api/tile/... ìš”ì²­ì´ ë‚˜íƒ€ë‚˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`);
  } else if (initialLevel === 2) {
    console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë ˆë²¨: 2 (ì €í•´ìƒë„) - í¬ì¸íŠ¸ ${idx}`);
  }
  
  return true;
}

// ë‹¤ìŒ/ì´ì „ ì”¬ì„ ë¯¸ë¦¬ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ (ì„±ëŠ¥ ê°œì„ )
function preloadScenes(currentIdx) {
  if (!marzipanoViewer || !points || points.length === 0) return;
  
  // requestIdleCallbackì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ setTimeout ì‚¬ìš©
  const schedulePreload = (callback) => {
    if (window.requestIdleCallback) {
      requestIdleCallback(callback, { timeout: 2000 });
  } else {
      setTimeout(callback, 100);
    }
  };
  
  // ë‹¤ìŒ ì”¬ ë¯¸ë¦¬ ìƒì„±
  const nextIdx = currentIdx + 1;
  if (nextIdx < points.length && points[nextIdx] && points[nextIdx].image && !marzipanoScenes[nextIdx]) {
    schedulePreload(() => {
      if (!marzipanoScenes[nextIdx] && points[nextIdx] && points[nextIdx].image) {
        const prevYaw = marzipanoScenes[currentIdx] ? marzipanoScenes[currentIdx].view.yaw() : 0;
        const prevPitch = marzipanoScenes[currentIdx] ? marzipanoScenes[currentIdx].view.pitch() : 0;
        createSceneForIndex(nextIdx, prevYaw, prevPitch, true);
      }
    });
  }
  
  // ì´ì „ ì”¬ ë¯¸ë¦¬ ìƒì„±
  const prevIdx = currentIdx - 1;
  if (prevIdx >= 0 && points[prevIdx] && points[prevIdx].image && !marzipanoScenes[prevIdx]) {
    schedulePreload(() => {
      if (!marzipanoScenes[prevIdx] && points[prevIdx] && points[prevIdx].image) {
        const prevYaw = marzipanoScenes[currentIdx] ? marzipanoScenes[currentIdx].view.yaw() : 0;
        const prevPitch = marzipanoScenes[currentIdx] ? marzipanoScenes[currentIdx].view.pitch() : 0;
        createSceneForIndex(prevIdx, prevYaw, prevPitch, true);
      }
    });
  }
}

async function showImage(idx) {
  // Marzipano ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
  if (typeof Marzipano === 'undefined') {
    console.error('Marzipano ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    alert('Marzipano ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨: í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!points[idx] || !points[idx].image) {
    console.warn('GOTO_NODE: ëŒ€ìƒ ë…¸ë“œì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤:', points[idx].track_seg_point_id);

    // ë¶€ëª¨ ì°½ì— ë…¸ë“œë¥¼ ì°¾ì§€ ëª»í–ˆë‹¤ëŠ” ë©”ì‹œì§€ ì „ì†¡
    try {
      window.parent?.postMessage(
        { type: 'NODE_NOT_FOUND', payload: { track_seg_point_id: points[idx].track_seg_point_id } },
        '*'
      );
    } catch (err) {
      console.error('NODE_NOT_FOUND ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', err);
    }
    return;
  }
  let prevYaw = 0, prevPitch = 0;
  const hadPrevView = !!marzipanoScenes[currentIndex];
  if (hadPrevView) {
    // í˜„ì¬ ë…¸ë“œì—ì„œ ë°”ë¼ë³´ë˜ ë°©í–¥ (ë¯¸ë‹ˆë§µ ë“œë˜ê·¸ë¡œ ë³€ê²½ëœ ë°©í–¥ í¬í•¨)
    prevYaw = marzipanoScenes[currentIndex].view.yaw();
    prevPitch = marzipanoScenes[currentIndex].view.pitch();
  }
  currentIndex = idx;
  
  // ë‚ ì§œ ì—…ë°ì´íŠ¸
  updateLocationInfo(idx);

  if (!marzipanoViewer) {
    marzipanoViewer = new Marzipano.Viewer(document.getElementById('viewerContainer'));
  }

  // ì”¬ ìƒì„± ë˜ëŠ” ì¬ì‚¬ìš©
  const sceneCreated = createSceneForIndex(idx, prevYaw, prevPitch, hadPrevView);
  
  if (!sceneCreated) {
    console.error(`[íƒ€ì¼ ë¡œë“œ] ì”¬ ìƒì„± ì‹¤íŒ¨: í¬ì¸íŠ¸ ${idx}`);
    return;
  }
  
  if (!marzipanoScenes[idx] || !marzipanoScenes[idx].scene) {
    console.error(`[íƒ€ì¼ ë¡œë“œ] ì”¬ì´ ìƒì„±ë˜ì§€ ì•ŠìŒ: í¬ì¸íŠ¸ ${idx}`);
    return;
  }

  // ì”¬ ì „í™˜ì„ ë¹ ë¥´ê²Œ ì²˜ë¦¬ (ì†ë„ ê°œì„ )
  // ì—…ê·¸ë ˆì´ë“œ ì¤‘ì´ë©´ ì§§ì€ ëŒ€ê¸°, ì•„ë‹ˆë©´ ì¦‰ì‹œ ì „í™˜
  const trySwitchTo = () => {
    if (sceneUpgradeState[idx] && sceneUpgradeState[idx] !== false) {
      // ì—…ê·¸ë ˆì´ë“œ ì¤‘ì´ë©´ 50ms í›„ ì¬ì‹œë„ (100ms -> 50msë¡œ ë‹¨ì¶•)
      setTimeout(trySwitchTo, 50);
      return;
    }
    
    // requestAnimationFrameì„ í•œ ë²ˆë§Œ ì‚¬ìš© (ì†ë„ ê°œì„ )
    requestAnimationFrame(() => {
      try {
        if (marzipanoScenes[idx] && marzipanoScenes[idx].scene) {
          marzipanoScenes[idx].scene.switchTo();
        }
      } catch (e) {
        // switchTo ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¬ì‹œë„ (200ms -> 50msë¡œ ë‹¨ì¶•)
        setTimeout(() => {
          try {
            if (marzipanoScenes[idx] && marzipanoScenes[idx].scene && (!sceneUpgradeState[idx] || sceneUpgradeState[idx] === false)) {
              marzipanoScenes[idx].scene.switchTo();
            }
          } catch (e2) {
            // ì¬ì‹œë„ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
          }
        }, 50);
      }
    });
  };
  
  // ì”¬ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì¦‰ì‹œ ì „í™˜ ì‹œë„
  if (marzipanoScenes[idx] && marzipanoScenes[idx].scene && (!sceneUpgradeState[idx] || sceneUpgradeState[idx] === false)) {
    try {
      marzipanoScenes[idx].scene.switchTo();
    } catch (e) {
      // ì‹¤íŒ¨í•˜ë©´ ì¼ë°˜ ê²½ë¡œë¡œ
      trySwitchTo();
    }
  } else {
    trySwitchTo();
  }
  
  // í˜„ì¬ ë ˆë²¨ ì •ë³´ í‘œì‹œ
  if (marzipanoScenes[idx] && marzipanoScenes[idx].currentLevel !== undefined) {
    const level = marzipanoScenes[idx].currentLevel;
    if (level === 'tile-source') {
      console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë ˆë²¨: íƒ€ì¼ ì†ŒìŠ¤ ì‚¬ìš© (ìë™ ë ˆë²¨ ê´€ë¦¬) - í¬ì¸íŠ¸ ${idx}`);
    } else if (level === 0) {
      console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë ˆë²¨: 0 (ê³ í•´ìƒë„) - í¬ì¸íŠ¸ ${idx}`);
    } else if (level === 1) {
      console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë ˆë²¨: 1 (ì¤‘í•´ìƒë„) - í¬ì¸íŠ¸ ${idx}`);
    } else if (level === 2) {
      console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë ˆë²¨: 2 (ì €í•´ìƒë„) - í¬ì¸íŠ¸ ${idx}`);
    } else {
      console.log(`[íƒ€ì¼ ë¡œë“œ] ğŸ“Š í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë ˆë²¨: ${level} - í¬ì¸íŠ¸ ${idx}`);
    }
  }
  
  // ì”¬ ì „í™˜ í›„ì—ë„ ì´ì „ ì ˆëŒ€ ë°©í–¥ ìœ ì§€ ë³´ì¥ (ë¯¸ë‹ˆë§µì—ì„œ ë³€ê²½ëœ ë°©í–¥ í¬í•¨)
  if (hadPrevView && marzipanoScenes[idx].view) {
    marzipanoScenes[idx].view.setYaw(prevYaw);
    marzipanoScenes[idx].view.setPitch(prevPitch);
  }
  
  if (currentMapType === 'leaflet') {
    miniMap.setView([points[idx].lat, points[idx].lon]);
  }
  // ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš©
  /*
  else if (currentMapType === 'kakao' && kakaoMap) {
    kakaoMap.setCenter(new kakao.maps.LatLng(points[idx].lat, points[idx].lon));
  }
  */

  // ì£¼ì†Œì°½ ë™ê¸°í™”
  try {
    const id = (points[idx].track_seg_point_id || '').toString().trim() || `node_${idx}`;
    const url = `${location.origin}${window.SCRIPT_ROOT}/${encodeURIComponent(id)}`;
      // í˜„ì¬ ë…¸ë“œ idë¥¼ ì¿ í‚¤ì— ì €ì¥í•´ ì„œë²„ì—ì„œ ì¡°íšŒ ê°€ëŠ¥í•˜ë„ë¡ ìœ ì§€ (ë£¨íŠ¸ ê²½ë¡œ)
      try { document.cookie = `current_node_id=${encodeURIComponent(id)}; path=/`; } catch (e) {}
      
      const PREFIX = (window.SCRIPT_ROOT || '');
      // /pano/admin í˜ì´ì§€ì¸ ê²½ìš° ë…¸ë“œ IDë¥¼ URLì— í‘œì‹œ (/pano/... í˜•ì‹)
      if (window.location.pathname.startsWith('/pano/admin')) {
        history.replaceState({ idx, id }, '', PREFIX + `/pano/${encodeURIComponent(id)}`);
      } else {
        // ì¼ë°˜ í˜ì´ì§€ëŠ” ë£¨íŠ¸ë§Œ í‘œì‹œ
        history.replaceState({ idx, id }, '', PREFIX + '/');
      }
 
      document.title = `360Â° íŒŒë…¸ë¼ë§ˆ ë§µë·°ì–´`;
  } catch (e) {
    console.warn('URL ê°±ì‹  ì‹¤íŒ¨:', e);
  }

  // í˜„ì¬ ë…¸ë“œ ì •ë³´ ì €ì¥
  window.__currentNodeInfo = {
    idx,
    id: (points[idx].track_seg_point_id || '').toString().trim() || `node_${idx}`,
    lat: points[idx].lat,
    lon: points[idx].lon
  };

  requestAnimationFrame(() => {
    renderRelativeNavArrows(idx, marzipanoScenes[idx].view);
    // ì´ì „ ë°©í–¥ì„ ìœ ì§€í•˜ë¯€ë¡œ í˜„ì¬ yaw ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    let yaw = marzipanoScenes[idx].view.yaw ? marzipanoScenes[idx].view.yaw() : 0;
    const actualYaw = yaw * 180 / Math.PI;
    highlight(idx, actualYaw);
    updateNorthOffsetInputStyle();
    
    // ì”¬ ì „í™˜ ì™„ë£Œ í›„ ë‹¤ìŒ/ì´ì „ ì”¬ ë¯¸ë¦¬ ìƒì„± (ì„±ëŠ¥ ê°œì„ )
    preloadScenes(idx);
  });
}

// ë’¤ë¡œ/ì•ìœ¼ë¡œ íƒìƒ‰ ì²˜ë¦¬
window.addEventListener('popstate', function(e) {
  const state = e.state;
  if (state && typeof state.idx === 'number') {
    showImage(state.idx);
  } else {
    // ìƒíƒœê°€ ì—†ìœ¼ë©´ í˜„ì¬ URLì—ì„œ idë¥¼ íŒŒì‹±í•´ ë§¤ì¹­ ì‹œë„
    const parts = location.pathname.split('/').filter(Boolean);
    const id = parts.length ? decodeURIComponent(parts[parts.length - 1]) : '';
    if (id && Array.isArray(points) && points.length) {
      const found = points.findIndex(p => (p.track_seg_point_id || '').toString().trim() === id);
      if (found >= 0) showImage(found);
    }
  }
});

function gotoNodeByInfo(info) {
  if (!info) return;

  const doMove = () => {
    // track_seg_point_idë¡œ idx ì°¾ê¸°
    const id = String(info.track_seg_point_id ?? '').trim();
    let idx = points.findIndex(p => String(p.track_seg_point_id ?? '').trim() === id);

    if (idx < 0 || idx >= points.length) {
      console.warn('GOTO_NODE: ëŒ€ìƒ ë…¸ë“œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', info);

      // ë¶€ëª¨ ì°½ì— ë…¸ë“œë¥¼ ì°¾ì§€ ëª»í–ˆë‹¤ëŠ” ë©”ì‹œì§€ ì „ì†¡
      try {
        window.parent?.postMessage(
          { type: 'NODE_NOT_FOUND', payload: { track_seg_point_id: id } },
          '*'
        );
      } catch (err) {
        console.error('NODE_NOT_FOUND ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', err);
      }

      return;
    }

    // ì‹¤ì œ ì´ë™
    showImage(idx);

    const nodeId = String(points[idx]?.track_seg_point_id ?? `node_${idx}`);
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        window.parent?.postMessage(
          { type: 'NODE_SHOWN', payload: { track_seg_point_id: nodeId, idx } },
          '*' 
        );
      });
    });

    // ì£¼ì†Œì°½ ì—…ë°ì´íŠ¸ (/pano/admin í˜ì´ì§€ì—ì„œë§Œ ë…¸ë“œ ID í‘œì‹œ)
    try {
      const nodeId = points[idx]?.track_seg_point_id ?? `node_${idx}`;
      
      const PREFIX = (window.SCRIPT_ROOT || '');
      // /pano/admin í˜ì´ì§€ì¸ ê²½ìš° ë…¸ë“œ IDë¥¼ URLì— í‘œì‹œ (/pano/... í˜•ì‹)
      if (window.location.pathname.startsWith('/pano/admin')) {
        history.replaceState({ idx, id: nodeId }, '', PREFIX + `/pano/${encodeURIComponent(nodeId)}`);
      } else {
        // ì¼ë°˜ í˜ì´ì§€ëŠ” ë£¨íŠ¸ë§Œ í‘œì‹œ
        history.replaceState({ idx, id: nodeId }, '', PREFIX + '/');
      }

      document.title = '360Â° íŒŒë…¸ë¼ë§ˆ ë§µë·°ì–´';
    } catch (_) {}

    // ë¯¸ë‹ˆë§µ í•˜ì´ë¼ì´íŠ¸ ë³´ì •
    if (typeof highlight === 'function') {
      const angle = points[idx]?.angle ?? 0;
      setTimeout(() => highlight(idx, angle), 300);
    }
  };

  // ë°ì´í„°ì…‹ ì•„ì§ì´ë©´ ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
  if (!Array.isArray(points) || points.length === 0) {
    registerAfterDatasetLoaded(doMove);
  } else {
    doMove();
  }
}

/* =========================
  ë©”ë‰´/ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´
========================= */
// ë©”ë‰´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ëŠ” DOMContentLoadedì—ì„œ ë“±ë¡ë¨
window.onclick = function(e){
  if (!e.target.closest('.menu-item') && !e.target.closest('.dropdown-menu')) closeMenus();
};
function closeMenus() {
  document.querySelectorAll('.dropdown-menu').forEach(menu=>menu.classList.remove('active'));
}

// North Offset ì¸í’‹ (ë©”ë‰´ ìˆ¨ê¹€ ëª¨ë“œì—ì„œëŠ” ìš”ì†Œê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°€ë“œ)
const northOffsetInputEl = document.getElementById('northOffsetInput');
if (northOffsetInputEl) northOffsetInputEl.addEventListener('input', function() {
  const newVal = parseFloat(this.value)||0;
  const delta = newVal - northOffset;
  northOffset = newVal;
  try { localStorage.setItem(NORTH_OFFSET_STORAGE_KEY, northOffset.toString()); } catch (e) {}
  if (marzipanoScenes[currentIndex]) {
    const view = marzipanoScenes[currentIndex].view;
    renderRelativeNavArrows(currentIndex, view);
    const yaw = view.yaw();
    // totalOffsetì€ highlight í•¨ìˆ˜ ë‚´ì—ì„œ getTotalOffset()ìœ¼ë¡œ ê³„ì‚°ë¨
    highlight(currentIndex, yaw * 180 / Math.PI);
    updateNorthOffsetInputStyle();
  }
});
  
const saveNorthOffsetBtnEl = document.getElementById('saveNorthOffsetBtn');
if (saveNorthOffsetBtnEl) saveNorthOffsetBtnEl.addEventListener('click', async function() {
  // ì˜µì…˜ ë©”ë‰´ ë‹«ê¸° (ì¡´ì¬í•  ë•Œë§Œ)
  const menuOptionMenuEl1 = document.getElementById('menuOptionMenu');
  if (menuOptionMenuEl1) menuOptionMenuEl1.classList.remove('active');
  const northOffsetValue = parseFloat(document.getElementById('northOffsetInput').value) || 0;
  
  // North Offsetì„ í˜„ì¬ ì„ íƒëœ ë…¸ë“œì—ë§Œ ì ìš©í•˜ê³  CSVì— ì €ì¥
  try {
    const point = points[currentIndex];
    if (point && point.dataset_name) {
      const response = await fetch('/api/save-offset', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          dataset_name: point.dataset_name,
          image_index: currentIndex,
          offset: northOffsetValue
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        // console.log(`North Offset CSV ì €ì¥ ì„±ê³µ: ${result.message}`);
        
        // points ë°°ì—´ì˜ csv_angle_addì™€ final_angle ì—…ë°ì´íŠ¸
        if (points[currentIndex]) {
          const oldAngleAdd = points[currentIndex].csv_angle_add || 0;
          points[currentIndex].csv_angle_add = northOffsetValue;  // ê¸°ì¡´ ê°’ì— ì¶”ê°€ê°€ ì•„ë‹Œ ë³€ê²½
          points[currentIndex].final_angle = parseFloat(points[currentIndex].csv_angle) + points[currentIndex].csv_angle_add;
          
          // console.log(`í˜„ì¬ ë…¸ë“œ ${currentIndex} North Offset ë³€ê²½: csv_angle=${points[currentIndex].csv_angle}Â°, ê¸°ì¡´angle_add=${oldAngleAdd}Â°, ìƒˆë¡œìš´angle_add=${northOffsetValue}Â°, final_angle=${points[currentIndex].final_angle}Â°`);
        }
        
        // North Offset ì…ë ¥ê°’ ì´ˆê¸°í™”
        document.getElementById('northOffsetInput').value = '0';
        
        // í˜„ì¬ ì´ë¯¸ì§€ì˜ ë¶€ì±„ê¼´ ì—…ë°ì´íŠ¸
        if (marzipanoScenes[currentIndex]) {
          const view = marzipanoScenes[currentIndex].view;
          renderRelativeNavArrows(currentIndex, view);
          const yaw = view.yaw();
          highlight(currentIndex, yaw * 180 / Math.PI);
          updateNorthOffsetInputStyle();
        }
        
        renderMarkers();
        alert(`North Offset ${northOffsetValue}Â°ê°€ í˜„ì¬ ë…¸ë“œ(ì´ë¯¸ì§€ ${currentIndex + 1})ì— ì ìš©ë˜ê³  CSVì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
      } else {
        console.error('North Offset CSV ì €ì¥ ì‹¤íŒ¨:', response.statusText);
        alert('North Offset ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
  } catch (error) {
    console.error('North Offset CSV ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
    alert('North Offset ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
});

// Offset ì—ë””í„°
const editPerImageOffsetsBtnEl = document.getElementById('editPerImageOffsetsBtn');
if (editPerImageOffsetsBtnEl) editPerImageOffsetsBtnEl.addEventListener('click', function() {
  // ì˜µì…˜ ë©”ë‰´ ë‹«ê¸° (ì¡´ì¬í•  ë•Œë§Œ)
  const menuOptionMenuEl2 = document.getElementById('menuOptionMenu');
  if (menuOptionMenuEl2) menuOptionMenuEl2.classList.remove('active');
  openOffsetEditor();
});
const clearOffsetsBtnEl = document.getElementById('clearOffsetsBtn');
if (clearOffsetsBtnEl) clearOffsetsBtnEl.addEventListener('click', async function() {
  // ì˜µì…˜ ë©”ë‰´ ë‹«ê¸°
  document.getElementById('menuOptionMenu').classList.remove('active');
  if (confirm('ì •ë§ë¡œ ëª¨ë“  ì˜¤í”„ì…‹ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
    await clearLocalStorageOffsets();
  }
});

document.getElementById('saveOffsetsBtn').addEventListener('click', async function() { await saveOffsets(); });
document.getElementById('cancelOffsetsBtn').addEventListener('click', function() { closeOffsetEditor(); });
document.getElementById('offsetEditorModal').addEventListener('click', function(e) { if (e.target === this) closeOffsetEditor(); });

const showNumbersBtn = document.getElementById('showImageNumbersBtn');
if (showNumbersBtn) showNumbersBtn.addEventListener('click', function() { enterNumberMode(); });

function addReturnButtonControl() {
  const ReturnControl = L.Control.extend({
    options: { position: 'topright' },
    onAdd: function (map) {
      const btn = L.DomUtil.create('button', '');
      btn.id = 'returnFromNumbersBtn';
      btn.innerText = 'ëŒì•„ê°€ê¸°';
      btn.style.cssText = 'display:none; padding:8px 12px; background:#f44336; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:0.9em;';
      L.DomEvent.on(btn, 'click', function (e) {
        L.DomEvent.stopPropagation(e);
        exitNumberMode(true);
      });
      L.DomEvent.disableClickPropagation(btn);
      return btn;
    }
  });
  miniMap.addControl(new ReturnControl());
  returnBtn = document.getElementById('returnFromNumbersBtn');
}

/* =========================
  Offset Editor helpers
========================= */
function openOffsetEditor() {
  const modal = document.getElementById('offsetEditorModal');
  const list = document.getElementById('offsetEditorContent');
  list.innerHTML = '';
  points.forEach((point, index) => {
    const offset = getPerImageOffset(index);
    const csvAngle = point.csv_angle || 0;
    const csvAngleAdd = point.csv_angle_add || 0;
    const finalAngle = point.final_angle || csvAngle;
    
    const div = document.createElement('div');
    div.style.cssText = 'display:flex; align-items:center; gap:8px; margin-bottom:10px; padding:12px; border:1px solid #ddd; border-radius:4px; background:#f9f9f9;';
    const ds = point.dataset_name || point.datasetName || '';
    const fn = point.image_filename || point.imageFile || '';
    
    div.innerHTML =
      '<input type="checkbox" class="offset-select" data-index="' + index + '" style="margin-right:6px;">' +
      '<div style="width:100px; font-weight:700; color:#333;">ì´ë¯¸ì§€ ' + (index + 1) + '</div>' +
      '<div style="flex:1; font-size:0.85em; color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">' + ds + ' / ' + fn + '</div>' +
      '<div style="display:flex; gap:8px; align-items:center;">' +
        '<div style="text-align:center; min-width:60px;">' +
          '<div style="font-size:0.75em; color:#888; margin-bottom:2px;">gpx ë°©í–¥</div>' +
          '<div style="font-size:0.9em; color:#333; font-weight:600;">' + csvAngle.toFixed(2) + 'Â°</div>' +
        '</div>' +
        '<div style="text-align:center; min-width:60px;">' +
          '<div style="font-size:0.75em; color:#888; margin-bottom:2px;">ë³´ì •ê°’</div>' +
          '<div style="font-size:0.9em; color:#0066cc; font-weight:600;">' + csvAngleAdd.toFixed(2) + 'Â°</div>' +
        '</div>' +
        '<div style="text-align:center; min-width:80px;">' +
          '<div style="font-size:0.75em; color:#888; margin-bottom:2px;">ì˜¤í”„ì…‹</div>' +
          '<input type="number" min="0" max="360" step="0.1" value=""' +
              'style="width:70px; padding:4px; border:1px solid #ccc; border-radius:4px; font-size:0.8em;"' +
              'data-index="' + index + '"><span style="color:#666; font-size:0.8em;">Â°</span>' +
        '</div>' +
      '</div>';
    
    list.appendChild(div);
    const cb = div.querySelector('.offset-select');
    if (cb && selectedIndices.has(index)) cb.checked = true;
  });
  modal.style.display = 'flex';
  closeMenus();
}

async function saveOffsets() {
  const inputs = document.querySelectorAll('#offsetEditorContent input[type="number"]');
  const prevCurrentOffset = getPerImageOffset(currentIndex);
  const angleAddValues = [];
  const imageFilenames = [];
  
  // ëª¨ë“  ì˜¤í”„ì…‹ì„ ë¹„ë™ê¸°ë¡œ ì €ì¥í•˜ê³  ë³´ì •ê°’ê³¼ CSV ê°±ì‹ 
  for (const input of inputs) {
    const index = parseInt(input.dataset.index);
    const value = parseFloat(input.value) || 0;
    const oldValue = getPerImageOffset(index);
    if (oldValue !== value) {
      // console.log(`ì´ë¯¸ì§€ ${index} ì˜¤í”„ì…‹ ë³€ê²½: ${oldValue}Â° â†’ ${value}Â°`);
      await setPerImageOffset(index, value);
      
      // ë³´ì •ê°’(angle_add)ê³¼ CSV ê°±ì‹ 
      if (points[index]) {
        points[index].csv_angle_add = value;
        points[index].final_angle = parseFloat(points[index].csv_angle) + value;
        // console.log(`ì´ë¯¸ì§€ ${index} ë³´ì •ê°’ ê°±ì‹ : csv_angle_add=${value}Â°, final_angle=${points[index].final_angle}Â°`);
        
        // CSV ì €ì¥ì„ ìœ„í•œ ë°ì´í„° ìˆ˜ì§‘
        angleAddValues.push(value);
        imageFilenames.push(points[index].image_filename || '');
      }
    }
  }
  
  // CSV íŒŒì¼ì— ì €ì¥
  if (angleAddValues.length > 0 && points.length > 0) {
    const datasetName = points[0].dataset_name;
    if (datasetName) {
      try {
        const response = await fetch(`/api/save-angle-add/${datasetName}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            angle_add_values: angleAddValues,
            image_filenames: imageFilenames
          })
        });
        
        const result = await response.json();
        if (response.ok) {
          // console.log('angle_add ê°’ì´ CSV íŒŒì¼ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:', result.message);
        } else {
          console.error('angle_add ê°’ ì €ì¥ ì‹¤íŒ¨:', result.error);
        }
      } catch (error) {
        console.error('angle_add ê°’ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
      }
    }
  }
  
  if (marzipanoScenes[currentIndex]) {
    const view = marzipanoScenes[currentIndex].view;
    const newCurrentOffset = getPerImageOffset(currentIndex);
    const delta = newCurrentOffset - prevCurrentOffset;
    if (view && typeof view.yaw === 'function' && typeof view.setYaw === 'function' && delta) {
      const oldYaw = view.yaw();
      view.setYaw(oldYaw - (delta * Math.PI / 180));
    }
    renderRelativeNavArrows(currentIndex, view);
    const yaw = view && typeof view.yaw === 'function' ? view.yaw() : 0;
    // totalOffsetì€ highlight í•¨ìˆ˜ ë‚´ì—ì„œ getTotalOffset()ìœ¼ë¡œ ê³„ì‚°ë¨
    highlight(currentIndex, yaw * 180 / Math.PI);
    updateNorthOffsetInputStyle();
  }
  selectedIndices.clear();
  renderMarkers();
  closeOffsetEditor();
}

function closeOffsetEditor() {
  document.getElementById('offsetEditorModal').style.display = 'none';
}

/* =========================
  ì§€ë„ ì „í™˜ (Leaflet/Kakao)
========================= */
function switchToLeaflet() {
  if (currentMapType === 'leaflet') return;

  // ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš©
  /*
  // ì¹´ì¹´ì˜¤ë§µ ì™„ì „ ì œê±°
  if (kakaoMap) { 
    kakaoMap = null; 
  }
  
  // ì¹´ì¹´ì˜¤ë§µ ê´€ë ¨ ìš”ì†Œë“¤ ì œê±°
  const container = document.getElementById('miniMap');
  if (container) {
    // ì¹´ì¹´ì˜¤ë§µì—ì„œ ìƒì„±í•œ í™•ëŒ€/ì¶•ì†Œ ì»¨íŠ¸ë¡¤ ì œê±°
    const kakaoZoomControl = container.querySelector('#kakao-zoom-control');
    if (kakaoZoomControl) {
      kakaoZoomControl.remove();
    }
    
    // ì¹´ì¹´ì˜¤ë§µ ê´€ë ¨ ì˜¤ë²„ë ˆì´ë“¤ ì œê±°
    if (window.kakaoTrackPolyline) {
      window.kakaoTrackPolyline.setMap(null);
      window.kakaoTrackPolyline = null;
    }
    if (window.kakaoMarkers) {
      window.kakaoMarkers.forEach(marker => marker.setMap(null));
      window.kakaoMarkers = [];
    }
  }
  */

  const center = points.length ? [points[0].lat, points[0].lon] : [37.5665, 126.9780];
  miniMap = L.map('miniMap', { center: center, zoom: 17, zoomControl: true, attributionControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(miniMap);
  miniMap.zoomControl.setPosition('topleft');

  // âœ… Viewport ê¸°ë°˜ í¬ì¸íŠ¸ fetch í•¸ë“¤ëŸ¬ ì—°ê²°
  pointsLayer = null;        // (ì¤‘ìš”) ì´ì „ ë§µ ì¸ìŠ¤í„´ìŠ¤ì˜ layerGroup ëŠê¸°
  lastFetchKey = "";
  if (mapFetchAbort) mapFetchAbort.abort();
  mapFetchAbort = null;
  attachMapFetchHandlers();
  
  // Leaflet í™•ëŒ€/ì¶•ì†Œ ì»¨íŠ¸ë¡¤ í¬ê¸° ì¡°ì •
  const leafletZoomControl = document.querySelector('.leaflet-control-zoom');
  if (leafletZoomControl) {
    leafletZoomControl.style.transform = 'scale(1.0)';
  }

  addReturnButtonControl();

  // ìš°í´ë¦­ ë©”ë‰´ ì œê±°ë¨

  currentMapType = 'leaflet';
  console.log('Leaflet ì§€ë„ë¡œ ì „í™˜ë¨');

  if (points.length) {
    renderMarkers();
    // ì²« ë²ˆì§¸ ë…¸ë“œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì ì ˆíˆ í™•ëŒ€ëœ ìƒíƒœë¡œ ì„¤ì •
    const firstPoint = points[0];
    if (firstPoint) {
      miniMap.setView([firstPoint.lat, firstPoint.lon], 17);
    }
  }
}

// ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš©
/*
async function switchToKakao() {
  if (currentMapType === 'kakao') return;

  // Leaflet ì œê±° (GPX ë°ì´í„°ëŠ” ìœ ì§€)
  if (miniMap) { 
    miniMap.remove(); 
    miniMap = null; 
  }

  try {
    await loadKakaoMapAPI();   // âœ… SDK ì¤€ë¹„ ë³´ì¥
    createKakaoMap();
    currentMapType = 'kakao';
    // console.log('ì¹´ì¹´ì˜¤ë§µìœ¼ë¡œ ì „í™˜ë¨');
    
    // GPX ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë¡œê·¸
    if (points && points.length > 0) {
      // console.log(`ì¹´ì¹´ì˜¤ë§µ ì „í™˜ í›„ GPX ë°ì´í„° ìœ ì§€: ${points.length}ê°œ í¬ì¸íŠ¸`);
    } else {
      console.warn('ì¹´ì¹´ì˜¤ë§µ ì „í™˜ í›„ GPX ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
    }
  } catch (error) {
    console.error('ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì‹¤íŒ¨:', error);
    alert('ì¹´ì¹´ì˜¤ë§µ APIë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
    switchToLeaflet();
  }
}
*/

// ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš©
/*
function createKakaoMap() {
  const container = document.getElementById('miniMap');
  const center = points.length
    ? new kakao.maps.LatLng(points[0].lat, points[0].lon)
    : new kakao.maps.LatLng(37.5665, 126.9780);
  const options = { 
    center, 
    level: 3,
    zoomControl: true, // í™•ëŒ€/ì¶•ì†Œ ì»¨íŠ¸ë¡¤ í™œì„±í™”
    zoomControlOptions: {
      position: kakao.maps.ControlPosition.TOPLEFT // ì¢Œìƒë‹¨ì— ìœ„ì¹˜
    }
  };

  kakaoMap = new kakao.maps.Map(container, options);

  // ìš°í´ë¦­ ë©”ë‰´ (page ì¢Œí‘œë¡œ ë³€í™˜)
  kakao.maps.event.addListener(kakaoMap, 'rightclick', function(mouseEvent) {
    const rect = container.getBoundingClientRect();
    const pageX = rect.left + window.scrollX + mouseEvent.point.x;
    const pageY = rect.top + window.scrollY + mouseEvent.point.y;
    showMapContextMenu({
      pageX, pageY,
      preventDefault: ()=>{}
    });
  });

  // ì¹´ì¹´ì˜¤ë§µ ì „ìš© í™•ëŒ€/ì¶•ì†Œ ì»¨íŠ¸ë¡¤ ìƒì„± (ë‹¤ë¥¸ ìš”ì†Œì— ì˜í–¥ ì—†ë„ë¡ ê²©ë¦¬)
  const zoomControl = document.createElement('div');
  zoomControl.id = 'kakao-zoom-control';
  zoomControl.style.cssText = `
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    font-family: Arial, sans-serif;
    pointer-events: auto;
  `;
  
  const zoomInBtn = document.createElement('a');
  zoomInBtn.innerHTML = '+';
  zoomInBtn.href = '#';
  zoomInBtn.style.cssText = `
    width: 32px;
    height: 32px;
    line-height: 32px;
    text-align: center;
    text-decoration: none;
    color: #000;
    font-size: 24px;
    font-weight: bold;
    background: #fff;
    border: 2px solid rgba(0,0,0,0.2);
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    display: block;
    box-sizing: border-box;
    user-select: none;
  `;
  zoomInBtn.onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    kakaoMap.setLevel(kakaoMap.getLevel() - 1);
  };
  
  const zoomOutBtn = document.createElement('a');
  zoomOutBtn.innerHTML = 'âˆ’';
  zoomOutBtn.href = '#';
  zoomOutBtn.style.cssText = `
    width: 32px;
    height: 32px;
    line-height: 32px;
    text-align: center;
    text-decoration: none;
    color: #000;
    font-size: 24px;
    font-weight: bold;
    background: #fff;
    border: 2px solid rgba(0,0,0,0.2);
    border-radius: 0 0 4px 4px;
    cursor: pointer;
    display: block;
    box-sizing: border-box;
    user-select: none;
  `;
  zoomOutBtn.onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    kakaoMap.setLevel(kakaoMap.getLevel() + 1);
  };
  
  zoomControl.appendChild(zoomInBtn);
  zoomControl.appendChild(zoomOutBtn);
  container.appendChild(zoomControl);

  // ì¹´ì¹´ì˜¤ë§µ API ê¸°ë³¸ ë§ˆí¬ëŠ” ì¢Œì¸¡í•˜ë‹¨ì— ê³ ì •ë˜ì–´ ìˆì–´ì„œ ë³„ë„ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŒ
  // ìš°ë¦¬ê°€ ë§Œë“  ë§ˆí¬ëŠ” ì œê±°í•˜ê³  ê¸°ë³¸ ë§ˆí¬ë§Œ ì‚¬ìš©

  if (points.length) {
    renderKakaoMarkers();
    const bounds = new kakao.maps.LatLngBounds();
    // ì´ë¯¸ì§€ì™€ ë§¤ì¹­ëœ í¬ì¸íŠ¸ë§Œìœ¼ë¡œ bounds ì„¤ì •
    const matchedPoints = points.filter(p => p.image && p.image.trim() !== '');
    if (matchedPoints.length > 0) {
      matchedPoints.forEach(p => bounds.extend(new kakao.maps.LatLng(p.lat, p.lon)));
    } else {
      // ë§¤ì¹­ëœ í¬ì¸íŠ¸ê°€ ì—†ìœ¼ë©´ ëª¨ë“  í¬ì¸íŠ¸ë¡œ ì„¤ì •
      points.forEach(p => bounds.extend(new kakao.maps.LatLng(p.lat, p.lon)));
    }
    kakaoMap.setBounds(bounds);
  }
}
*/

// ì¹´ì¹´ì˜¤ë§µ API ì£¼ì„ ì²˜ë¦¬ - Leafletë§Œ ì‚¬ìš©
/*
// ì¹´ì¹´ì˜¤ë§µìš© ë§ˆì»¤ ë Œë”ë§
function renderKakaoMarkers() {
  if (currentMapType !== 'kakao' || !kakaoMap) return;

  // ê¸°ì¡´ ë§ˆì»¤ì™€ ì„ ë¶„ ì œê±°
  if (window.kakaoMarkers) window.kakaoMarkers.forEach(marker => marker.setMap(null));
  if (window.kakaoTrackPolyline) window.kakaoTrackPolyline.setMap(null);
  window.kakaoMarkers = [];
  window.kakaoTrackPolyline = null;

  // Track ì„ ë¶„ ê·¸ë¦¬ê¸° (íŒŒë€ìƒ‰, ë‘ê»ê²Œ, ì•½ê°„ íˆ¬ëª…í•˜ê²Œ)
  if (points.length > 1) {
    const trackCoords = points.map(pt => new kakao.maps.LatLng(pt.lat, pt.lon));
    window.kakaoTrackPolyline = new kakao.maps.Polyline({
      path: trackCoords,
      strokeColor: '#1976d2',
      strokeWeight: 6,
      strokeOpacity: 0.7,
      strokeStyle: kakao.maps.StrokeStyle.SOLID,
      zIndex: 1000 // ë†’ì€ z-indexë¡œ ìµœìƒë‹¨ì— í‘œì‹œ
    });
    window.kakaoTrackPolyline.setMap(kakaoMap);
    
    // Track ì„ ë¶„ í´ë¦­ ì´ë²¤íŠ¸: í´ë¦­í•œ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ë…¸ë“œë¡œ ì´ë™
    kakao.maps.event.addListener(window.kakaoTrackPolyline, 'click', function(mouseEvent) {
      const clickedLatLng = mouseEvent.latLng;
      let closestIndex = 0;
      let minDistance = Infinity;
      
      points.forEach((pt, i) => {
        const distance = kakao.maps.geometry.distance(clickedLatLng, new kakao.maps.LatLng(pt.lat, pt.lon));
        if (distance < minDistance) {
          minDistance = distance;
          closestIndex = i;
        }
      });
      
      // console.log(`ì¹´ì¹´ì˜¤ë§µ Track ì„ ë¶„ í´ë¦­: ${closestIndex}ë²ˆ ë…¸ë“œë¡œ ì´ë™ (ê±°ë¦¬: ${minDistance.toFixed(1)}m)`);
      window.__gotoPoint(closestIndex);
    });
  }

  // ì´ë¯¸ì§€ì™€ ë§¤ì¹­ëœ í¬ì¸íŠ¸ë§Œ í•„í„°ë§ - ìµœì í™”: ì¸ë±ìŠ¤ ì •ë³´ë„ í•¨ê»˜ ì €ì¥ (O(nÂ²) â†’ O(n))
  const matchedPoints = [];
  points.forEach((pt, idx) => {
    if (pt.image && pt.image.trim() !== '') {
      matchedPoints.push({ point: pt, index: idx });
    }
  });

  // íˆ¬ëª…í•œ ì›í˜• ë§ˆì»¤ ìƒì„± (í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì•½ê°„ íˆ¬ëª…)
  matchedPoints.forEach(({ point: pt, index: originalIndex }) => {
    try {
      // íˆ¬ëª…í•œ ì›í˜• ì˜¤ë²„ë ˆì´ ìƒì„± (í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì•½ê°„ íˆ¬ëª…)
      const circle = new kakao.maps.Circle({
        center: new kakao.maps.LatLng(pt.lat, pt.lon),
        radius: 16, // ê¸°ë³¸ í¬ê¸°
        fillColor: '#1976d2',
        fillOpacity: 0.1, // ì•½ê°„ íˆ¬ëª… (í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡)
        strokeColor: '#1976d2',
        strokeWeight: 1, // ì–‡ì€ í…Œë‘ë¦¬
        strokeOpacity: 0.3, // ì•½ê°„ íˆ¬ëª…í•œ í…Œë‘ë¦¬
        zIndex: 500 // trackë³´ë‹¤ ë‚®ì€ z-index
      });
      circle.setMap(kakaoMap);
      
      // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
      kakao.maps.event.addListener(circle, 'click', function() { 
        // console.log(`ì¹´ì¹´ì˜¤ë§µ ë§ˆì»¤ í´ë¦­: ${originalIndex}ë²ˆ ë…¸ë“œë¡œ ì´ë™`);
        window.__gotoPoint(originalIndex); 
      });
      
      window.kakaoMarkers.push(circle);
    } catch (error) {
      console.error(`ì¹´ì¹´ì˜¤ë§µ ë§ˆì»¤ ${originalIndex} ìƒì„± ì‹¤íŒ¨:`, error);
    }
  });
}
*/

/* =========================
  ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ - ì œê±°ë¨
========================= */
// ì§€ë„ ì„ íƒ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ê¸°ëŠ¥ ì œê±°

/* =========================
  ë‹¨ì¶•/ì¤Œ/ë²ˆí˜¸ ì„ íƒ ë“±
========================= */
document.getElementById('selectAllOffsets').addEventListener('change', function() {
  const checked = this.checked;
  document.querySelectorAll('#offsetEditorContent .offset-select').forEach(cb => { cb.checked = checked; });
});

document.getElementById('applyBulkOffsetBtn').addEventListener('click', function() {
  const bulkInput = document.getElementById('bulkOffsetInput');
  const val = parseFloat(bulkInput.value);
  const bulkVal = Number.isFinite(val) ? Math.min(360, Math.max(0, val)) : 0;
  document.querySelectorAll('#offsetEditorContent .offset-select:checked').forEach(cb => {
    const row = cb.closest('div'); if (!row) return;
    const numInput = row.querySelector('input[type="number"]');
    if (numInput) numInput.value = bulkVal;
  });
});

document.getElementById('bulkOffsetInput').addEventListener('keydown', function(e){
  if (e.key === 'Enter') document.getElementById('applyBulkOffsetBtn').click();
});

const zoomInBtn = document.getElementById('zoomInBtn');
if (zoomInBtn) {
  zoomInBtn.addEventListener('click', function() {
    if (marzipanoScenes[currentIndex] && marzipanoScenes[currentIndex].view) {
      const view = marzipanoScenes[currentIndex].view;
      const currentFov = view.fov();
      view.setFov(currentFov * 0.8);
    }
  });
}

const zoomOutBtn = document.getElementById('zoomOutBtn');
if (zoomOutBtn) {
  zoomOutBtn.addEventListener('click', function() {
    if (marzipanoScenes[currentIndex] && marzipanoScenes[currentIndex].view) {
      const view = marzipanoScenes[currentIndex].view;
      const currentFov = view.fov();
      const initialFov = marzipanoScenes[currentIndex].initialFov;
      let newFov = currentFov * 1.25;
      if (initialFov) newFov = Math.min(newFov, initialFov);
      view.setFov(newFov);
    }
  });
}

// ë²ˆí˜¸ ëª¨ë“œ
function enterNumberMode() {
  showImageNumbers = true;
  const mm = document.getElementById('miniMap');
  try {
    const cs = window.getComputedStyle(mm);
    prevMiniMapSize = { width: parseInt(cs.width) || 300, height: parseInt(cs.height) || 300 };
  } catch (e) {}
  mm.style.width = '700px';
  mm.style.height = '700px';
  if (miniMap) setTimeout(()=> miniMap.invalidateSize(), 0);
  attachSelectionHandlers();
  renderMarkers();
  if (returnBtn) returnBtn.style.display = 'block';
  closeOffsetEditor();
}
function exitNumberMode(goBackToEditor) {
  showImageNumbers = false;
  const mm = document.getElementById('miniMap');
  mm.style.width = prevMiniMapSize.width + 'px';
  mm.style.height = prevMiniMapSize.height + 'px';
  if (miniMap) setTimeout(()=> miniMap.invalidateSize(), 0);
  detachSelectionHandlers();
  removeSelectionRect();
  renderMarkers();
  if (returnBtn) returnBtn.style.display = 'none';
  if (goBackToEditor) openOffsetEditor();
}

function attachSelectionHandlers() {
  if (!miniMap) return;
  const container = miniMap.getContainer();
  if (!container) return;
  container.addEventListener('mousedown', onMiniMapMouseDown, true);
  container.addEventListener('mousemove', onMiniMapMouseMove, true);
  window.addEventListener('mouseup', onMiniMapMouseUp, true);
}

function detachSelectionHandlers() {
  if (!miniMap) return;
  const container = miniMap.getContainer();
  if (!container) return;
  container.removeEventListener('mousedown', onMiniMapMouseDown, true);
  container.removeEventListener('mousemove', onMiniMapMouseMove, true);
  window.removeEventListener('mouseup', onMiniMapMouseUp, true);
}

function onMiniMapMouseDown(e) {
  if (!showImageNumbers) return;
  if (e.button !== 0) return;
  if (!(e.ctrlKey || e.metaKey)) return;
  if (!miniMap) return;
  const container = miniMap.getContainer();
  if (!container) return;
  if (miniMap.dragging) miniMap.dragging.disable();
  e.preventDefault(); e.stopPropagation();
  const rect = container.getBoundingClientRect();
  selectionStartPt = { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

// ìµœì í™”: ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸ throttleì„ ìœ„í•œ ë³€ìˆ˜
let mouseMoveRafId = null;
function onMiniMapMouseMove(e) {
  if (!showImageNumbers || !selectionStartPt) return;
  if (!miniMap) return;
  e.preventDefault(); e.stopPropagation();
  
  // ìµœì í™”: requestAnimationFrameì„ ì‚¬ìš©í•œ throttle
  if (mouseMoveRafId === null) {
    mouseMoveRafId = requestAnimationFrame(function() {
      mouseMoveRafId = null;
      if (!miniMap) return;
      const container = miniMap.getContainer();
      if (!container) return;
      const rect = container.getBoundingClientRect();
      const curr = { x: e.clientX - rect.left, y: e.clientY - rect.top };
      drawSelectionRect(selectionStartPt, curr);
      const x1 = Math.min(selectionStartPt.x, curr.x);
      const y1 = Math.min(selectionStartPt.y, curr.y);
      const x2 = Math.max(selectionStartPt.x, curr.x);
      const y2 = Math.max(selectionStartPt.y, curr.y);
      tempSelectionIndices = new Set();
      points.forEach((pt, i) => {
        const p = miniMap.latLngToContainerPoint([pt.lat, pt.lon]);
        if (p.x >= x1 && p.x <= x2 && p.y >= y1 && p.y <= y2) tempSelectionIndices.add(i);
      });
      renderMarkers();
    });
  }
}

function onMiniMapMouseUp(e) {
  if (!showImageNumbers || !selectionStartPt) return;
  if (!miniMap) return;
  const container = miniMap.getContainer();
  if (!container) return;
  e.preventDefault(); e.stopPropagation();
  const rect = container.getBoundingClientRect();
  const end = { x: e.clientX - rect.left, y: e.clientY - rect.top };
  const x1 = Math.min(selectionStartPt.x, end.x);
  const y1 = Math.min(selectionStartPt.y, end.y);
  const x2 = Math.max(selectionStartPt.x, end.x);
  const y2 = Math.max(selectionStartPt.y, end.y);
  const insideIndices = [];
  points.forEach((pt, i) => {
    const p = miniMap.latLngToContainerPoint([pt.lat, pt.lon]);
    if (p.x >= x1 && p.x <= x2 && p.y >= y1 && p.y <= y2) insideIndices.push(i);
  });
  if (insideIndices.length) {
    insideIndices.forEach(i => {
      if (selectedIndices.has(i)) selectedIndices.delete(i); else selectedIndices.add(i);
    });
  }
  removeSelectionRect();
  selectionStartPt = null;
  tempSelectionIndices.clear();
  if (miniMap.dragging) miniMap.dragging.enable();
  renderMarkers();
}

function drawSelectionRect(start, end) {
  if (!miniMap) return;
  const container = miniMap.getContainer();
  if (!container) return;
  if (!selectionRectDiv) {
    selectionRectDiv = document.createElement('div');
    selectionRectDiv.style.cssText = 'position:absolute;border:2px dashed #1976d2;background:rgba(25,118,210,0.15);pointer-events:none;z-index:2000;';
    container.appendChild(selectionRectDiv);
  }
  const x = Math.min(start.x, end.x);
  const y = Math.min(start.y, end.y);
  const w = Math.abs(end.x - start.x);
  const h = Math.abs(end.y - start.y);
  selectionRectDiv.style.left = x + 'px';
  selectionRectDiv.style.top = y + 'px';
  selectionRectDiv.style.width = w + 'px';
  selectionRectDiv.style.height = h + 'px';
}

/* =========================
  ì´ˆê¸° ë¡œë“œ/ì´ë²¤íŠ¸ ë°”ì¸ë”©
========================= */
$(function() {
  try {
    const stored = localStorage.getItem(NORTH_OFFSET_STORAGE_KEY);
    if (stored !== null) {
      const parsed = parseFloat(stored);
      if (!Number.isNaN(parsed)) {
        northOffset = parsed;
        const inputEl = document.getElementById('northOffsetInput');
        if (inputEl) inputEl.value = String(northOffset);
      }
    }
    const storedPerImage = localStorage.getItem(PER_IMAGE_OFFSETS_STORAGE_KEY);
    if (storedPerImage !== null) {
      const parsed = JSON.parse(storedPerImage);
      if (parsed && typeof parsed === 'object') perImageOffsets = parsed;
    }
  } catch (e) {}
  
  // í´ë” ì„¤ì • ë¡œë“œ
  //loadFolderSettings().then(() => {
    // console.log('ì´ˆê¸° í´ë” ì„¤ì • ë¡œë“œ ì™„ë£Œ');
  //});

  // ì„œë²„ì—ì„œ ì „ë‹¬ëœ points ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‚¬ìš© (ë¡œë”© ì§€ì—° ì—†ìŒ)
  {% if points is defined and points|length > 0 %}
  points = {{ points | tojson }};
  console.log('ì„œë²„ì—ì„œ ì „ë‹¬ëœ points ë°ì´í„° ì¦‰ì‹œ ì‚¬ìš©:', points.length, 'ê°œ');
  
  // ì¦‰ì‹œ ì´ˆê¸°í™” (API í˜¸ì¶œ ì—†ì´)
  let center = points.length ? [points[0].lat, points[0].lon] : [37.5665, 126.9780];
  miniMap = L.map('miniMap', { center: center, zoom: 17, zoomControl: true, attributionControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(miniMap);
  miniMap.zoomControl.setPosition('topleft');

  pointsLayer = null;
  lastFetchKey = "";
  if (mapFetchAbort) mapFetchAbort.abort();
  mapFetchAbort = null;
  attachMapFetchHandlers();
  
  const leafletZoomControl = document.querySelector('.leaflet-control-zoom');
  if (leafletZoomControl) {
    leafletZoomControl.style.transform = 'scale(1.0)';
  }

  addReturnButtonControl();
  // ìš°í´ë¦­ ë©”ë‰´ ì œê±°ë¨

  if (points.length) {
    renderMarkers();
    // ì²« ë²ˆì§¸ ë…¸ë“œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì ì ˆíˆ í™•ëŒ€ëœ ìƒíƒœë¡œ ì„¤ì •
    const firstPoint = points[0];
    if (firstPoint) {
      miniMap.setView([firstPoint.lat, firstPoint.lon], 17);
    }
    
    let startIdx = 0;
    {% if target_point and target_index is defined %}
    window.targetNodeInfo = {
      track_seg_point_id: '{{ track_seg_point_id }}',
      target_index: {{ target_index }},
      target_point: {{ target_point | tojson }}
    };
    const id = (window.targetNodeInfo.track_seg_point_id || '').toString().trim();
    const found = points.findIndex(p => (p.track_seg_point_id || '').toString().trim() === id);
    if (found >= 0) startIdx = found;
    {% else %}
    const firstImageIndex = points.findIndex(p => p.image && p.image.trim() !== '');
    if (firstImageIndex >= 0) {
      startIdx = firstImageIndex;
    }
    {% endif %}
    // ì´ë¯¸ì§€ í”„ë¦¬ë¡œë”©ê³¼ ë™ì‹œì— ì¦‰ì‹œ í‘œì‹œ
    if (points[startIdx] && points[startIdx].image) {
      const imgUrl = points[startIdx].image;
      const preloadImg = new Image();
      preloadImg.src = imgUrl;
    }
    const initId = getInitialTargetNodeId();
    if (initId) {
      window._hasPendingTargetNode = true;
      gotoNodeByInfo({ track_seg_point_id: initId });
    } else {
      showImage(startIdx);
    }
    setTimeout(updateNorthOffsetInputStyle, 100);
  }
  {% else %}
  // ì„œë²„ì—ì„œ ì´ˆê¸° pointsë¥¼ ì£¼ì§€ ì•Šì€ ê²½ìš°: ì „ì²´ pointsë¥¼ ë¨¼ì € ë‹¹ê¸°ì§€ ì•Šê³  viewport ê¸°ë°˜ fetchë¡œ ì‹œì‘
  points = [];
  const center = [37.5665, 126.9780];
  miniMap = L.map('miniMap', { center: center, zoom: 17, zoomControl: true, attributionControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(miniMap);
  miniMap.zoomControl.setPosition('topleft');

  pointsLayer = null;
  lastFetchKey = "";
  if (mapFetchAbort) mapFetchAbort.abort();
  mapFetchAbort = null;
  attachMapFetchHandlers();

  const leafletZoomControl = document.querySelector('.leaflet-control-zoom');
  if (leafletZoomControl) {
    leafletZoomControl.style.transform = 'scale(1.0)';
  }

  addReturnButtonControl();

  const initId = getInitialTargetNodeId();
  if (initId) {
    window._hasPendingTargetNode = true;

    // í•„ìš”í•œ ë…¸ë“œ 1ê±´ë§Œ ìš”ì²­í•´ì„œ ì´ˆê¸° í‘œì‹œ (full points ë‹¤ìš´ë¡œë“œ ì œê±°)
    fetch(`/api/point/${encodeURIComponent(initId)}`)
      .then(res => res.json())
      .then(data => {
        if (!data || !data.success || !data.point) {
          console.warn('[init target] point ë¡œë“œ ì‹¤íŒ¨, /pano/<id>ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          if (!location.pathname.startsWith('/pano/')) {
            window.location.href = `/pano/${encodeURIComponent(initId)}`;
          }
          return;
        }

        points = [data.point];
        triggerTrackLineLoadFromPoints();
        showImage(0);
      })
      .catch(err => {
        console.error('[init target] point preload ì‹¤íŒ¨:', err);
        if (!location.pathname.startsWith('/pano/')) {
          window.location.href = `/pano/${encodeURIComponent(initId)}`;
        }
      });
  } else {
    // ë£¨íŠ¸(/) ì§„ì… ì‹œ: active ìƒíƒœì—ì„œ ì²« í‘œì‹œìš© point 1ê±´ë§Œ ë°›ì•„ ì´ˆê¸° í™”ë©´ì„ êµ¬ì„±
    fetch('/api/active-bootstrap')
      .then(res => res.json())
      .then(data => {
        if (!data || !data.success || !data.has_points || !data.point) {
          console.log('ì´ˆê¸° ë°ì´í„° ì—†ìŒ. ë©”ë‰´ì—ì„œ ë°ì´í„°ì…‹ì„ ë¡œë“œí•˜ì„¸ìš”.');
          return;
        }

        points = [data.point];
        triggerTrackLineLoadFromPoints();

        const lat = Number(data.point.lat);
        const lon = Number(data.point.lon);
        if (!Number.isNaN(lat) && !Number.isNaN(lon)) {
          miniMap.setView([lat, lon], 17);
        }

        showImage(0);
        scheduleFetchByMap(0);
      })
      .catch(err => {
        console.error('[root init] bootstrap ì‹¤íŒ¨:', err);
      });
  }
  {% endif %}
});

// í‚¤ë³´ë“œ íƒìƒ‰
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey || e.altKey || e.metaKey || e.repeat) return;
  if (Object.keys(keysPressed).length > 0) return;
  const code = e.code;
  if (!(code in codeToDeg) || currentHeldKey === code) return;
  e.preventDefault();
  currentHeldKey = code;
  keysPressed[code] = true;
  const relDeg = codeToDeg[code];
  const tryMove = () => {
    if (!marzipanoScenes[currentIndex]) return;
    const view = marzipanoScenes[currentIndex].view;
    const centerYawRad = view.yaw();
    const nextIdx = findClosestNodeAtDirection(currentIndex, points, 18, centerYawRad, relDeg);
    if (nextIdx !== null) showImage(nextIdx);
  };
  tryMove();
  keyHoldInterval = setInterval(tryMove, 300);
});
document.addEventListener('keyup', function(e) {
  const code = e.code;
  delete keysPressed[code];
  if (keyHoldInterval) clearInterval(keyHoldInterval);
  keyHoldInterval = null;
  currentHeldKey = null;
});

// localStorage ì´ˆê¸°í™” í•¨ìˆ˜ - CSV ì›ë³¸ angle ê°’ìœ¼ë¡œ ë³µì›
async function clearLocalStorageOffsets() {
  try {
    // localStorage ì´ˆê¸°í™”
    localStorage.removeItem(PER_IMAGE_OFFSETS_STORAGE_KEY);
    perImageOffsets = {};
    // console.log('localStorage ì˜¤í”„ì…‹ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    
    // CSV íŒŒì¼ì˜ angle_add ì»¬ëŸ¼ì„ ëª¨ë‘ 0ìœ¼ë¡œ ì´ˆê¸°í™”
    if (points.length > 0) {
      const point = points[0];
      if (point && point.dataset_name) {
        const response = await fetch('/api/clear-angle-add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            dataset_name: point.dataset_name
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          // console.log(`CSV ì´ˆê¸°í™” ì„±ê³µ: ${result.message}`);
          
          // points ë°°ì—´ì˜ final_angleë„ ì›ë³¸ angle ê°’ìœ¼ë¡œ ë³µì›
          points.forEach((pt, idx) => {
            if (pt.dataset_name === point.dataset_name) {
              pt.csv_angle_add = 0;  // ìˆ«ì 0ìœ¼ë¡œ ì„¤ì •
              pt.final_angle = parseFloat(pt.csv_angle);  // ì›ë³¸ angle ê°’
              // console.log(`ì´ë¯¸ì§€ ${idx} ì´ˆê¸°í™”: csv_angle_add=${pt.csv_angle_add}, final_angle=${pt.final_angle}Â°`);
            }
          });
          
          alert('CSV íŒŒì¼ê³¼ localStorageê°€ ëª¨ë‘ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë¶€ì±„ê¼´ì´ ì›ë³¸ ê°ë„ë¡œ ë³µì›ë©ë‹ˆë‹¤.');
          
          // í˜„ì¬ ì´ë¯¸ì§€ì˜ ë¶€ì±„ê¼´ ì—…ë°ì´íŠ¸
          if (marzipanoScenes[currentIndex]) {
            const view = marzipanoScenes[currentIndex].view;
            const yaw = view.yaw();
            highlight(currentIndex, yaw * 180 / Math.PI);
          }
        } else {
          console.error('CSV ì´ˆê¸°í™” ì‹¤íŒ¨:', response.statusText);
          alert('localStorageëŠ” ì´ˆê¸°í™”ë˜ì—ˆì§€ë§Œ CSV ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }
    }
  } catch (e) {
    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
    alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function loadTrackLineFromShapefile(datasetName) {
  // Track Shapefileì—ì„œ ë¼ì¸ ë°ì´í„° ë¡œë“œ
  if (!datasetName) {
    console.warn('[Track ë¼ì¸] ë°ì´í„°ì…‹ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!miniMap) {
    console.warn('[Track ë¼ì¸] ë¯¸ë‹ˆë§µì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
  if (window._trackLineLoading && window._trackLineLoading === datasetName) {
    console.log(`[Track ë¼ì¸] ì´ë¯¸ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤: ${datasetName}`);
    return;
  }
  
  window._trackLineLoading = datasetName;
  
  try {
    console.log(`[Track ë¼ì¸] ë¡œë“œ ì‹œë„: ${datasetName}`);
    
    // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ë‹¤ë¥¸ ì´ˆê¸°í™” ì‘ì—…ì´ ì™„ë£Œë˜ë„ë¡ í•¨
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // miniMapì´ ì—¬ì „íˆ ìœ íš¨í•œì§€ ë‹¤ì‹œ í™•ì¸
    if (!miniMap || !miniMap._container) {
      console.warn('[Track ë¼ì¸] ë¯¸ë‹ˆë§µì´ ë” ì´ìƒ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      window._trackLineLoading = null;
      return;
    }
    
    const response = await fetch(`/api/track-line/${encodeURIComponent(datasetName)}`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Cache-Control': 'no-cache'
      },
      cache: 'no-cache'
    });
    
    console.log(`[Track ë¼ì¸] API ì‘ë‹µ ìƒíƒœ: ${response.status}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('[Track ë¼ì¸] API ì‘ë‹µ ë°ì´í„°:', data);
    console.log('[Track ë¼ì¸] ì‘ë‹µ ìƒì„¸:', {
      success: data.success,
      linesCount: data.lines ? data.lines.length : 0,
      count: data.count,
      error: data.error,
      warning: data.warning,
      datasetName: data.dataset_name
    });
    
    // ë¡œë”© í”Œë˜ê·¸ í•´ì œ
    window._trackLineLoading = null;
    
    if (data.error) {
      console.warn(`[Track ë¼ì¸] ì˜¤ë¥˜: ${data.error}`);
      if (data.warning) {
        console.warn(`[Track ë¼ì¸] ê²½ê³ : ${data.warning}`);
      }
      return;
    }
    
    if (data.success && data.lines && data.lines.length > 0) {
      console.log(`[Track ë¼ì¸] âœ… ${data.lines.length}ê°œ ë¼ì¸ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤. ë¯¸ë‹ˆë§µì— ì¶”ê°€ ì‹œì‘...`);
      // miniMapì´ ì—¬ì „íˆ ìœ íš¨í•œì§€ í™•ì¸
      if (!miniMap || !miniMap._container) {
        console.warn('[Track ë¼ì¸] ë¯¸ë‹ˆë§µì´ ë” ì´ìƒ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ê¸°ì¡´ track polyline ì œê±°
      if (window.trackPolyline && miniMap) {
        try {
          miniMap.removeLayer(window.trackPolyline);
        } catch (e) {
          console.warn('[Track ë¼ì¸] ê¸°ì¡´ polyline ì œê±° ì‹¤íŒ¨:', e);
        }
        window.trackPolyline = null;
      }
      
      // ê° ë¼ì¸ì„ ë¯¸ë‹ˆë§µì— ì¶”ê°€
      data.lines.forEach((line, index) => {
        if (!line.coordinates || !Array.isArray(line.coordinates) || line.coordinates.length === 0) {
          console.warn(`[Track ë¼ì¸] ë¼ì¸ ${index}ì˜ ì¢Œí‘œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
          return;
        }
        
        try {
          // miniMapì´ ì—¬ì „íˆ ìœ íš¨í•œì§€ ë‹¤ì‹œ í™•ì¸
          if (!miniMap || !miniMap._container) {
            console.warn('[Track ë¼ì¸] ë¯¸ë‹ˆë§µì´ ë” ì´ìƒ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
          }
          
          const polyline = L.polyline(line.coordinates, {
            color: '#1976d2',
            weight: 6,
            opacity: 0.7,  // âœ… ë³´ì´ë„ë¡ ì„¤ì • (0.7 = 70% ë¶ˆíˆ¬ëª…ë„)
            fillOpacity: 0.3,
            interactive: true,  // í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡
            pane: 'overlayPane'  // ë‹¤ë¥¸ ë ˆì´ì–´ ìœ„ì— í‘œì‹œ
          }).addTo(miniMap);
          
          // z-indexë¥¼ ë†’ì—¬ì„œ ë‹¤ë¥¸ ë ˆì´ì–´ ìœ„ì— í‘œì‹œ
          if (polyline._path) {
            polyline._path.style.zIndex = '1000';
          }
          
          // polylineì´ ì‹¤ì œë¡œ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
          const isAdded = miniMap.hasLayer(polyline);
          console.log(`[Track ë¼ì¸] ë¼ì¸ ${index} ì¶”ê°€ ì‹œë„:`, {
            coordinatesCount: line.coordinates.length,
            firstCoord: line.coordinates[0],
            lastCoord: line.coordinates[line.coordinates.length - 1],
            polylineCreated: !!polyline,
            polylineAddedToMap: isAdded,
            opacity: polyline.options.opacity,
            color: polyline.options.color,
            weight: polyline.options.weight
          });
          
          if (!isAdded) {
            console.error(`[Track ë¼ì¸] âš ï¸ ë¼ì¸ ${index}ê°€ ë¯¸ë‹ˆë§µì— ì¶”ê°€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!`);
          }
          
          // ì²« ë²ˆì§¸ ë¼ì¸ì„ ë©”ì¸ íŠ¸ë™ìœ¼ë¡œ ì„¤ì •
          if (index === 0) {
            window.trackPolyline = polyline;
            polyline.bringToFront();
            
            // z-indexë¥¼ ìµœìƒìœ„ë¡œ ì„¤ì •
            if (polyline._path) {
              polyline._path.style.zIndex = '2000';
            }
            
            console.log('[Track ë¼ì¸] ë©”ì¸ íŠ¸ë™ polyline ì„¤ì • ì™„ë£Œ', {
              polyline: !!polyline,
              onMap: miniMap.hasLayer(polyline),
              zIndex: polyline._path ? polyline._path.style.zIndex : 'N/A'
            });
            
            // Track ì„ ë¶„ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            polyline.on('click', function(e) {
              const clickedLatLng = e.latlng;
              let closestIndex = 0;
              let minDistance = Infinity;
              
              if (points && points.length > 0) {
                points.forEach((pt, idx) => {
                  const distance = clickedLatLng.distanceTo([pt.lat, pt.lon]);
                  if (distance < minDistance) {
                    minDistance = distance;
                    closestIndex = idx;
                  }
                });
                
                showImage(closestIndex);
              }
            });
          }
        } catch (e) {
          console.error(`[Track ë¼ì¸] ë¼ì¸ ${index} ì¶”ê°€ ì‹¤íŒ¨:`, e);
        }
      });
      
      console.log(`[Track ë¼ì¸] âœ… ë¡œë“œ ì™„ë£Œ: ${data.lines.length}ê°œ ë¼ì¸ì´ ë¯¸ë‹ˆë§µì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      console.log(`[Track ë¼ì¸] ë¯¸ë‹ˆë§µ ë ˆì´ì–´ í™•ì¸:`, {
        trackPolylineExists: !!window.trackPolyline,
        trackPolylineOnMap: window.trackPolyline ? miniMap.hasLayer(window.trackPolyline) : false,
        miniMapLayers: miniMap._layers ? Object.keys(miniMap._layers).length : 0
      });
    } else {
      if (data.count === 0) {
        console.warn(`[Track ë¼ì¸] âš ï¸ ë¼ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„°ì…‹: ${datasetName})`);
        if (data.error) {
          console.warn(`[Track ë¼ì¸] ìƒì„¸ ì˜¤ë¥˜: ${data.error}`);
        }
        if (data.warning) {
          console.warn(`[Track ë¼ì¸] ê²½ê³ : ${data.warning}`);
        }
      } else {
        console.warn(`[Track ë¼ì¸] âš ï¸ ì„±ê³µí–ˆì§€ë§Œ ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„°ì…‹: ${datasetName}, count: ${data.count})`);
      }
    }
  } catch (error) {
    // ë¡œë”© í”Œë˜ê·¸ í•´ì œ
    window._trackLineLoading = null;
    
    if (error.name === 'AbortError') {
      console.warn('[Track ë¼ì¸] ìš”ì²­ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      console.error('[Track ë¼ì¸] ë¡œë“œ ì˜¤ë¥˜:', error);
    }
  }
}

// ë§ˆìš°ìŠ¤ íœ  ì¤Œ
document.getElementById('viewerContainer').addEventListener('wheel', function(e) {
  if (marzipanoScenes[currentIndex] && marzipanoScenes[currentIndex].view) {
    e.preventDefault();
    const view = marzipanoScenes[currentIndex].view;
    const currentFov = view.fov();
    const zoomFactor = e.deltaY > 0 ? 1.1 : 0.9;
    let newFov = currentFov * zoomFactor;
    const initialFov = marzipanoScenes[currentIndex].initialFov;
    if (initialFov) newFov = Math.min(Math.max(newFov, 0.01), initialFov);
    view.setFov(newFov);
  }
}, { passive: false });

// ë©”ë‰´ í•¸ë“¤ëŸ¬
document.addEventListener('DOMContentLoaded', function() {
  // console.log('DOMContentLoaded ì‹¤í–‰ë¨');
  
  // Marzipano ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸ (ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  í™•ì¸)
  setTimeout(function() {
    if (typeof Marzipano === 'undefined') {
      console.error('Marzipano ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      alert('Marzipano ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨: í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // Marzipanoê°€ ë¡œë“œëœ í›„ ì´ˆê¸°í™”
    initializeApp();
  }, 100);
});

function initializeApp() {
  
  const loadDatasetBtn = document.getElementById('loadDatasetBtn');
  const setDataPathBtn = document.getElementById('setDataPathBtn');
  const menuFileBtn = document.getElementById('menuFileBtn');
  const menuOptionBtn = document.getElementById('menuOptionBtn');
  const menuFileMenu = document.getElementById('menuFileMenu');
  const menuOptionMenu = document.getElementById('menuOptionMenu');
  
  // console.log('loadDatasetBtn:', loadDatasetBtn);
  // console.log('setDataPathBtn:', setDataPathBtn);
  
  // ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥
  function toggleMenu(menuElement, otherMenuElement, buttonElement) {
    // console.log('toggleMenu í˜¸ì¶œë¨:', {
    //   menuElement: menuElement,
    //   otherMenuElement: otherMenuElement,
    //   buttonElement: buttonElement,
    //   hasActive: menuElement.classList.contains('active')
    // });
    
    if (menuElement.classList.contains('active')) {
      // console.log('ë©”ë‰´ ë‹«ê¸°');
      menuElement.classList.remove('active');
    } else {
      // console.log('ë©”ë‰´ ì—´ê¸°');
      // ë‹¤ë¥¸ ë©”ë‰´ ë‹«ê¸°
      otherMenuElement.classList.remove('active');
      // ë©”ë‰´ ìœ„ì¹˜ ì„¤ì •
      if (buttonElement) {
        menuElement.style.left = buttonElement.offsetLeft + 'px';
      }
      // í˜„ì¬ ë©”ë‰´ ì—´ê¸°
      menuElement.classList.add('active');
      // console.log('ë©”ë‰´ì— active í´ë˜ìŠ¤ ì¶”ê°€ë¨:', menuElement.classList.contains('active'));
    }
  }
  
  // íŒŒì¼ ë©”ë‰´ í† ê¸€ (ë©”ë‰´ê°€ ìˆì„ ë•Œë§Œ)
  if (menuFileBtn && menuFileMenu) {
    // console.log('íŒŒì¼ ë©”ë‰´ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ë¨');
    menuFileBtn.addEventListener('click', function(e) {
      // console.log('íŒŒì¼ ë©”ë‰´ í´ë¦­ë¨');
      e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
      toggleMenu(menuFileMenu, menuOptionMenu, menuFileBtn);
    });
  }
  // hide_menu ëª¨ë“œì—ì„œëŠ” ë©”ë‰´ ìš”ì†Œê°€ ì—†ìœ¼ë¯€ë¡œ ì¡°ìš©íˆ ë¬´ì‹œ
  
  // ì˜µì…˜ ë©”ë‰´ í† ê¸€ (ë©”ë‰´ê°€ ìˆì„ ë•Œë§Œ)
  if (menuOptionBtn && menuOptionMenu) {
    // console.log('ì˜µì…˜ ë©”ë‰´ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ë¨');
    menuOptionBtn.addEventListener('click', function(e) {
      // console.log('ì˜µì…˜ ë©”ë‰´ í´ë¦­ë¨');
      e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
      toggleMenu(menuOptionMenu, menuFileMenu, menuOptionBtn);
    });
  }
  // hide_menu ëª¨ë“œì—ì„œëŠ” ë©”ë‰´ ìš”ì†Œê°€ ì—†ìœ¼ë¯€ë¡œ ì¡°ìš©íˆ ë¬´ì‹œ
  
  // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ëª¨ë“  ë©”ë‰´ ë‹«ê¸° (ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€)
  document.addEventListener('click', function(e) {
    // ë©”ë‰´ ë²„íŠ¼ì´ë‚˜ ë©”ë‰´ í•­ëª©ì„ í´ë¦­í•œ ê²½ìš°ëŠ” ë¬´ì‹œ
    if (e.target.closest('.menu-item') || e.target.closest('.dropdown-menu')) {
      return;
    }
    
    // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ëª¨ë“  ë©”ë‰´ ë‹«ê¸°
    if (menuFileMenu) menuFileMenu.classList.remove('active');
    if (menuOptionMenu) menuOptionMenu.classList.remove('active');
  });
  
  if (loadDatasetBtn && menuFileMenu) {
    loadDatasetBtn.addEventListener('click', function() {
      // ë©”ë‰´ ë‹«ê¸°
      if (menuFileMenu) menuFileMenu.classList.remove('active');
      showDatasetSelectionModal();
    });
    // console.log('ë°ì´í„°ì…‹ ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ë¨');
  }
  
  if (setDataPathBtn && menuFileMenu) {
    setDataPathBtn.addEventListener('click', function() {
      // ë©”ë‰´ ë‹«ê¸°
      if (menuFileMenu) menuFileMenu.classList.remove('active');
      openFolderSettingsModal();
    });
    // console.log('ë°ì´í„° ê²½ë¡œ ì§€ì • ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ë¨');
  }
  
  // í´ë” ì„¤ì • ê´€ë ¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  document.getElementById('saveFolderSettingsBtn').addEventListener('click', saveFolderSettings);
  document.getElementById('cancelFolderSettingsBtn').addEventListener('click', closeFolderSettingsModal);
  document.getElementById('folderSettingsModal').addEventListener('click', function(e) {
    if (e.target === this) closeFolderSettingsModal();
  });

  // íƒìƒ‰ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  document.getElementById('browseImgFolderBtn').addEventListener('click', () => openFolderBrowser('imgFolderInput'));
  document.getElementById('browseTrackFolderBtn').addEventListener('click', () => openFolderBrowser('trackFolderInput'));
  document.getElementById('browsePointFolderBtn').addEventListener('click', () => openFolderBrowser('pointFolderInput'));
  document.getElementById('browseMatchFolderBtn').addEventListener('click', () => openFolderBrowser('matchFolderInput'));
  const browseTileBtn = document.getElementById('browseTileFolderBtn');
  if (browseTileBtn) {
    browseTileBtn.addEventListener('click', () => openFolderBrowser('tileFolderInput'));
  }

  // ê²½ë¡œ íƒ€ì… ì„ íƒ ëª¨ë‹¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  document.getElementById('selectGpxPathBtn').addEventListener('click', () => {
    closePathTypeSelectionModal();
    openIndividualPathModal('gpx');
  });
  document.getElementById('selectImgPathBtn').addEventListener('click', () => {
    closePathTypeSelectionModal();
    openIndividualPathModal('img');
  });
  document.getElementById('selectCsvPathBtn').addEventListener('click', () => {
    closePathTypeSelectionModal();
    openIndividualPathModal('csv');
  });
  document.getElementById('cancelPathTypeBtn').addEventListener('click', closePathTypeSelectionModal);
  document.getElementById('pathTypeSelectionModal').addEventListener('click', function(e) {
    if (e.target === this) closePathTypeSelectionModal();
  });

  // ê°œë³„ ê²½ë¡œ ì„¤ì • ê´€ë ¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  document.getElementById('saveIndividualPathBtn').addEventListener('click', saveIndividualPath);
  document.getElementById('cancelIndividualPathBtn').addEventListener('click', closeIndividualPathModal);
  document.getElementById('browsePathBtn').addEventListener('click', openPathBrowser);
  document.getElementById('individualPathModal').addEventListener('click', function(e) {
    if (e.target === this) closeIndividualPathModal();
  });

  // ê²½ë¡œ ì…ë ¥ ë„ìš°ë¯¸ ëª¨ë‹¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  document.getElementById('applyPathHelperBtn').addEventListener('click', applyPathFromHelper);
  document.getElementById('cancelPathHelperBtn').addEventListener('click', closePathHelper);
  document.getElementById('openFileDialogBtn').addEventListener('click', openFileDialog);
  document.getElementById('copyFromRelativeBtn').addEventListener('click', copyFromRelativeToAbsolute);
  document.getElementById('pathHelperModal').addEventListener('click', function(e) {
    if (e.target === this) closePathHelper();
  });

  document.getElementById('loadSelectedDatasetBtn').addEventListener('click', async () => {
    if (!selectedDatasetNames.size) {
      alert('ë°ì´í„°ì…‹ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // íƒ€ì¼ë§ ì‚¬ìš© ì—¬ë¶€ í™•ì¸ íŒì—…
    const useTiles = confirm('íƒ€ì¼ë§ìœ¼ë¡œ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸: íƒ€ì¼ë§ëœ ì´ë¯¸ì§€ ì‚¬ìš©\nì·¨ì†Œ: ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©');
    
    // loadDatasets í•¨ìˆ˜ ì‚¬ìš© (ì¼ê´€ì„± ìœ ì§€)
    const success = await loadDatasets(Array.from(selectedDatasetNames), useTiles);
    if (success) {
      document.getElementById('datasetSelectionModal').style.display = 'none';
      alert(`ë¡œë“œ ì™„ë£Œ: ${Array.from(selectedDatasetNames).join(', ')} (ì´ ${points.length} í¬ì¸íŠ¸)`);
    }
  });

  document.getElementById('cancelDatasetBtn').addEventListener('click', () => {
    document.getElementById('datasetSelectionModal').style.display = 'none';
  });

  // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì œê±°ë¨

  detectAvailableDatasets().then(datasets => {
    if (datasets.length > 0) console.log(`${datasets.length}ê°œì˜ ë°ì´í„°ì…‹ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    else console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ë°ì´í„°ì…‹ì´ ì—†ìŠµë‹ˆë‹¤.');
  });

  // íŠ¹ì • ë…¸ë“œë¡œ ì ‘ê·¼í–ˆì„ ë•Œ í•´ë‹¹ ì´ë¯¸ì§€ í‘œì‹œ (head ë‚´ JSON ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì½ê¸°)
  const tnScript = document.getElementById('targetNodeInfo');
  let TARGET_NODE_INFO = null;
  try {
    if (tnScript && tnScript.textContent) {
      TARGET_NODE_INFO = JSON.parse(tnScript.textContent);
    }
    // console.log(TARGET_NODE_INFO);
  } catch (e) { console.warn('targetNodeInfo íŒŒì‹± ì‹¤íŒ¨:', e); }
  if (TARGET_NODE_INFO) {
    // console.log('íŠ¹ì • ë…¸ë“œë¡œ ì ‘ê·¼:', TARGET_NODE_INFO.track_seg_point_id);
    window.targetNodeInfo = TARGET_NODE_INFO;

    const showTargetNode = () => {
      if (points.length > 0 && window.targetNodeInfo && window.targetNodeInfo.target_index < points.length) {
        // console.log('íƒ€ê²Ÿ ë…¸ë“œ í‘œì‹œ:', window.targetNodeInfo.target_index);
        showImage(window.targetNodeInfo.target_index);

        // ë³´ì•ˆ ìš”êµ¬ë¡œ ì£¼ì†Œì°½ì€ ë£¨íŠ¸('/')ë§Œ ë³´ì´ë„ë¡ ìœ ì§€
        // console.log('ë™ì  ë…¸ë“œ ì ‘ê·¼ ì¤‘ì´ì§€ë§Œ ì£¼ì†Œì°½ì€ ë£¨íŠ¸ë¡œ ìœ ì§€');

        const PREFIX = (window.SCRIPT_ROOT || '');
        history.replaceState({ idx: window.targetNodeInfo.target_index, id: window.targetNodeInfo.track_seg_point_id }, '', PREFIX + '/');

        document.title = '360Â° íŒŒë…¸ë¼ë§ˆ ë§µë·°ì–´';

        if (typeof miniMap !== 'undefined' && miniMap) {
          setTimeout(() => {
            highlight(window.targetNodeInfo.target_index, points[window.targetNodeInfo.target_index].angle || 0);
          }, 500);
        }

        window.targetNodeInfo = null;
      }
    };

    registerAfterDatasetLoaded(() => {
      if (window.targetNodeInfo) setTimeout(showTargetNode, 500);
    });
  }

  // ì¿ í‚¤ì—ì„œ target_node_id ì½ì–´ì„œ í•´ë‹¹ ë…¸ë“œë¡œ ì´ë™
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  const targetNodeIdFromCookie = getCookie('target_node_id');
  if (targetNodeIdFromCookie) {
    console.log('ì¿ í‚¤ì—ì„œ target_node_id ë°œê²¬:', targetNodeIdFromCookie);
    
    // íƒ€ê²Ÿ ë…¸ë“œë¥¼ ì°¾ì•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” í”Œë˜ê·¸
    window._hasPendingTargetNode = true;
    
    const moveToTargetNode = () => {
      if (Array.isArray(points) && points.length > 0) {
        console.log('í¬ì¸íŠ¸ ë°ì´í„° ë¡œë“œë¨, ì´', points.length, 'ê°œ');
        console.log('ì²« 5ê°œ í¬ì¸íŠ¸ì˜ track_seg_point_id:', points.slice(0, 5).map(p => p.track_seg_point_id));
        
        const targetIndex = points.findIndex(p => 
          String(p.track_seg_point_id || '').trim() === String(targetNodeIdFromCookie).trim()
        );
        
        console.log('íƒ€ê²Ÿ ë…¸ë“œ ê²€ìƒ‰ ê²°ê³¼:', targetIndex);
        
        if (targetIndex >= 0) {
          console.log('íƒ€ê²Ÿ ë…¸ë“œë¡œ ì´ë™:', targetIndex, targetNodeIdFromCookie);
          showImage(targetIndex);
          
          // ì¿ í‚¤ ì‚­ì œ (ì¼íšŒì„± ì‚¬ìš©)
          document.cookie = 'target_node_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          window._hasPendingTargetNode = false;
        } else {
          console.warn('íƒ€ê²Ÿ ë…¸ë“œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', targetNodeIdFromCookie);
          console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ë…¸ë“œ IDë“¤ (ì²« 10ê°œ):', points.slice(0, 10).map(p => p.track_seg_point_id));
          // ì¿ í‚¤ ì‚­ì œ
          document.cookie = 'target_node_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          // íƒ€ê²Ÿì„ ì°¾ì§€ ëª»í–ˆì–´ë„ í”Œë˜ê·¸ë¥¼ falseë¡œ ì„¤ì •í•˜ì—¬ 0ë²ˆ í‘œì‹œ ë°©ì§€
          window._hasPendingTargetNode = false;
        }
      } else {
        console.log('í¬ì¸íŠ¸ ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }
    };

    // ë°ì´í„°ì…‹ì´ ë¡œë“œëœ í›„ ì‹¤í–‰
    registerAfterDatasetLoaded(() => {
      console.log('ë°ì´í„°ì…‹ ë¡œë“œ ì™„ë£Œ, íƒ€ê²Ÿ ë…¸ë“œë¡œ ì´ë™ ì‹œë„');
      setTimeout(moveToTargetNode, 100);
    });
  } else {
    console.log('ì¿ í‚¤ì—ì„œ target_node_idë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    console.log('í˜„ì¬ ì¿ í‚¤:', document.cookie);
  }

  // ë°ì´í„°ì…‹ ë¡œë“œ í›„ ì½œë°± ë“±ë¡/ì‹¤í–‰ ìœ í‹¸
  window.__afterDatasetLoadedCallbacks = Array.isArray(window.__afterDatasetLoadedCallbacks)
    ? window.__afterDatasetLoadedCallbacks
    : [];
  function registerAfterDatasetLoaded(cb) {
    if (typeof cb !== 'function') return;
    if (!Array.isArray(window.__afterDatasetLoadedCallbacks)) {
      window.__afterDatasetLoadedCallbacks = [];
    }
    window.__afterDatasetLoadedCallbacks.push(cb);
  }
  if (!window.__loadDatasetWrappedOnce) {
    window.__loadDatasetWrappedOnce = true;
    const __origLoadDataset = window.loadDataset;
    window.loadDataset = async function(datasetNames) {
      const result = await __origLoadDataset(datasetNames);
      setTimeout(() => {
        try {
          (window.__afterDatasetLoadedCallbacks || []).forEach(cb => {
            try { cb(); } catch (e) { console.error(e); }
          });
        } catch(e) { console.error(e); }
      }, 0);
      return result;
    };
  }

  // postMessage ìˆ˜ì‹  (ë¶€ëª¨ê°€ ë³´ëƒ„)
  window.addEventListener('message', (evt) => {
    const data = evt.data || {};
    if (data.type === 'GOTO_NODE' && data.payload) {
      gotoNodeByInfo(data.payload);
    }

    if (data.type === 'CLOSE_VIEWER') {
      try {
        const info = window.__currentNodeInfo || null;
        // ë¶€ëª¨ë¡œ ë…¸ì„ ì •ë³´ ì‘ë‹µ ë³´ë‚´ê¸°
        window.parent.postMessage({ type: 'RETURN_ID', payload: info}, '*');
      } catch (err) {
        console.error('return-id ìš”ì²­ ì‹¤íŒ¨', err);
        window.parent.postMessage({ type: 'RETURN_ID', payload: null}, '*');
      }
    }
  });

  // ê° ë…¸ë“œì˜ URL ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
  function displayNodeUrls() {
    if (points.length === 0) return;
    
    // console.log('=== ê° ë…¸ë“œì˜ ê°œë³„ URL ===');
    points.forEach((point, index) => {
      const imageFilename = point.image_filename || '';
      const trackSegPointId = (point.track_seg_point_id || '').toString().trim() || `node_${index}`;
      const nodeUrl = `${location.origin}/${encodeURIComponent(trackSegPointId)}`;
      // console.log(`ë…¸ë“œ ${index}: ${nodeUrl} (${imageFilename})`);
    });
  }

  // ë°ì´í„° ë¡œë“œ í›„ URL ì •ë³´ í‘œì‹œ ë“±ë¡
  registerAfterDatasetLoaded(() => setTimeout(displayNodeUrls, 500));

  // ë…¸ë“œ URL ëª©ë¡ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
  function showNodeUrlsModal() {
    if (points.length === 0) {
      alert('ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ì…‹ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.');
      return;
    }

    const modal = document.getElementById('nodeUrlsModal');
    const content = document.getElementById('nodeUrlsContent');
    
    let html = '<div style="font-family: monospace; font-size: 0.9em;">';
    html += '<div style="margin-bottom: 10px; padding: 8px; background: #f5f5f5; border-radius: 4px; font-weight: bold;">ê° ë…¸ë“œì˜ ê°œë³„ URL ëª©ë¡</div>';
    
    points.forEach((point, index) => {
      const imageFilename = point.image_filename || '';
      const trackSegPointId = (point.track_seg_point_id || '').toString().trim() || `node_${index}`;
      const nodeUrl = `${location.origin}/${encodeURIComponent(trackSegPointId)}`;
      
      html += `<div style="margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">`;
      html += `<div style="font-weight: bold; color: #1976d2;">ë…¸ë“œ ${index}</div>`;
      html += `<div style="margin: 4px 0; word-break: break-all;">`;
      html += `<a href="${nodeUrl}" target="_blank" style="color: #1976d2; text-decoration: none;">${nodeUrl}</a>`;
      html += `</div>`;
      html += `<div style="font-size: 0.8em; color: #666;">íŒŒì¼: ${imageFilename || 'N/A'}</div>`;
      html += `<div style="font-size: 0.8em; color: #666;">ì¢Œí‘œ: ${point.lat?.toFixed(6) || 'N/A'}, ${point.lon?.toFixed(6) || 'N/A'}</div>`;
      html += `</div>`;
    });
    
    html += '</div>';
    content.innerHTML = html;
    modal.style.display = 'flex';
  }

  // ë…¸ë“œ URL ëª¨ë‹¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  const showNodeUrlsBtnEl = document.getElementById('showNodeUrlsBtn');
  if (showNodeUrlsBtnEl) showNodeUrlsBtnEl.addEventListener('click', showNodeUrlsModal);
  document.getElementById('closeNodeUrlsModal').addEventListener('click', function() {
    document.getElementById('nodeUrlsModal').style.display = 'none';
  });

  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  document.getElementById('nodeUrlsModal').addEventListener('click', function(e) {
    if (e.target === this) {
      this.style.display = 'none';
    }
  });
}
</script>
</body>
</html>

